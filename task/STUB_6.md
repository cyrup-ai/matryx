# STUB_6: Error Source Chain Implementation

## OBJECTIVE

Implement proper error chaining for `CanonicalJsonError` to enable better debugging and error tracing. Currently, the error source chain is not implemented (the `source()` method returns `None`), degrading the ability to trace error origins through the application stack. Additionally, the `SerializationError` variant converts `serde_json::Error` to a `String`, losing the original error information.

## SEVERITY

**OBSERVABILITY ISSUE** - Impacts debugging and production error diagnostics

## LOCATION

**Primary File:** [`packages/server/src/utils/canonical_json_errors.rs`](../packages/server/src/utils/canonical_json_errors.rs)

**Related File:** [`packages/server/src/utils/canonical_json.rs`](../packages/server/src/utils/canonical_json.rs) (uses CanonicalJsonError)

## CURRENT IMPLEMENTATION ANALYSIS

### Current Error Definition

```rust
#[derive(Debug, Clone, PartialEq)]
pub enum CanonicalJsonError {
    InvalidJson(String),
    SerializationError(String),  // ❌ Loses original error!
    MemoryExhausted,
    RecursiveStructure,
}
```

### Current Stub Code (Line 43)

```rust
impl std::error::Error for CanonicalJsonError {
    fn source(&self) -> Option<&(dyn std::error::Error + 'static)> {
        // For now, these errors don't wrap other errors
        // Could be extended in the future if needed
        None  // ❌ Always returns None
    }
}
```

### Current From Implementation (Line 50)

```rust
impl From<serde_json::Error> for CanonicalJsonError {
    fn from(err: serde_json::Error) -> Self {
        CanonicalJsonError::SerializationError(err.to_string())  // ❌ Converts to String!
    }
}
```

### Problem Identified

When `serde_json::Error` occurs (e.g., in [`canonical_json.rs:19`](../packages/server/src/utils/canonical_json.rs#L19)), the error is converted to a `String` via `err.to_string()`, completely losing:
- The original error object
- Stack trace information
- Error source chain
- Detailed error context

## RESEARCH FINDINGS

### Dependency Check

✅ **`thiserror = "2.0.17"` is already in [`packages/server/Cargo.toml`](../packages/server/Cargo.toml)**

No new dependencies needed!

### Clone/PartialEq Analysis

**Finding:** `CanonicalJsonError` is **NOT** cloned or compared anywhere in production code.

- Searched entire `packages/server/src` for `.clone()` on CanonicalJsonError: **0 matches**
- Searched for equality comparisons (`==`): **0 matches**
- Only usage is in test [`test_error_clone_and_equality`](../packages/server/src/utils/canonical_json_errors.rs#L83)

**Conclusion:** `Clone` and `PartialEq` can be safely removed without breaking production code.

**Why this matters:** `serde_json::Error` does **NOT** implement `Clone` or `PartialEq`, so we cannot store it if we keep these derives.

## IMPLEMENTATION PLAN

### Step 1: Update Error Enum with thiserror

**File:** `packages/server/src/utils/canonical_json_errors.rs`

**Add import at top:**
```rust
use thiserror::Error;
```

**Replace lines 7-16 with:**
```rust
#[derive(Error, Debug)]
pub enum CanonicalJsonError {
    /// Invalid JSON structure provided to canonicalization
    #[error("Invalid JSON structure: {0}")]
    InvalidJson(String),
    
    /// Serialization failed during JSON canonicalization process
    #[error("JSON serialization failed")]
    SerializationError(#[from] serde_json::Error),
    
    /// Memory exhaustion during large object processing
    #[error("Memory exhausted during canonicalization of large JSON structure")]
    MemoryExhausted,
    
    /// Recursive structure detected (circular references)
    #[error("Recursive JSON structure detected - cannot canonicalize circular references")]
    RecursiveStructure,
}
```

### Step 2: Remove Manual Implementations

**DELETE** the following blocks (they're auto-generated by thiserror):

1. **Delete `impl fmt::Display` (lines 19-39)** - thiserror generates this via `#[error]` attributes
2. **Delete `impl std::error::Error` (lines 41-47)** - thiserror generates this via `#[derive(Error)]`
3. **Delete `impl From<serde_json::Error>` (lines 50-54)** - thiserror generates this via `#[from]`

### Step 3: Update Test (Line 83-87)

**Change:**
```rust
#[test]
fn test_error_clone_and_equality() {
    let error1 = CanonicalJsonError::InvalidJson("test".to_string());
    let error2 = error1.clone();
    assert_eq!(error1, error2);
}
```

**To:**
```rust
#[test]
fn test_error_debug() {
    let error = CanonicalJsonError::InvalidJson("test".to_string());
    let debug_str = format!("{:?}", error);
    assert!(debug_str.contains("InvalidJson"));
    assert!(debug_str.contains("test"));
}
```

**Rationale:** Errors don't need to be cloneable or comparable. We test Debug formatting instead.

## HOW THISERROR WORKS

### The `#[derive(Error)]` Macro

Automatically implements:
- `std::error::Error` trait
- Proper `source()` method returning error sources
- Integration with Rust error handling ecosystem

### The `#[error("...")]` Attribute

Automatically implements `Display` trait with custom messages.

### The `#[from]` Attribute

On a variant like `SerializationError(#[from] serde_json::Error)`:
1. **Generates `From<serde_json::Error>`** implementation
2. **Stores the actual error** (not a String!)
3. **Auto-implements `source()`** to return `Some(&serde_json_error)`

### Before vs After Error Chain

**Before (current):**
```rust
CanonicalJsonError::SerializationError("expected value at line 1 column 1")
  └─ source() = None  ❌
```

**After (with this fix):**
```rust
CanonicalJsonError::SerializationError(serde_json::Error { ... })
  └─ source() = Some(serde_json::Error { ... })  ✅
```

## CODE CHANGES REQUIRED

### File: `packages/server/src/utils/canonical_json_errors.rs`

**Changes:**
1. Line 1: Add `use thiserror::Error;`
2. Line 7: Change `#[derive(Debug, Clone, PartialEq)]` to `#[derive(Error, Debug)]`
3. Lines 8-16: Add `#[error("...")]` attributes and change `SerializationError(String)` to `SerializationError(#[from] serde_json::Error)`
4. Lines 19-39: **DELETE** entire `impl fmt::Display` block
5. Lines 41-47: **DELETE** entire `impl std::error::Error` block
6. Lines 50-54: **DELETE** entire `impl From<serde_json::Error>` block
7. Lines 83-87: Update `test_error_clone_and_equality` test

### File: `packages/server/src/utils/canonical_json.rs`

**Changes:** NONE required! All error construction sites remain compatible:
- Line 19: `serde_json::to_string(&canonical_value)?` - works via auto-generated `From`
- Line 99: `Err(CanonicalJsonError::InvalidJson(...))` - unchanged
- Various: `Err(CanonicalJsonError::RecursiveStructure)` - unchanged
- Various: `Err(CanonicalJsonError::MemoryExhausted)` - unchanged

## COMPLETE NEW FILE STRUCTURE

After changes, `canonical_json_errors.rs` will be approximately **75 lines** (down from 102), with structure:

```rust
use std::fmt;
use thiserror::Error;

#[derive(Error, Debug)]
pub enum CanonicalJsonError { ... }

#[cfg(test)]
mod tests { ... }
```

All implementations (Display, Error, From) are auto-generated by thiserror.

## DEFINITION OF DONE

- [ ] `use thiserror::Error;` added to imports
- [ ] Enum derives changed from `Debug, Clone, PartialEq` to `Error, Debug`
- [ ] `#[error("...")]` attributes added to all variants
- [ ] `SerializationError(String)` changed to `SerializationError(#[from] serde_json::Error)`
- [ ] Manual `impl fmt::Display` block removed
- [ ] Manual `impl std::error::Error` block removed  
- [ ] Manual `impl From<serde_json::Error>` block removed
- [ ] `test_error_clone_and_equality` updated to `test_error_debug`
- [ ] Code compiles without errors: `cargo build -p matryx_server`
- [ ] Existing tests pass: `cargo test -p matryx_server canonical_json`
- [ ] Error source chain now functional (source() returns Some for SerializationError)

## WHY THIS MATTERS FOR MATRIX HOMESERVER

### Debugging Federation Issues

When federation signing fails due to canonical JSON errors, operators need to see:
- **Root cause**: "invalid UTF-8 in JSON at position 1234"
- **Context**: "JSON serialization failed"
- **Location**: Which federation request caused it

With proper error chaining, logging frameworks can display the complete chain:
```
ERROR: Failed to sign federation request
  Caused by: JSON serialization failed
  Caused by: invalid UTF-8 sequence at line 5 column 23
```

### Production Monitoring

Error monitoring tools (Sentry, Datadog, etc.) rely on error source chains to:
- Group related errors
- Identify root causes
- Generate actionable alerts

### Matrix Context

Canonical JSON is critical for:
- **Event signing** ([Matrix Spec](https://spec.matrix.org/v1.11/appendices/#canonical-json))
- **Event ID calculation** 
- **Federation request/response signing**
- **Server key verification**

Errors in this layer indicate serious issues like:
- Malformed events from federation partners
- Signing key problems
- Invalid event structures
- Protocol violations

Proper error diagnostics help distinguish between:
- Local bugs (our serialization is wrong)
- Remote bugs (other server sent bad data)
- Protocol violations (Matrix spec compliance)

## SCOPE BOUNDARIES

This task focuses **exclusively** on `CanonicalJsonError` in the utils module.

**Out of scope:**
- Other error types in the codebase
- Error handling in other modules
- Creating new error types
- Changing error propagation patterns

If other error types need similar treatment, they should be handled in separate tasks.

## REFERENCES

### Internal Codebase
- Error definition: [`packages/server/src/utils/canonical_json_errors.rs`](../packages/server/src/utils/canonical_json_errors.rs)
- Error usage: [`packages/server/src/utils/canonical_json.rs`](../packages/server/src/utils/canonical_json.rs)
- Cargo.toml: [`packages/server/Cargo.toml`](../packages/server/Cargo.toml)

### External Resources
- thiserror documentation: https://docs.rs/thiserror/
- Rust Error trait: https://doc.rust-lang.org/std/error/trait.Error.html
- Matrix Canonical JSON spec: https://spec.matrix.org/v1.11/appendices/#canonical-json
