

<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/v1.11/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/v1.11/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/v1.11/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/v1.11/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/v1.11/favicons/android-192x192.png" sizes="192x192">

<title>Server-Server API | Matrix Specification</title>
<meta name="description" content="Matrix homeservers use the Federation APIs (also known as server-server APIs) to communicate with each other. Homeservers use these APIs to push messages to each other in real-time, to retrieve historic messages from each other, and to query profile and presence information about users on each other&amp;rsquo;s servers.
The APIs are implemented using HTTPS requests between each of the servers. These HTTPS requests are strongly authenticated using public key signatures at the TLS transport layer and using public key signatures in HTTP Authorization headers at the HTTP layer.">
<meta property="og:title" content="Server-Server API" />
<meta property="og:description" content="Matrix homeservers use the Federation APIs (also known as server-server APIs) to communicate with each other. Homeservers use these APIs to push messages to each other in real-time, to retrieve historic messages from each other, and to query profile and presence information about users on each other&rsquo;s servers.
The APIs are implemented using HTTPS requests between each of the servers. These HTTPS requests are strongly authenticated using public key signatures at the TLS transport layer and using public key signatures in HTTP Authorization headers at the HTTP layer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/v1.11/server-server-api/" /><meta property="article:section" content="" />


<meta itemprop="name" content="Server-Server API">
<meta itemprop="description" content="Matrix homeservers use the Federation APIs (also known as server-server APIs) to communicate with each other. Homeservers use these APIs to push messages to each other in real-time, to retrieve historic messages from each other, and to query profile and presence information about users on each other&rsquo;s servers.
The APIs are implemented using HTTPS requests between each of the servers. These HTTPS requests are strongly authenticated using public key signatures at the TLS transport layer and using public key signatures in HTTP Authorization headers at the HTTP layer.">

<meta itemprop="wordCount" content="23980">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Server-Server API"/>
<meta name="twitter:description" content="Matrix homeservers use the Federation APIs (also known as server-server APIs) to communicate with each other. Homeservers use these APIs to push messages to each other in real-time, to retrieve historic messages from each other, and to query profile and presence information about users on each other&rsquo;s servers.
The APIs are implemented using HTTPS requests between each of the servers. These HTTPS requests are strongly authenticated using public key signatures at the TLS transport layer and using public key signatures in HTTP Authorization headers at the HTTP layer."/>




<link rel="preload" href="/v1.11/scss/main.min.caadd78615b351618b7d983a6d3e8c57a80c880e4f81e8dcd803fab185b58cd7.css" as="style">
<link href="/v1.11/scss/main.min.caadd78615b351618b7d983a6d3e8c57a80c880e4f81e8dcd803fab185b58cd7.css" rel="stylesheet" integrity="">

<script
  src="/v1.11/js/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>



<link rel="preload" href="/v1.11/css/fonts/Inter.css" as="style">
<link rel="stylesheet" href="/v1.11/css/fonts/Inter.css">

  </head>
  <body class="td-page">
    <header>


<nav class="td-navbar navbar-light js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/v1.11/"><span class="navbar-brand__logo navbar-logo"><svg width="75" height="32" xmlns="http://www.w3.org/2000/svg"><g fill="#000" fill-rule="nonzero"><path d="M.936.732V31.25H3.13v.732H.095V0h3.034v.732zm8.45 9.675v1.544h.044a4.461 4.461.0 011.487-1.368c.58-.323 1.245-.485 1.993-.485.72.0 1.377.14 1.972.42.595.279 1.047.771 1.355 1.477.338-.5.796-.941 1.377-1.323.58-.383 1.266-.574 2.06-.574.602.0 1.16.074 1.674.22.514.148.954.383 1.322.707.366.323.653.746.859 1.268.205.522.308 1.15.308 1.887v7.633H20.71v-6.464c0-.383-.015-.743-.044-1.082a2.305 2.305.0 00-.242-.882 1.473 1.473.0 00-.584-.596c-.257-.146-.606-.22-1.047-.22-.44.0-.796.085-1.068.253-.272.17-.485.39-.639.662a2.654 2.654.0 00-.308.927 7.074 7.074.0 00-.078 1.048v6.354h-3.128v-6.398c0-.338-.007-.673-.021-1.004a2.825 2.825.0 00-.188-.916 1.411 1.411.0 00-.55-.673c-.258-.168-.636-.253-1.135-.253a2.33 2.33.0 00-.584.1 1.94 1.94.0 00-.705.374c-.228.184-.422.449-.584.794-.161.346-.242.798-.242 1.357v6.619H6.434V10.407h2.952zm16.456 1.677a3.751 3.751.0 011.233-1.17 5.37 5.37.0 011.685-.629 9.579 9.579.0 011.884-.187c.573.0 1.153.04 1.74.121.588.081 1.124.24 1.609.475.484.235.88.562 1.19.981.308.42.462.975.462 1.666v5.934c0 .516.03 1.008.088 1.478.058.471.161.824.308 1.06H32.87a4.435 4.435.0 01-.22-1.104c-.5.515-1.087.876-1.762 1.081a7.084 7.084.0 01-2.071.31c-.544.0-1.05-.067-1.52-.2a3.472 3.472.0 01-1.234-.617 2.87 2.87.0 01-.826-1.059c-.199-.426-.298-.934-.298-1.522.0-.647.114-1.18.342-1.6.227-.419.52-.753.881-1.004.36-.25.771-.437 1.234-.562.462-.125.929-.224 1.399-.298.47-.073.932-.132 1.387-.176.456-.044.86-.11 1.212-.199.353-.088.631-.217.837-.386.206-.169.301-.415.287-.74.0-.337-.055-.606-.166-.804a1.217 1.217.0 00-.44-.464 1.737 1.737.0 00-.639-.22 5.292 5.292.0 00-.782-.055c-.617.0-1.101.132-1.454.397-.352.264-.558.706-.617 1.323h-3.128c.044-.735.227-1.345.55-1.83zm6.179 4.423a5.095 5.095.0 01-.639.165 9.68 9.68.0 01-.716.11c-.25.03-.5.067-.749.11a5.616 5.616.0 00-.694.177 2.057 2.057.0 00-.594.298c-.17.125-.305.284-.408.474-.103.192-.154.434-.154.728.0.28.051.515.154.706.103.192.242.342.419.453.176.11.381.187.617.231.234.044.477.066.726.066.617.0 1.094-.102 1.432-.309.338-.205.587-.452.75-.739.16-.286.26-.576.297-.87.036-.295.055-.53.055-.707v-1.17a1.4 1.4.0 01-.496.277zm11.863-6.1v2.096h-2.291v5.647c0 .53.088.883.264 1.059.176.177.529.265 1.057.265.177.0.345-.007.507-.022.161-.015.316-.037.463-.066v2.426a7.49 7.49.0 01-.882.089 21.67 21.67.0 01-.947.022c-.484.0-.944-.034-1.377-.1a3.233 3.233.0 01-1.145-.386 2.04 2.04.0 01-.782-.816c-.191-.353-.287-.816-.287-1.39v-6.728H36.57v-2.096h1.894v-3.42h3.129v3.42h2.29zm4.471.0v2.118h.044a3.907 3.907.0 011.454-1.754 4.213 4.213.0 011.036-.497 3.734 3.734.0 011.145-.176c.206.0.433.037.683.11v2.912a5.862 5.862.0 00-.528-.077 5.566 5.566.0 00-.595-.033c-.573.0-1.058.096-1.454.287a2.52 2.52.0 00-.958.783 3.143 3.143.0 00-.518 1.158 6.32 6.32.0 00-.154 1.434v5.14h-3.128V10.407h2.973zM54.039 8.642V6.06h3.128v2.582H54.04zm3.128 1.765v11.405H54.04V10.407h3.128zm1.63.0h3.569l2.005 2.978 1.982-2.978h3.459l-3.745 5.339 4.208 6.067h-3.57l-2.378-3.596-2.38 3.596h-3.502l4.097-6.001zM74.094 31.25V.732H71.9V0h3.035v31.982H71.9v-.732z"/></g></svg></span><span class="navbar-brand__name">
		specification
    </span><span class="navbar-version"> &mdash; version v1.11</span>
  </a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://matrix.org/foundation/" target="_blank" rel="noopener"><span>Foundation</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://matrix.org/faq" target="_blank" rel="noopener"><span>FAQs</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://matrix.org/blog/posts" target="_blank" rel="noopener"><span>Blog</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">

  </div>
</div>
</nav>



    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-3 td-sidebar d-print-none">


<div id="td-sidebar-menu" class="td-sidebar__inner">
  <div id="content-mobile">
  <form class="td-sidebar__search d-flex align-items-center">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  </div>
  <div id="content-desktop"></div>
  <nav class="td-sidebar-nav collapse td-sidebar-nav--search-disabled" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m--li">
  <a href="/v1.11/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-"><span class="">Matrix Specification</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-client-server-api-li">
  <a href="/v1.11/client-server-api/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-client-server-api"><span class="">Client-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-server-server-api-li">
  <a href="/v1.11/server-server-api/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-server-server-api"><span class="td-sidebar-nav-active-item">Server-Server API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-application-service-api-li">
  <a href="/v1.11/application-service-api/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-application-service-api"><span class="">Application Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-identity-service-api-li">
  <a href="/v1.11/identity-service-api/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-identity-service-api"><span class="">Identity Service API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-push-gateway-api-li">
  <a href="/v1.11/push-gateway-api/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-push-gateway-api"><span class="">Push Gateway API</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-rooms-li">
  <a href="/v1.11/rooms/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-rooms"><span class="">Room Versions</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv1-li">
  <a href="/v1.11/rooms/v1/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv1"><span class="">Room Version 1</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv2-li">
  <a href="/v1.11/rooms/v2/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv2"><span class="">Room Version 2</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv3-li">
  <a href="/v1.11/rooms/v3/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv3"><span class="">Room Version 3</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv4-li">
  <a href="/v1.11/rooms/v4/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv4"><span class="">Room Version 4</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv5-li">
  <a href="/v1.11/rooms/v5/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv5"><span class="">Room Version 5</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv6-li">
  <a href="/v1.11/rooms/v6/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv6"><span class="">Room Version 6</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv7-li">
  <a href="/v1.11/rooms/v7/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv7"><span class="">Room Version 7</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv8-li">
  <a href="/v1.11/rooms/v8/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv8"><span class="">Room Version 8</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv9-li">
  <a href="/v1.11/rooms/v9/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv9"><span class="">Room Version 9</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv10-li">
  <a href="/v1.11/rooms/v10/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv10"><span class="">Room Version 10</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id="m-roomsv11-li">
  <a href="/v1.11/rooms/v11/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-roomsv11"><span class="">Room Version 11</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-proposals-li">
  <a href="/v1.11/proposals/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-proposals"><span class="">Spec Change Proposals</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-appendices-li">
  <a href="/v1.11/appendices/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-appendices"><span class="">Appendices</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-changelog-li">
  <a href="/v1.11/changelog/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-changelog"><span class="">Changelog</span></a>
</li>
  </ul>
</li>
    </ul>


<hr>
    <div id="toc">
        <a id="toc-title" href="#">Server-Server API</a>
        <nav id="TableOfContents">
  <ol>
    <li><a href="#api-standards">API standards</a>
      <ol>
        <li><a href="#tls">TLS</a></li>
        <li><a href="#unsupported-endpoints">Unsupported endpoints</a></li>
      </ol>
    </li>
    <li><a href="#server-discovery">Server discovery</a>
      <ol>
        <li><a href="#resolving-server-names">Resolving server names</a></li>
        <li><a href="#server-implementation">Server implementation</a></li>
        <li><a href="#retrieving-server-keys">Retrieving server keys</a>
          <ol>
            <li><a href="#publishing-keys">Publishing Keys</a></li>
            <li><a href="#querying-keys-through-another-server">Querying Keys Through Another Server</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#authentication">Authentication</a>
      <ol>
        <li><a href="#request-authentication">Request Authentication</a></li>
        <li><a href="#response-authentication">Response Authentication</a></li>
        <li><a href="#client-tls-certificates">Client TLS Certificates</a></li>
      </ol>
    </li>
    <li><a href="#transactions">Transactions</a></li>
    <li><a href="#pdus">PDUs</a>
      <ol>
        <li><a href="#checks-performed-on-receipt-of-a-pdu">Checks performed on receipt of a PDU</a>
          <ol>
            <li><a href="#definitions">Definitions</a></li>
            <li><a href="#authorization-rules">Authorization rules</a>
              <ol>
                <li><a href="#auth-events-selection">Auth events selection</a></li>
              </ol>
            </li>
            <li><a href="#rejection">Rejection</a></li>
            <li><a href="#soft-failure">Soft failure</a></li>
            <li><a href="#retrieving-event-authorization-information">Retrieving event authorization information</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#edus">EDUs</a></li>
    <li><a href="#room-state-resolution">Room State Resolution</a></li>
    <li><a href="#backfilling-and-retrieving-missing-events">Backfilling and retrieving missing events</a></li>
    <li><a href="#retrieving-events">Retrieving events</a></li>
    <li><a href="#joining-rooms">Joining Rooms</a>
      <ol>
        <li><a href="#restricted-rooms">Restricted rooms</a></li>
      </ol>
    </li>
    <li><a href="#knocking-rooms">Knocking upon a room</a></li>
    <li><a href="#inviting-to-a-room">Inviting to a room</a></li>
    <li><a href="#leaving-rooms-rejecting-invites">Leaving Rooms (Rejecting Invites)</a></li>
    <li><a href="#third-party-invites">Third-party invites</a>
      <ol>
        <li><a href="#cases-where-an-association-exists-for-a-third-party-identifier">Cases where an association exists for a third-party identifier</a></li>
        <li><a href="#cases-where-an-association-doesnt-exist-for-a-third-party-identifier">Cases where an association doesn&rsquo;t exist for a third-party identifier</a>
          <ol>
            <li><a href="#verifying-the-invite">Verifying the invite</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#public-room-directory">Public Room Directory</a></li>
    <li><a href="#spaces">Spaces</a></li>
    <li><a href="#typing-notifications">Typing Notifications</a></li>
    <li><a href="#presence">Presence</a></li>
    <li><a href="#receipts">Receipts</a></li>
    <li><a href="#querying-for-information">Querying for information</a></li>
    <li><a href="#openid">OpenID</a></li>
    <li><a href="#device-management">Device Management</a></li>
    <li><a href="#end-to-end-encryption">End-to-End Encryption</a></li>
    <li><a href="#send-to-device-messaging">Send-to-device messaging</a></li>
    <li><a href="#content-repository">Content Repository</a></li>
    <li><a href="#server-access-control-lists-acls">Server Access Control Lists (ACLs)</a></li>
    <li><a href="#signing-events">Signing Events</a>
      <ol>
        <li><a href="#adding-hashes-and-signatures-to-outgoing-events">Adding hashes and signatures to outgoing events</a></li>
        <li><a href="#validating-hashes-and-signatures-on-received-events">Validating hashes and signatures on received events</a></li>
        <li><a href="#calculating-the-reference-hash-for-an-event">Calculating the reference hash for an event</a></li>
        <li><a href="#calculating-the-content-hash-for-an-event">Calculating the content hash for an event</a></li>
        <li><a href="#example-code">Example code</a></li>
      </ol>
    </li>
    <li><a href="#security-considerations">Security considerations</a></li>
  </ol>
</nav>
    </div>

  </nav>
</div>

          </div>
          <main class="col-12 col-md-9 col-xl-7 pl-md-5" role="main">







<div class="pageinfo pageinfo-primary">
  <p>You're looking at an old version of this specification.<p>
  <p><a href="https://spec.matrix.org/latest">Switch to the current stable release</a>.</p>
</div>





<nav aria-label="breadcrumb" class="td-breadcrumbs">
	<ol class="breadcrumb">





<li class="breadcrumb-item" >
	<a href="/v1.11/">Matrix Specification</a>
</li>



<li class="breadcrumb-item active" aria-current="page">
	<a href="/v1.11/server-server-api/">Server-Server API</a>
</li>

	</ol>
</nav	>





<div class="td-content">
	<h1>Server-Server API</h1>
	<p>Matrix homeservers use the Federation APIs (also known as server-server
APIs) to communicate with each other. Homeservers use these APIs to push
messages to each other in real-time, to retrieve historic messages from
each other, and to query profile and presence information about users on
each other&rsquo;s servers.</p>
<p>The APIs are implemented using HTTPS requests between each of the
servers. These HTTPS requests are strongly authenticated using public
key signatures at the TLS transport layer and using public key
signatures in HTTP Authorization headers at the HTTP layer.</p>
<p>There are three main kinds of communication that occur between
homeservers:</p>
<p>Persistent Data Units (PDUs):
These events are broadcast from one homeserver to any others that have
joined the same room (identified by Room ID). They are persisted in
long-term storage and record the history of messages and state for a
room.</p>
<p>Like email, it is the responsibility of the originating server of a PDU
to deliver that event to its recipient servers. However PDUs are signed
using the originating server&rsquo;s private key so that it is possible to
deliver them through third-party servers.</p>
<p>Ephemeral Data Units (EDUs):
These events are pushed between pairs of homeservers. They are not
persisted and are not part of the history of a room, nor does the
receiving homeserver have to reply to them.</p>
<p>Queries:
These are single request/response interactions between a given pair of
servers, initiated by one side sending an HTTPS GET request to obtain
some information, and responded by the other. They are not persisted and
contain no long-term significant history. They simply request a snapshot
state at the instant the query is made.</p>
<p>EDUs and PDUs are further wrapped in an envelope called a Transaction,
which is transferred from the origin to the destination homeserver using
an HTTPS PUT request.</p>
<h2 id="api-standards">API standards</h2>
<p>The mandatory baseline for server-server communication in Matrix is
exchanging JSON objects over HTTPS APIs. More efficient transports may be
specified in future as optional extensions.</p>
<p>All <code>POST</code> and <code>PUT</code> endpoints require the requesting server to supply a
request body containing a (potentially empty) JSON object. Requesting servers
should supply a <code>Content-Type</code> header of <code>application/json</code> for all requests
with JSON bodies, but this is not required.</p>
<p>Similarly, all endpoints in this specification require the destination server
to return a JSON object.  Servers must include a <code>Content-Type</code> header of
<code>application/json</code> for all JSON responses.</p>
<p>All JSON data, in requests or responses, must be encoded using UTF-8.</p>
<h3 id="tls">TLS</h3>
<p>Server-server communication must take place over HTTPS.</p>
<p>The destination server must provide a TLS certificate signed by a known
Certificate Authority.</p>
<p>Requesting servers are ultimately responsible for determining the trusted Certificate
Authorities, however are strongly encouraged to rely on the operating system&rsquo;s
judgement. Servers can offer administrators a means to override the trusted
authorities list.  Servers can additionally skip the certificate validation for
a given whitelist of domains or netmasks for the purposes of testing or in
networks where verification is done elsewhere, such as with <code>.onion</code>
addresses.</p>
<p>Servers should respect SNI when making requests where possible: a SNI should be
sent for the certificate which is expected, unless that certificate is expected
to be an IP address in which case SNI is not supported and should not be sent.</p>
<p>Servers are encouraged to make use of the <a href="https://www.certificate-transparency.org/">Certificate
Transparency</a> project.</p>
<h3 id="unsupported-endpoints">Unsupported endpoints</h3>
<p>If a request for an unsupported (or unknown) endpoint is received then the server
must respond with a 404 <code>M_UNRECOGNIZED</code> error.</p>
<p>Similarly, a 405 <code>M_UNRECOGNIZED</code> error is used to denote an unsupported method
to a known endpoint.</p>
<h2 id="server-discovery">Server discovery</h2>
<h3 id="resolving-server-names">Resolving server names</h3>
<p>Each Matrix homeserver is identified by a server name consisting of a
hostname and an optional port, as described by the
<a href="/v1.11/appendices/#server-name">grammar</a>. Where applicable, a delegated
server name uses the same grammar.</p>
<p>Server names are resolved to an IP address and port to connect to, and
have various conditions affecting which certificates and <code>Host</code> headers
to send. The process overall is as follows:</p>
<ol>
<li>
<p>If the hostname is an IP literal, then that IP address should be
used, together with the given port number, or 8448 if no port is
given. The target server must present a valid certificate for the IP
address. The <code>Host</code> header in the request should be set to the
server name, including the port if the server name included one.</p>
</li>
<li>
<p>If the hostname is not an IP literal, and the server name includes an
explicit port, resolve the hostname to an IP address using CNAME, AAAA or A
records.
Requests are made to the resolved IP address and given port with a
<code>Host</code> header of the original server name (with port). The target
server must present a valid certificate for the hostname.</p>
</li>
<li>
<p>If the hostname is not an IP literal, a regular HTTPS request is
made to <code>https://&lt;hostname&gt;/.well-known/matrix/server</code>, expecting
the schema defined later in this section. 30x redirects should be
followed, however redirection loops should be avoided. Responses
(successful or otherwise) to the <code>/.well-known</code> endpoint should be
cached by the requesting server. Servers should respect the cache
control headers present on the response, or use a sensible default
when headers are not present. The recommended sensible default is 24
hours. Servers should additionally impose a maximum cache time for
responses: 48 hours is recommended. Errors are recommended to be
cached for up to an hour, and servers are encouraged to
exponentially back off for repeated failures. The schema of the
<code>/.well-known</code> request is later in this section. If the response is
invalid (bad JSON, missing properties, non-200 response, etc), skip
to step 4. If the response is valid, the <code>m.server</code> property is
parsed as <code>&lt;delegated_hostname&gt;[:&lt;delegated_port&gt;]</code> and processed as
follows:</p>
<ol>
<li>If <code>&lt;delegated_hostname&gt;</code> is an IP literal, then that IP address
should be used together with the <code>&lt;delegated_port&gt;</code> or 8448 if
no port is provided. The target server must present a valid TLS
certificate for the IP address. Requests must be made with a
<code>Host</code> header containing the IP address, including the port if
one was provided.</li>
<li>If <code>&lt;delegated_hostname&gt;</code> is not an IP literal, and
<code>&lt;delegated_port&gt;</code> is present, an IP address is discovered by
looking up CNAME, AAAA or A records for <code>&lt;delegated_hostname&gt;</code>.  The
resulting IP address is used, alongside the <code>&lt;delegated_port&gt;</code>.
Requests must be made with a <code>Host</code> header of
<code>&lt;delegated_hostname&gt;:&lt;delegated_port&gt;</code>. The target server must
present a valid certificate for <code>&lt;delegated_hostname&gt;</code>.</li>
<li><span><strong>[Added in <code>v1.8</code>]</strong></span> If <code>&lt;delegated_hostname&gt;</code> is not an IP literal and no
<code>&lt;delegated_port&gt;</code> is present, an SRV record is looked up for
<code>_matrix-fed._tcp.&lt;delegated_hostname&gt;</code>. This may result in another
hostname (to be resolved using AAAA or A records) and port.
Requests should be made to the resolved IP address and port with
a <code>Host</code> header containing the <code>&lt;delegated_hostname&gt;</code>. The
target server must present a valid certificate for
<code>&lt;delegated_hostname&gt;</code>.</li>
<li><strong>[Deprecated]</strong> If <code>&lt;delegated_hostname&gt;</code> is not an IP literal, no
<code>&lt;delegated_port&gt;</code> is present, and a <code>_matrix-fed._tcp.&lt;delegated_hostname&gt;</code>
SRV record was not found, an SRV record is looked up for
<code>_matrix._tcp.&lt;delegated_hostname&gt;</code>. This may result in another
hostname (to be resolved using AAAA or A records) and port.
Requests should be made to the resolved IP address and port with
a <code>Host</code> header containing the <code>&lt;delegated_hostname&gt;</code>. The
target server must present a valid certificate for
<code>&lt;delegated_hostname&gt;</code>.</li>
<li>If no SRV record is found, an IP address is resolved using CNAME, AAAA
or A records. Requests are then made to the resolved IP address
and a port of 8448, using a <code>Host</code> header of
<code>&lt;delegated_hostname&gt;</code>. The target server must present a valid
certificate for <code>&lt;delegated_hostname&gt;</code>.</li>
</ol>
</li>
<li>
<p><span><strong>[Added in <code>v1.8</code>]</strong></span> If the <code>/.well-known</code> request resulted in an error response, a server is
found by resolving an SRV record for <code>_matrix-fed._tcp.&lt;hostname&gt;</code>. This may
result in a hostname (to be resolved using AAAA or A records) and
port. Requests are made to the resolved IP address and port, with a <code>Host</code>
header of <code>&lt;hostname&gt;</code>. The target server must present a valid certificate
for <code>&lt;hostname&gt;</code>.</p>
</li>
<li>
<p><strong>[Deprecated]</strong> If the <code>/.well-known</code> request resulted in an error response,
and a <code>_matrix-fed._tcp.&lt;hostname&gt;</code> SRV record was not found, a server is
found by resolving an SRV record for <code>_matrix._tcp.&lt;hostname&gt;</code>. This may
result in a hostname (to be resolved using AAAA or A records) and
port. Requests are made to the resolved IP address and port, with a <code>Host</code>
header of <code>&lt;hostname&gt;</code>. The target server must present a valid certificate
for <code>&lt;hostname&gt;</code>.</p>
</li>
<li>
<p>If the <code>/.well-known</code> request returned an error response, and
no SRV records were found, an IP address is resolved using CNAME, AAAA and A
records. Requests are made to the resolved IP address using port
8448 and a <code>Host</code> header containing the <code>&lt;hostname&gt;</code>. The target
server must present a valid certificate for <code>&lt;hostname&gt;</code>.</p>
</li>
</ol>
<div class="alert note " role="alert">
<p>The reasons we require <code>&lt;hostname&gt;</code> rather than <code>&lt;delegated_hostname&gt;</code> for SRV
delegation are:</p>
<ol>
<li>DNS is insecure (not all domains have DNSSEC), so the target of the delegation
must prove that it is a valid delegate for <code>&lt;hostname&gt;</code> via TLS.</li>
<li>Consistency with the recommendations in <a href="https://datatracker.ietf.org/doc/html/rfc6125#section-6.2.1">RFC6125</a>
and other applications using SRV records such <a href="https://datatracker.ietf.org/doc/html/rfc6120#section-13.7.2.1">XMPP</a>.</li>
</ol>
</div>
<div class="alert note " role="alert">
<p>Note that the target of a SRV record may <em>not</em> be a CNAME, as
mandated by <a href="https://www.rfc-editor.org/rfc/rfc2782.html">RFC2782</a>:</p>
<blockquote>
<p>the name MUST NOT be an alias (in the sense of RFC 1034 or RFC 2181)</p>
</blockquote>
</div>
<div class="alert note " role="alert">
<p>Steps 3.4 and 5 are deprecated because they use a service name not registered by IANA.
They may be removed in a future version of the specification. Server admins are encouraged
to use <code>.well-known</code> over any form of SRV records.</p>
<p>The IANA registration for port 8448 and <code>matrix-fed</code> can be found <a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml?search=matrix-fed">here</a>.</p>
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="getwell-knownmatrixserver">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/.well-known/matrix/server</span>
  </h1>
</summary>
  <hr/>
<p>Gets information about the delegated server for server-server communication
between Matrix homeservers. Servers should follow 30x redirects, carefully
avoiding redirect loops, and use normal X.509 certificate validation.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The delegated server information. The <code>Content-Type</code> for this response SHOULD be <code>application/json</code>, however servers parsing the response should assume that the body is JSON regardless of type. Failures parsing the JSON or invalid data provided in the resulting parsed JSON should not result in discovery failure - consult the server discovery process for information on how to continue.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>m.server</code></td>
  <td><code>string</code></td>
  <td>
    The server name to delegate server-server communications to, with optional
port. The delegated server name uses the same grammar as
<a href="/v1.11/appendices/#server-name">server names in the appendices</a>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;m.server&#34;</span><span class="p">:</span> <span class="s2">&#34;delegated.example.com:1234&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="server-implementation">Server implementation</h3>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1version">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/version</span>
  </h1>
</summary>
  <hr/>
<p>Get the implementation name and version of this homeserver.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The implementation name and version of this homeserver.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>server</code></td>
  <td><code><a href="#get_matrixfederationv1version_response-200_server">Server</a></code></td>
  <td>
    </td>
 </tr>
</table>
<table id="get_matrixfederationv1version_response-200_server" class="object-table">
 <caption>Server</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    Arbitrary name that identify this implementation.</td>
 </tr>
 <tr>
  <td><code>version</code></td>
  <td><code>string</code></td>
  <td>
    Version of this implementation. The version format depends on the implementation.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;server&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;My_Homeserver_Implementation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="s2">&#34;ArbitraryVersionNumber&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="retrieving-server-keys">Retrieving server keys</h3>
<div class="alert note " role="alert">
There was once a &ldquo;version 1&rdquo; of the key exchange. It has been removed
from the specification due to lack of significance. It may be reviewed
<a href="https://github.com/matrix-org/matrix-doc/blob/51faf8ed2e4a63d4cfd6d23183698ed169956cc0/specification/server_server_api.rst#232version-1">from the historical
draft</a>.
</div>
<p>Each homeserver publishes its public keys under
<code>/_matrix/key/v2/server</code>. Homeservers query for keys by either
getting <code>/_matrix/key/v2/server</code> directly or by querying an
intermediate notary server using a
<code>/_matrix/key/v2/query/{serverName}</code> API. Intermediate notary
servers query the <code>/_matrix/key/v2/server</code> API on behalf of
another server and sign the response with their own key. A server may
query multiple notary servers to ensure that they all report the same
public keys.</p>
<p>This approach is borrowed from the <a href="https://web.archive.org/web/20170702024706/https://perspectives-project.org/">Perspectives
Project</a>,
but modified to include the NACL keys and to use JSON instead of XML. It
has the advantage of avoiding a single trust-root since each server is
free to pick which notary servers they trust and can corroborate the
keys returned by a given notary server by querying other servers.</p>
<h4 id="publishing-keys">Publishing Keys</h4>
<p>Homeservers publish their signing keys in a JSON object at
<code>/_matrix/key/v2/server</code>. The response contains a list of
<code>verify_keys</code> that are valid for signing federation requests made by the
homeserver and for signing events. It contains a list of
<code>old_verify_keys</code> which are only valid for signing events.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixkeyv2server">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/key/v2/server</span>
  </h1>
</summary>
  <hr/>
<p>Gets the homeserver&rsquo;s published signing keys.
The homeserver may have any number of active keys and may have a
number of old keys.</p>
<p>Intermediate notary servers should cache a response for half of its
lifetime to avoid serving a stale response. Originating servers should
avoid returning responses that expire in less than an hour to avoid
repeated requests for a certificate that is about to expire. Requesting
servers should limit how frequently they query for certificates to
avoid flooding a server with requests.</p>
<p>If the server fails to respond to this request, intermediate notary
servers should continue to return the last response they received
from the server so that the signatures of old events can still be
checked.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<p>No request parameters or request body.</p>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The homeserver&rsquo;s keys</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="get_matrixkeyv2server_response-200_server-keys" class="object-table">
 <caption>Server Keys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>old_verify_keys</code></td>
  <td><code>{string: <a href="#get_matrixkeyv2server_response-200_old-verify-key">Old Verify Key</a>}</code></td>
  <td>
    <p>The public keys that the server used to use and when it stopped using them.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>0ldK3y</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>server_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>DNS name of the homeserver.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <p>Digital signatures for this object signed using the <code>verify_keys</code>.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>valid_until_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <p>POSIX timestamp in milliseconds when the list of valid keys should be refreshed.
This field MUST be ignored in room versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on the
<a href="/v1.11/rooms/">room version specification</a>.</p>
<p>Servers MUST use the lesser of this field and 7 days into the future when
determining if a key is valid. This is to avoid a situation where an attacker
publishes a key which is valid for a significant amount of time without a way
for the homeserver owner to revoke it.</p>
</td>
 </tr>
 <tr>
  <td><code>verify_keys</code></td>
  <td><code>{string: <a href="#get_matrixkeyv2server_response-200_verify-key">Verify Key</a>}</code></td>
  <td>
    <strong>Required: </strong><p>Public keys of the homeserver for verifying digital signatures.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>abc123</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
</table>
<table id="get_matrixkeyv2server_response-200_old-verify-key" class="object-table">
 <caption>Old Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>expired_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds for when this key expired.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<table id="get_matrixkeyv2server_response-200_verify-key" class="object-table">
 <caption>Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;old_verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519:0ldk3y&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;expired_ts&#34;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;server_name&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:auto2&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;valid_until_ts&#34;</span><span class="p">:</span> <span class="mi">1652262000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="querying-keys-through-another-server">Querying Keys Through Another Server</h4>
<p>Servers may query another server&rsquo;s keys through a notary server. The
notary server may be another homeserver. The notary server will retrieve
keys from the queried servers through use of the
<code>/_matrix/key/v2/server</code> API. The notary server will
additionally sign the response from the queried server before returning
the results.</p>
<p>Notary servers can return keys for servers that are offline or having
issues serving their own keys by using cached responses. Keys can be
queried from multiple servers to mitigate against DNS spoofing.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixkeyv2query">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/key/v2/query</span>
  </h1>
</summary>
  <hr/>
<p>Query for keys from multiple servers in a batch format. The receiving (notary)
server must sign the keys returned by the queried servers.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>server_keys</code></td>
  <td><code>{string: {string: <a href="#post_matrixkeyv2query_request_query-criteria">Query Criteria</a>}}</code></td>
  <td>
    <strong>Required: </strong><p>The query criteria. The outer <code>string</code> key on the object is the
server name (eg: <code>matrix.org</code>). The inner <code>string</code> key is the
Key ID to query for the particular server. If no key IDs are given
to be queried, the notary server should query for all keys. If no
servers are given, the notary server must return an empty <code>server_keys</code>
array in the response.</p>
<p>The notary server may return multiple keys regardless of the Key IDs
given.</p>
</td>
 </tr>
</table>
<table id="post_matrixkeyv2query_request_query-criteria" class="object-table">
 <caption>Query Criteria</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>minimum_valid_until_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <p>A millisecond POSIX timestamp in milliseconds indicating when
the returned certificates will need to be valid until to be
useful to the requesting server.</p>
<p>If not supplied, the current time as determined by the notary
server is used.</p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;server_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;minimum_valid_until_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The keys for the queried servers, signed by the notary server. Servers which
are offline and have no cached keys will not be included in the result. This
may result in an empty array.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>server_keys</code></td>
  <td><code>[<a href="#post_matrixkeyv2query_response-200_server-keys">Server Keys</a>]</code></td>
  <td>
    The queried server&rsquo;s keys, signed by the notary server.</td>
 </tr>
</table>
<table id="post_matrixkeyv2query_response-200_server-keys" class="object-table">
 <caption>Server Keys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>old_verify_keys</code></td>
  <td><code>{string: <a href="#post_matrixkeyv2query_response-200_old-verify-key">Old Verify Key</a>}</code></td>
  <td>
    <p>The public keys that the server used to use and when it stopped using them.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>0ldK3y</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>server_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>DNS name of the homeserver.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <p>Digital signatures for this object signed using the <code>verify_keys</code>.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>valid_until_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <p>POSIX timestamp in milliseconds when the list of valid keys should be refreshed.
This field MUST be ignored in room versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on the
<a href="/v1.11/rooms/">room version specification</a>.</p>
<p>Servers MUST use the lesser of this field and 7 days into the future when
determining if a key is valid. This is to avoid a situation where an attacker
publishes a key which is valid for a significant amount of time without a way
for the homeserver owner to revoke it.</p>
</td>
 </tr>
 <tr>
  <td><code>verify_keys</code></td>
  <td><code>{string: <a href="#post_matrixkeyv2query_response-200_verify-key">Verify Key</a>}</code></td>
  <td>
    <strong>Required: </strong><p>Public keys of the homeserver for verifying digital signatures.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>abc123</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
</table>
<table id="post_matrixkeyv2query_response-200_old-verify-key" class="object-table">
 <caption>Old Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>expired_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds for when this key expired.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<table id="post_matrixkeyv2query_response-200_verify-key" class="object-table">
 <caption>Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;server_keys&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;old_verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:0ldk3y&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;expired_ts&#34;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;server_name&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;notary.server.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:010203&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBpcyBhbm90aGVyIHNpZ25hdHVyZQ&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;valid_until_ts&#34;</span><span class="p">:</span> <span class="mi">1652262000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixkeyv2queryservername">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/key/v2/query/{serverName}</span>
  </h1>
</summary>
  <hr/>
<p>Query for another server&rsquo;s keys. The receiving (notary) server must
sign the keys returned by the queried server.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>serverName</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The server&rsquo;s DNS name to query</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>minimum_valid_until_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <p>A millisecond POSIX timestamp in milliseconds indicating when the returned
certificates will need to be valid until to be useful to the requesting server.</p>
<p>If not supplied, the current time as determined by the notary server is used.</p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The keys for the server, or an empty array if the server could not be reached
and no cached keys were available.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>server_keys</code></td>
  <td><code>[<a href="#get_matrixkeyv2queryservername_response-200_server-keys">Server Keys</a>]</code></td>
  <td>
    The queried server&rsquo;s keys, signed by the notary server.</td>
 </tr>
</table>
<table id="get_matrixkeyv2queryservername_response-200_server-keys" class="object-table">
 <caption>Server Keys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>old_verify_keys</code></td>
  <td><code>{string: <a href="#get_matrixkeyv2queryservername_response-200_old-verify-key">Old Verify Key</a>}</code></td>
  <td>
    <p>The public keys that the server used to use and when it stopped using them.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>0ldK3y</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>server_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>DNS name of the homeserver.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <p>Digital signatures for this object signed using the <code>verify_keys</code>.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>valid_until_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <p>POSIX timestamp in milliseconds when the list of valid keys should be refreshed.
This field MUST be ignored in room versions 1, 2, 3, and 4. Keys used beyond this
timestamp MUST be considered invalid, depending on the
<a href="/v1.11/rooms/">room version specification</a>.</p>
<p>Servers MUST use the lesser of this field and 7 days into the future when
determining if a key is valid. This is to avoid a situation where an attacker
publishes a key which is valid for a significant amount of time without a way
for the homeserver owner to revoke it.</p>
</td>
 </tr>
 <tr>
  <td><code>verify_keys</code></td>
  <td><code>{string: <a href="#get_matrixkeyv2queryservername_response-200_verify-key">Verify Key</a>}</code></td>
  <td>
    <strong>Required: </strong><p>Public keys of the homeserver for verifying digital signatures.</p>
<p>The object&rsquo;s key is the algorithm and version combined (<code>ed25519</code> being the
algorithm and <code>abc123</code> being the version in the example below). Together,
this forms the Key ID. The version must have characters matching the regular
expression <code>[a-zA-Z0-9_]</code>.</p>
</td>
 </tr>
</table>
<table id="get_matrixkeyv2queryservername_response-200_old-verify-key" class="object-table">
 <caption>Old Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>expired_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds for when this key expired.</td>
 </tr>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<table id="get_matrixkeyv2queryservername_response-200_verify-key" class="object-table">
 <caption>Verify Key</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/appendices/#unpadded-base64">Unpadded base64</a> encoded key.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;server_keys&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;old_verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:0ldk3y&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;expired_ts&#34;</span><span class="p">:</span> <span class="mi">1532645052628</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgeW91ciBvbGQga2V5J3MgZWQyNTUxOSBwYXlsb2FkLg&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;server_name&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYWN0dWFsbHkgYmUgYSBzaWduYXR1cmU&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;notary.server.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:010203&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBpcyBhbm90aGVyIHNpZ25hdHVyZQ&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;valid_until_ts&#34;</span><span class="p">:</span> <span class="mi">1652262000000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;verify_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:abc123&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;VGhpcyBzaG91bGQgYmUgYSByZWFsIGVkMjU1MTkgcGF5bG9hZA&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="authentication">Authentication</h2>
<h3 id="request-authentication">Request Authentication</h3>
<p>Every HTTP request made by a homeserver is authenticated using public
key digital signatures. The request method, target and body are signed
by wrapping them in a JSON object and signing it using the JSON signing
algorithm. The resulting signatures are added as an Authorization header
with an auth scheme of <code>X-Matrix</code>. Note that the target field should
include the full path starting with <code>/_matrix/...</code>, including the <code>?</code>
and any query parameters if present, but should not include the leading
<code>https:</code>, nor the destination server&rsquo;s hostname.</p>
<p>Step 1 sign JSON:</p>
<pre tabindex="0"><code>{
    &#34;method&#34;: &#34;POST&#34;,
    &#34;uri&#34;: &#34;/target&#34;,
    &#34;origin&#34;: &#34;origin.hs.example.com&#34;,
    &#34;destination&#34;: &#34;destination.hs.example.com&#34;,
    &#34;content&#34;: &lt;JSON-parsed request body&gt;,
    &#34;signatures&#34;: {
        &#34;origin.hs.example.com&#34;: {
            &#34;ed25519:key1&#34;: &#34;ABCDEF...&#34;
        }
    }
}
</code></pre><p>The server names in the JSON above are the server names for each
homeserver involved. Delegation from the <a href="/v1.11/server-server-api/#resolving-server-names">server name resolution
section</a> above do not affect these - the server
names from before delegation would take place are used. This same
condition applies throughout the request signing process.</p>
<p>Step 2 add Authorization header:</p>
<pre><code>POST /target HTTP/1.1
Authorization: X-Matrix origin=&quot;origin.hs.example.com&quot;,destination=&quot;destination.hs.example.com&quot;,key=&quot;ed25519:key1&quot;,sig=&quot;ABCDEF...&quot;
Content-Type: application/json

&lt;JSON-encoded request body&gt;
</code></pre>
<p>Example python code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">authorization_headers</span><span class="p">(</span><span class="n">origin_name</span><span class="p">,</span> <span class="n">origin_signing_key</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">destination_name</span><span class="p">,</span> <span class="n">request_method</span><span class="p">,</span> <span class="n">request_target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">request_json</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;method&#34;</span><span class="p">:</span> <span class="n">request_method</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;uri&#34;</span><span class="p">:</span> <span class="n">request_target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;origin&#34;</span><span class="p">:</span> <span class="n">origin_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="s2">&#34;destination&#34;</span><span class="p">:</span> <span class="n">destination_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Assuming content is already parsed as JSON</span>
</span></span><span class="line"><span class="cl">        <span class="n">request_json</span><span class="p">[</span><span class="s2">&#34;content&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">signed_json</span> <span class="o">=</span> <span class="n">sign_json</span><span class="p">(</span><span class="n">request_json</span><span class="p">,</span> <span class="n">origin_name</span><span class="p">,</span> <span class="n">origin_signing_key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">authorization_headers</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">sig</span> <span class="ow">in</span> <span class="n">signed_json</span><span class="p">[</span><span class="s2">&#34;signatures&#34;</span><span class="p">][</span><span class="n">origin_name</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">authorization_headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;X-Matrix origin=</span><span class="se">\&#34;</span><span class="si">%s</span><span class="se">\&#34;</span><span class="s2">,destination=</span><span class="se">\&#34;</span><span class="si">%s</span><span class="se">\&#34;</span><span class="s2">,key=</span><span class="se">\&#34;</span><span class="si">%s</span><span class="se">\&#34;</span><span class="s2">,sig=</span><span class="se">\&#34;</span><span class="si">%s</span><span class="se">\&#34;</span><span class="s2">&#34;</span> <span class="o">%</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">origin_name</span><span class="p">,</span> <span class="n">destination_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="s2">&#34;Authorization&#34;</span><span class="p">,</span> <span class="n">authorization_headers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></div><p>The format of the Authorization header is given in
<a href="https://datatracker.ietf.org/doc/html/rfc9110#section-11.4">Section 11.4 of RFC 9110</a>. In
summary, the header begins with authorization scheme <code>X-Matrix</code>, followed by one
or more spaces, followed by a comma-separated list of parameters written as
name=value pairs. Zero or more spaces and tabs around each comma are allowed.
The names are case insensitive and order does not matter. The
values must be enclosed in quotes if they contain characters that are not
allowed in <code>token</code>s, as defined in
<a href="https://datatracker.ietf.org/doc/html/rfc9110#section-5.6.2">Section 5.6.2 of RFC 9110</a>; if a
value is a valid <code>token</code>, it may or may not be enclosed in quotes. Quoted
values may include backslash-escaped characters. When parsing the header, the
recipient must unescape the characters. That is, a backslash-character pair is
replaced by the character that follows the backslash.</p>
<p>For compatibility with older servers, the sender should</p>
<ul>
<li>only include one space after <code>X-Matrix</code>,</li>
<li>only use lower-case names,</li>
<li>avoid using backslashes in parameter values, and</li>
<li>avoid including whitespace around the commas between name=value pairs.</li>
</ul>
<p>For compatibility with older servers, the recipient should allow colons to be
included in values without requiring the value to be enclosed in quotes.</p>
<p>The authorization parameters to include are:</p>
<ul>
<li><code>origin</code>: the server name of the sending server. This is the same as the
<code>origin</code> field from JSON described in step 1.</li>
<li><code>destination</code>: <span><strong>[Added in <code>v1.3</code>]</strong></span> the server name of the receiving
server. This is the same as the <code>destination</code> field from the JSON described
in step 1. For compatibility with older servers, recipients should accept
requests without this parameter, but MUST always send it. If this property
is included, but the value does not match the receiving server&rsquo;s name, the
receiving server must deny the request with an HTTP status code 401
Unauthorized.</li>
<li><code>key</code>: the ID, including the algorithm name, of the sending server&rsquo;s key used
to sign the request.</li>
<li><code>signature</code>: the signature of the JSON as calculated in step 1.</li>
</ul>
<p>Unknown parameters are ignored.</p>
<div class="alert note " role="alert">
<span><strong>[Changed in <code>v1.11</code>]</strong></span>
This section used to reference <a href="https://datatracker.ietf.org/doc/html/rfc7235#section-2.1">RFC 7235</a>
and <a href="https://datatracker.ietf.org/doc/html/rfc9110#section-5.6.2">RFC 7230</a>, that
were obsoleted by RFC 9110 without changes to the sections of interest here.
</div>
<h3 id="response-authentication">Response Authentication</h3>
<p>Responses are authenticated by the TLS server certificate. A homeserver
should not send a request until it has authenticated the connected
server to avoid leaking messages to eavesdroppers.</p>
<h3 id="client-tls-certificates">Client TLS Certificates</h3>
<p>Requests are authenticated at the HTTP layer rather than at the TLS
layer because HTTP services like Matrix are often deployed behind load
balancers that handle the TLS and these load balancers make it difficult
to check TLS client certificates.</p>
<p>A homeserver may provide a TLS client certificate and the receiving
homeserver may check that the client certificate matches the certificate
of the origin homeserver.</p>
<h2 id="transactions">Transactions</h2>
<p>The transfer of EDUs and PDUs between homeservers is performed by an
exchange of Transaction messages, which are encoded as JSON objects,
passed over an HTTP PUT request. A Transaction is meaningful only to the
pair of homeservers that exchanged it; they are not globally-meaningful.</p>
<p>Transactions are limited in size; they can have at most 50 PDUs and 100
EDUs.</p>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1sendtxnid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v1/send/{txnId}</span>
  </h1>
</summary>
  <hr/>
<p>Push messages representing live activity to another server. The destination name
will be set to that of the receiving server itself. Each embedded PDU in the
transaction body will be processed.</p>
<p>The sending server must wait and retry for a 200 OK response before sending a
transaction with a different <code>txnId</code> to the receiving server.</p>
<p>Note that events have a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>txnId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The transaction ID.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="put_matrixfederationv1sendtxnid_request_transaction" class="object-table">
 <caption>Transaction</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>edus</code></td>
  <td><code>[<a href="#put_matrixfederationv1sendtxnid_request_ephemeral-data-unit">Ephemeral Data Unit</a>]</code></td>
  <td>
    List of ephemeral messages. May be omitted if there are no ephemeral
messages to be sent. Must not include more than 100 EDUs.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>server_name</code> of the homeserver sending this transaction.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds on originating homeserver when this
transaction started.</td>
 </tr>
 <tr>
  <td><code>pdus</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>List of persistent updates to rooms. Must not include more than 50 PDUs. Note that
events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<table id="put_matrixfederationv1sendtxnid_request_ephemeral-data-unit" class="object-table">
 <caption>Ephemeral Data Unit</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The content of the ephemeral message.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of ephemeral message.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdus&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The result of processing the transaction. The server is to use this response even in
the event of one or more PDUs failing to be processed.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="put_matrixfederationv1sendtxnid_response-200_pdu-processing-results" class="object-table">
 <caption>PDU Processing Results</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>pdus</code></td>
  <td><code>{<a href="/v1.11/appendices#event-ids">Event ID</a>: <a href="#put_matrixfederationv1sendtxnid_response-200_pdu-processing-result">PDU Processing Result</a>}</code></td>
  <td>
    <strong>Required: </strong>The PDUs from the original transaction. The string key represents the ID of the
PDU (event) that was processed.</td>
 </tr>
</table>
<table id="put_matrixfederationv1sendtxnid_response-200_pdu-processing-result" class="object-table">
 <caption>PDU Processing Result</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human readable description about what went wrong in processing this PDU.
If no error is present, the PDU can be considered successfully handled.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdus&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;$failed_event:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not allowed to send a message to this room.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;$successful_event:example.org&#34;</span><span class="p">:</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="pdus">PDUs</h2>
<p>Each PDU contains a single Room Event which the origin server wants to
send to the destination.</p>
<p>The <code>prev_events</code> field of a PDU identifies the &ldquo;parents&rdquo; of the event,
and thus establishes a partial ordering on events within the room by
linking them into a Directed Acyclic Graph (DAG). The sending server
should populate this field with all of the events in the room for which
it has not yet seen a child - thus demonstrating that the event comes
after all other known events.</p>
<p>For example, consider a room whose events form the DAG shown below. A
server creating a new event in this room should populate the new event&rsquo;s
<code>prev_events</code> field with both <code>E4</code> and <code>E6</code>, since neither event yet has
a child:</p>
<pre><code>E1
^
|
E2 &lt;--- E5
^       ^
|       |
E3      E6
^
|
E4
</code></pre>
<p>For a full schema of what a PDU looks like, see the <a href="/v1.11/rooms/">room version
specification</a>.</p>
<h3 id="checks-performed-on-receipt-of-a-pdu">Checks performed on receipt of a PDU</h3>
<p>Whenever a server receives an event from a remote server, the receiving
server must ensure that the event:</p>
<ol>
<li>Is a valid event, otherwise it is dropped. For an event to be valid, it
must contain a <code>room_id</code>, and it must comply with the event format of
that <a href="/v1.11/rooms/">room version</a>.</li>
<li>Passes signature checks, otherwise it is dropped.</li>
<li>Passes hash checks, otherwise it is redacted before being processed
further.</li>
<li>Passes authorization rules based on the event&rsquo;s auth events,
otherwise it is rejected.</li>
<li>Passes authorization rules based on the state before the event,
otherwise it is rejected.</li>
<li>Passes authorization rules based on the current state of the room,
otherwise it is &ldquo;soft failed&rdquo;.</li>
</ol>
<p>Further details of these checks, and how to handle failures, are
described below.</p>
<p>The <a href="/v1.11/server-server-api/#signing-events">Signing Events</a> section has more information on
which hashes and signatures are expected on events, and how to calculate
them.</p>
<h4 id="definitions">Definitions</h4>
<dl>
<dt>Required Power Level</dt>
<dd>
<p>A given event type has an associated <em>required power level</em>. This is given by
the current <a href="/v1.11/client-server-api/#mroompower_levels"><code>m.room.power_levels</code></a>
event. The event type is either listed explicitly in the <code>events</code> section or
given by either <code>state_default</code> or <code>events_default</code> depending on if the event
is a state event or not.</p>
</dd>
<dt>Invite Level, Kick Level, Ban Level, Redact Level</dt>
<dd>
<p>The levels given by the <code>invite</code>, <code>kick</code>, <code>ban</code>, and <code>redact</code> properties in
the current <a href="/v1.11/client-server-api/#mroompower_levels"><code>m.room.power_levels</code></a>
state. The invite level defaults to 0 if unspecified. The kick level, ban level
and redact level each default to 50 if unspecified.</p>
</dd>
<dt>Target User</dt>
<dd>
<p>For an <a href="/v1.11/client-server-api/#mroommember"><code>m.room.member</code></a> state event, the
user given by the <code>state_key</code> of the event.</p>
</dd>
</dl>
<div class="alert warning " role="alert">
<p>Some <a href="/v1.11/rooms/">room versions</a> accept power level values to be represented as
strings rather than integers. This is strictly for backwards compatibility.
A homeserver should take reasonable precautions to prevent users from sending
new power level events with string values (eg: by rejecting the API request),
and must never populate the default power levels in a room as string values.</p>
<p>See the <a href="/v1.11/rooms/">room version specification</a> for more information.</p>
</div>
<h4 id="authorization-rules">Authorization rules</h4>
<p>The rules governing whether an event is authorized depends on a set of
state. A given event is checked multiple times against different sets of
state, as specified above. Each room version can have a different
algorithm for how the rules work, and which rules are applied. For more
detailed information, please see the <a href="/v1.11/rooms/">room version
specification</a>.</p>
<h5 id="auth-events-selection">Auth events selection</h5>
<p>The <code>auth_events</code> field of a PDU identifies the set of events which give
the sender permission to send the event. The <code>auth_events</code> for the
<code>m.room.create</code> event in a room is empty; for other events, it should be
the following subset of the room state:</p>
<ul>
<li>
<p>The <code>m.room.create</code> event.</p>
</li>
<li>
<p>The current <code>m.room.power_levels</code> event, if any.</p>
</li>
<li>
<p>The sender&rsquo;s current <code>m.room.member</code> event, if any.</p>
</li>
<li>
<p>If type is <code>m.room.member</code>:</p>
<ul>
<li>The target&rsquo;s current <code>m.room.member</code> event, if any.</li>
<li>If <code>membership</code> is <code>join</code> or <code>invite</code>, the current
<code>m.room.join_rules</code> event, if any.</li>
<li>If membership is <code>invite</code> and <code>content</code> contains a
<code>third_party_invite</code> property, the current
<code>m.room.third_party_invite</code> event with <code>state_key</code> matching
<code>content.third_party_invite.signed.token</code>, if any.</li>
<li>If <code>content.join_authorised_via_users_server</code> is present,
and the <a href="/v1.11/rooms/#feature-matrix">room version supports restricted rooms</a>,
then the <code>m.room.member</code> event with <code>state_key</code> matching
<code>content.join_authorised_via_users_server</code>.</li>
</ul>
</li>
</ul>
<h4 id="rejection">Rejection</h4>
<p>If an event is rejected it should neither be relayed to clients nor be
included as a prev event in any new events generated by the server.
Subsequent events from other servers that reference rejected events
should be allowed if they still pass the auth rules. The state used in
the checks should be calculated as normal, except not updating with the
rejected event where it is a state event.</p>
<p>If an event in an incoming transaction is rejected, this should not
cause the transaction request to be responded to with an error response.</p>
<div class="alert note " role="alert">
This means that events may be included in the room DAG even though they
should be rejected.
</div>
<div class="alert note " role="alert">
This is in contrast to redacted events which can still affect the state
of the room. For example, a redacted <code>join</code> event will still result in
the user being considered joined.
</div>
<h4 id="soft-failure">Soft failure</h4>
<div class="alert rationale " role="alert">
<p>It is important that we prevent users from evading bans (or other power
restrictions) by creating events which reference old parts of the DAG.
For example, a banned user could continue to send messages to a room by
having their server send events which reference the event before they
were banned. Note that such events are entirely valid, and we cannot
simply reject them, as it is impossible to distinguish such an event
from a legitimate one which has been delayed. We must therefore accept
such events and let them participate in state resolution and the
federation protocol as normal. However, servers may choose not to send
such events on to their clients, so that end users won&rsquo;t actually see
the events.</p>
<p>When this happens it is often fairly obvious to servers, as they can see
that the new event doesn&rsquo;t actually pass auth based on the &ldquo;current
state&rdquo; (i.e. the resolved state across all forward extremities). While
the event is technically valid, the server can choose to not notify
clients about the new event.</p>
<p>This discourages servers from sending events that evade bans etc. in
this way, as end users won&rsquo;t actually see the events.</p>
</div>
<p>When the homeserver receives a new event over federation it should also
check whether the event passes auth checks based on the current state of
the room (as well as based on the state at the event). If the event does
not pass the auth checks based on the <em>current state</em> of the room (but
does pass the auth checks based on the state at that event) it should be
&ldquo;soft failed&rdquo;.</p>
<p>When an event is &ldquo;soft failed&rdquo; it should not be relayed to the client
nor be referenced by new events created by the homeserver (i.e. they
should not be added to the server&rsquo;s list of forward extremities of the
room). Soft failed events are otherwise handled as usual.</p>
<div class="alert note " role="alert">
Soft failed events participate in state resolution as normal if further
events are received which reference it. It is the job of the state
resolution algorithm to ensure that malicious events cannot be injected
into the room state via this mechanism.
</div>
<div class="alert note " role="alert">
Because soft failed state events participate in state resolution as
normal, it is possible for such events to appear in the current state of
the room. In that case the client should be told about the soft failed
event in the usual way (e.g. by sending it down in the <code>state</code> section
of a sync response).
</div>
<div class="alert note " role="alert">
A soft failed event should be returned in response to federation
requests where appropriate (e.g. in <code>/event/&lt;event_id&gt;</code>). Note that soft
failed events are returned in <code>/backfill</code> and <code>/get_missing_events</code>
responses only if the requests include events referencing the soft
failed events.
</div>
<p>Example</p>
<p>As an example consider the event graph:</p>
<pre><code>  A
 /
B
</code></pre>
<p>where <code>B</code> is a ban of a user <code>X</code>. If the user <code>X</code> tries to set the topic
by sending an event <code>C</code> while evading the ban:</p>
<pre><code>  A
 / \
B   C
</code></pre>
<p>servers that receive <code>C</code> after <code>B</code> should soft fail event <code>C</code>, and so
will neither relay <code>C</code> to its clients nor send any events referencing
<code>C</code>.</p>
<p>If later another server sends an event <code>D</code> that references both <code>B</code> and
<code>C</code> (this can happen if it received <code>C</code> before <code>B</code>):</p>
<pre><code>  A
 / \
B   C
 \ /
  D
</code></pre>
<p>then servers will handle <code>D</code> as normal. <code>D</code> is sent to the servers'
clients (assuming <code>D</code> passes auth checks). The state at <code>D</code> may resolve
to a state that includes <code>C</code>, in which case clients should also to be
told that the state has changed to include <code>C</code>. (<em>Note</em>: This depends on
the exact state resolution algorithm used. In the original version of
the algorithm <code>C</code> would be in the resolved state, whereas in latter
versions the algorithm tries to prioritise the ban over the topic
change.)</p>
<p>Note that this is essentially equivalent to the situation where one
server doesn&rsquo;t receive <code>C</code> at all, and so asks another server for the
state of the <code>C</code> branch.</p>
<p>Let&rsquo;s go back to the graph before <code>D</code> was sent:</p>
<pre><code>  A
 / \
B   C
</code></pre>
<p>If all the servers in the room saw <code>B</code> before <code>C</code> and so soft fail <code>C</code>,
then any new event <code>D'</code> will not reference <code>C</code>:</p>
<pre><code>  A
 / \
B   C
|
D'
</code></pre>
<h4 id="retrieving-event-authorization-information">Retrieving event authorization information</h4>
<p>The homeserver may be missing event authorization information, or wish
to check with other servers to ensure it is receiving the correct auth
chain. These APIs give the homeserver an avenue for getting the
information it needs.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1event_authroomideventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/event_auth/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves the complete auth chain for a given event.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID to get the auth chain of.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to get the auth chain for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The auth chain for the event.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>auth_chain</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>The <a href="/v1.11/server-server-api/#pdus">PDUs</a> forming the auth chain
of the given event. The event format varies depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a>
for precise event formats.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="edus">EDUs</h2>
<p>EDUs, by comparison to PDUs, do not have an ID, a room ID, or a list of
&ldquo;previous&rdquo; IDs. They are intended to be non-persistent data such as user
presence, typing notifications, etc.</p>
<section class="rendered-data definition" id="definition-ephemeral-data-unit">
<details open>
<summary>
<h1>
 <code>Ephemeral Data Unit</code>
</h1>
</summary>
<hr/>
<p>An ephemeral data unit.</p>
<table id="definition-ephemeral-data-unit_ephemeral-data-unit" class="object-table">
 <caption>Ephemeral Data Unit</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>object</code></td>
  <td>
    <strong>Required: </strong>The content of the ephemeral message.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of ephemeral message.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;value&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="room-state-resolution">Room State Resolution</h2>
<p>The <em>state</em> of a room is a map of <code>(event_type, state_key)</code> to
<code>event_id</code>. Each room starts with an empty state, and each state event
which is accepted into the room updates the state of that room.</p>
<p>Where each event has a single <code>prev_event</code>, it is clear what the state
of the room after each event should be. However, when two branches in
the event graph merge, the state of those branches might differ, so a
<em>state resolution</em> algorithm must be used to determine the resultant
state.</p>
<p>For example, consider the following event graph (where the oldest event,
E0, is at the top):</p>
<pre><code>  E0
  |
  E1
 /  \
E2  E4
|    |
E3   |
 \  /
  E5
</code></pre>
<p>Suppose E3 and E4 are both <code>m.room.name</code> events which set the name of
the room. What should the name of the room be at E5?</p>
<p>The algorithm to be used for state resolution depends on the room
version. For a description of each room version&rsquo;s algorithm, please see
the <a href="/v1.11/rooms/">room version specification</a>.</p>
<h2 id="backfilling-and-retrieving-missing-events">Backfilling and retrieving missing events</h2>
<p>Once a homeserver has joined a room, it receives all the events emitted
by other homeservers in that room, and is thus aware of the entire
history of the room from that moment onwards. Since users in that room
are able to request the history by the <code>/messages</code> client API endpoint,
it&rsquo;s possible that they might step backwards far enough into history
before the homeserver itself was a member of that room.</p>
<p>To cover this case, the federation API provides a server-to-server
analog of the <code>/messages</code> client API, allowing one homeserver to fetch
history from another. This is the <code>/backfill</code> API.</p>
<p>To request more history, the requesting homeserver picks another
homeserver that it thinks may have more (most likely this should be a
homeserver for some of the existing users in the room at the earliest
point in history it has currently), and makes a <code>/backfill</code> request.</p>
<p>Similar to backfilling a room&rsquo;s history, a server may not have all the
events in the graph. That server may use the <code>/get_missing_events</code> API
to acquire the events it is missing.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1backfillroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/backfill/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves a sliding-window history of previous PDUs that occurred in the given room.
Starting from the PDU ID(s) given in the <code>v</code> argument, the PDUs given in <code>v</code> and
the PDUs that preceded them are retrieved, up to the total number given by the <code>limit</code>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to backfill.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The maximum number of PDUs to retrieve, including the given events.</td>
 </tr>
 <tr>
  <td><code>v</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The event IDs to backfill from.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td><p>A transaction containing the PDUs that preceded the given event(s), including the given
event(s), up to the given limit.</p>
<p><strong>Note:</strong>
Though the PDU definitions require that <code>prev_events</code> and <code>auth_events</code> be limited
in number, the response of backfill MUST NOT be validated on these specific restrictions.</p>
<p>Due to historical reasons, it is possible that events which were previously accepted
would now be rejected by these limitations. The events should be rejected per usual by
the <code>/send</code>, <code>/get_missing_events</code>, and remaining endpoints.</p>
</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="get_matrixfederationv1backfillroomid_response-200_transaction" class="object-table">
 <caption>Transaction</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>server_name</code> of the homeserver sending this transaction.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds on originating homeserver when this
transaction started.</td>
 </tr>
 <tr>
  <td><code>pdus</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>List of persistent updates to rooms. Note that events have a different format
depending on the room version - check the <a href="/v1.11/rooms/">room version specification</a> for
precise event formats.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdus&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixfederationv1get_missing_eventsroomid">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/federation/v1/get_missing_events/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves previous events that the sender is missing. This is done by doing a breadth-first
walk of the <code>prev_events</code> for the <code>latest_events</code>, ignoring any events in <code>earliest_events</code>
and stopping at the <code>limit</code>.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to search in.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>earliest_events</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The latest event IDs that the sender already has. These are skipped when retrieving
the previous events of <code>latest_events</code>.</td>
 </tr>
 <tr>
  <td><code>latest_events</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The event IDs to retrieve the previous events for.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of events to retrieve. Defaults to 10.</td>
 </tr>
 <tr>
  <td><code>min_depth</code></td>
  <td><code>integer</code></td>
  <td>
    The minimum depth of events to retrieve. Defaults to 0.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;earliest_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$missing_event:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;latest_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$event_that_has_the_missing_event_as_a_previous_event:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The previous events for <code>latest_events</code>, excluding any <code>earliest_events</code>, up to the
provided <code>limit</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>events</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>The missing events. The event format varies depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="retrieving-events">Retrieving events</h2>
<p>In some circumstances, a homeserver may be missing a particular event or
information about the room which cannot be easily determined from
backfilling. These APIs provide homeservers with the option of getting
events and the state of the room at a given point in the timeline.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1eventeventid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/event/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves a single event.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID to get.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A transaction containing a single PDU which is the event requested.</td>
 </tr>
</table>
<h3>200 response</h3>
<table id="get_matrixfederationv1eventeventid_response-200_transaction" class="object-table">
 <caption>Transaction</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>server_name</code> of the homeserver sending this transaction.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>POSIX timestamp in milliseconds on originating homeserver when this
transaction started.</td>
 </tr>
 <tr>
  <td><code>pdus</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>A single PDU. Note that events have a different format depending on the room
version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdus&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1stateroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/state/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves a snapshot of a room&rsquo;s state at a given event.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to get state for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An event ID in the room to retrieve the state at.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The fully resolved state for the room, prior to considering any state
changes induced by the requested event. Includes the authorization
chain for the events.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>auth_chain</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>The full set of authorization events that make up the state
of the room, and their authorization events, recursively. Note that
events have a different format depending on the room version -
check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
 <tr>
  <td><code>pdus</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong>The fully resolved state of the room at the given event. Note that
events have a different format depending on the room version -
check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdus&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1state_idsroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/state_ids/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>Retrieves a snapshot of a room&rsquo;s state at a given event, in the form of
event IDs. This performs the same function as calling <code>/state/{roomId}</code>,
however this returns just the event IDs rather than the full events.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to get state for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An event ID in the room to retrieve the state at.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The fully resolved state for the room, prior to considering any state
changes induced by the requested event. Includes the authorization
chain for the events.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The given <code>event_id</code> was not found or the server doesn&rsquo;t know about the state at
that event to return anything useful.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>auth_chain_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The full set of authorization events that make up the state
of the room, and their authorization events, recursively.</td>
 </tr>
 <tr>
  <td><code>pdu_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The fully resolved state of the room at the given event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_chain_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$an_event:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;pdu_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;$an_event:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1state_idsroomid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Could not find event $Rqnc-F-dvnEYJTyHq_iKxU2bZ1CI92-kuZq3a5lr5Zg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1timestamp_to_eventroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/timestamp_to_event/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.6</code></strong></p>
<p>Get the ID of the event closest to the given timestamp, in the
direction specified by the <code>dir</code> parameter.</p>
<p>This is primarily used when handling the corresponding
<a href="/v1.11/client-server-api/#get_matrixclientv1roomsroomidtimestamp_to_event">client-server endpoint</a>
when the server does not have all of the room history, and does not
have an event suitably close to the requested timestamp.</p>
<p>The heuristics for deciding when to ask another homeserver for a closer
event if your homeserver doesn&rsquo;t have something close, are left up to
the homeserver implementation, although the heuristics will probably be
based on whether the closest event is a forward/backward extremity
indicating it&rsquo;s next to a gap of events which are potentially closer.</p>
<p>A good heuristic for which servers to try first is to sort by servers
that have been in the room the longest because they&rsquo;re most likely to
have anything we ask about.</p>
<p>After the local homeserver receives the response, it should determine,
using the <code>origin_server_ts</code> property, whether the returned event is
closer to the requested timestamp than the closest event that it could
find locally.  If so, it should try to backfill this event via the
<a href="/v1.11/server-server-api/#get_matrixfederationv1eventeventid"><code>/event/{event_id}</code></a> endpoint so
that it is available to for a client to query.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room to search</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>dir</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The direction in which to search.  <code>f</code> for forwards, <code>b</code> for backwards.<p>One of: <code>[f, b]</code>.</p></td>
 </tr>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The timestamp to search from, as given in milliseconds
since the Unix epoch.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An event was found matching the search parameters.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>No event was found.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the event found</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The event&rsquo;s timestamp, in milliseconds since the Unix epoch.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event_id&#34;</span><span class="p">:</span> <span class="s2">&#34;$143273582443PhrSn:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1432735824653</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1timestamp_to_eventroomid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unable to find event from 1432684800000 in forward direction&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="joining-rooms">Joining Rooms</h2>
<p>When a new user wishes to join a room that the user&rsquo;s homeserver already
knows about, the homeserver can immediately determine if this is
allowable by inspecting the state of the room. If it is acceptable, it
can generate, sign, and emit a new <code>m.room.member</code> state event adding
the user into that room. When the homeserver does not yet know about the
room it cannot do this directly. Instead, it must take a longer
multi-stage handshaking process by which it first selects a remote
homeserver which is already participating in that room, and use it to
assist in the joining process. This is the remote join handshake.</p>
<p>This handshake involves the homeserver of the new member wishing to join
(referred to here as the &ldquo;joining&rdquo; server), the directory server hosting
the room alias the user is requesting to join with, and a homeserver
where existing room members are already present (referred to as the
&ldquo;resident&rdquo; server).</p>
<p>In summary, the remote join handshake consists of the joining server
querying the directory server for information about the room alias;
receiving a room ID and a list of join candidates. The joining server
then requests information about the room from one of the residents. It
uses this information to construct an <code>m.room.member</code> event which it
finally sends to a resident server.</p>
<p>Conceptually these are three different roles of homeserver. In practice
the directory server is likely to be resident in the room, and so may be
selected by the joining server to be the assisting resident. Likewise,
it is likely that the joining server picks the same candidate resident
for both phases of event construction, though in principle any valid
candidate may be used at each time. Thus, any join handshake can
potentially involve anywhere from two to four homeservers, though most
in practice will use just two.</p>
<!--
https://textart.io/sequence

object Client JoiningServer DirectoryServer ResidentServer
Client->JoiningServer: join request
JoiningServer->DirectoryServer: directory request
DirectoryServer->JoiningServer: directory response
JoiningServer->ResidentServer: make_join request
ResidentServer->JoiningServer: make_join response
JoiningServer->ResidentServer: send_join request
ResidentServer->JoiningServer: send_join response
JoiningServer->Client: join response
-->
<pre tabindex="0"><code>+---------+          +---------------+            +-----------------+ +-----------------+
| Client  |          | JoiningServer |            | DirectoryServer | | ResidentServer  |
+---------+          +---------------+            +-----------------+ +-----------------+
     |                       |                             |                   |
     | join request          |                             |                   |
     |----------------------&gt;|                             |                   |
     |                       |                             |                   |
     |                       | directory request           |                   |
     |                       |----------------------------&gt;|                   |
     |                       |                             |                   |
     |                       |          directory response |                   |
     |                       |&lt;----------------------------|                   |
     |                       |                             |                   |
     |                       | make_join request           |                   |
     |                       |------------------------------------------------&gt;|
     |                       |                             |                   |
     |                       |                             |make_join response |
     |                       |&lt;------------------------------------------------|
     |                       |                             |                   |
     |                       | send_join request           |                   |
     |                       |------------------------------------------------&gt;|
     |                       |                             |                   |
     |                       |                             |send_join response |
     |                       |&lt;------------------------------------------------|
     |                       |                             |                   |
     |         join response |                             |                   |
     |&lt;----------------------|                             |                   |
     |                       |                             |                   |
</code></pre><p>The first part of the handshake usually involves using the directory
server to request the room ID and join candidates through the
<a href="/v1.11/server-server-api/#get_matrixfederationv1querydirectory"><code>/query/directory</code></a> API endpoint. In the case of a new user joining a
room as a result of a received invite, the joining user&rsquo;s homeserver
could optimise this step away by picking the origin server of that
invite message as the join candidate. However, the joining server should
be aware that the origin server of the invite might since have left the
room, so should be prepared to fall back on the regular join flow if
this optimisation fails.</p>
<p>Once the joining server has the room ID and the join candidates, it then
needs to obtain enough information about the room to fill in the
required fields of the <code>m.room.member</code> event. It obtains this by
selecting a resident from the candidate list, and using the
<code>GET /make_join</code> endpoint. The resident server will then reply with
enough information for the joining server to fill in the event.</p>
<p>The joining server is expected to add or replace the <code>origin</code>,
<code>origin_server_ts</code>, and <code>event_id</code> on the templated event received by
the resident server. This event is then signed by the joining server.</p>
<p>To complete the join handshake, the joining server submits this new event
to the resident server it used for <code>GET /make_join</code>, using the <code>PUT /send_join</code>
endpoint.</p>
<p>The resident homeserver then adds its signature to this event and
accepts it into the room&rsquo;s event graph. The joining server receives
the full set of state for the newly-joined room as well as the freshly
signed membership event. The resident server must also send the event
to other servers participating in the room.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1make_joinroomiduserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/make_join/{roomId}/{userId}</span>
  </h1>
</summary>
  <hr/>
<p>Asks the receiving server to return information that the sending
server will need to prepare a join event to get into the room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be joined.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID the join event will be for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>ver</code></td>
  <td><code>[string]</code></td>
  <td>
    The room versions the sending server has support for. Defaults
to <code>[1]</code>.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A template to be used for the rest of the <a href="/v1.11/server-server-api/#joining-rooms">Joining Rooms</a> handshake. Note that
events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats. <strong>The response body
here describes the common event fields in more detail and may be missing other
required fields for a PDU.</strong></td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid, the room the server is attempting
to join has a version that is not listed in the <code>ver</code>
parameters, or the server was unable to validate
<a href="/v1.11/#restricted-rooms">restricted room conditions</a>.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
<p>New in <code>v1.2</code>, the following error conditions might happen:</p>
<p>If the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and none of the conditions can be validated by the server then
the <code>errcode</code> <code>M_UNABLE_TO_AUTHORISE_JOIN</code> must be used. This can
happen if the server does not know about any of the rooms listed
as conditions, for example.</p>
<p><code>M_UNABLE_TO_GRANT_JOIN</code> is returned to denote that a different
server should be attempted for the join. This is typically because
the resident server can see that the joining user satisfies one or
more conditions, such as in the case of
<a href="/v1.11/client-server-api/#restricted-rooms">restricted rooms</a>, but the
resident server would be unable to meet the auth rules governing
<code>join_authorised_via_users_server</code> on the resulting <code>m.room.member</code>
event.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The room that the joining server is attempting to join does not permit the user
to join.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room that the joining server is attempting to join is unknown
to the receiving server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#get_matrixfederationv1make_joinroomiduserid_response-200_event-template">Event Template</a></code></td>
  <td>
    An unsigned template event. Note that events have a different format
depending on the room version - check the <a href="/v1.11/rooms/">room version specification</a>
for precise event formats.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room where the server is trying to join. If not provided,
the room version is assumed to be either &ldquo;1&rdquo; or &ldquo;2&rdquo;.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_joinroomiduserid_response-200_event-template" class="object-table">
 <caption>Event Template</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#get_matrixfederationv1make_joinroomiduserid_response-200_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_joinroomiduserid_response-200_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>join_authorised_via_users_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required if the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and is joining through one of the conditions available. If the
user is responding to an invite, this is not required.</p>
<p>An arbitrary user ID belonging to the resident server in
the room being joined that is able to issue invites to other
users. This is used in later validation of the auth rules for
the <code>m.room.member</code> event.</p>
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>join</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_authorised_via_users_server&#34;</span><span class="p">:</span> <span class="s2">&#34;@anyone:resident.example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="get_matrixfederationv1make_joinroomiduserid_response-400_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room. Required if the <code>errcode</code>
is <code>M_INCOMPATIBLE_ROOM_VERSION</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INCOMPATIBLE_ROOM_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Your homeserver does not support the features required to join this room&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="get_matrixfederationv1make_joinroomiduserid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not invited to this room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1make_joinroomiduserid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1send_joinroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint deprecated-inline">/_matrix/federation/v1/send_join/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><strong>Note:</strong>
Servers should instead prefer to use the v2 <code>/send_join</code> endpoint.</p>
<p>Submits a signed join event to the resident server for it
to accept it into the room&rsquo;s graph. Note that events have
a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the join event.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be joined.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1send_joinroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the joining homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the joining homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv1send_joinroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>join_authorised_via_users_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required if the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and is joining through one of the conditions available. If the
user is responding to an invite, this is not required.</p>
<p>An arbitrary user ID belonging to the resident server in
the room being joined that is able to issue invites to other
users. This is used in later validation of the auth rules for
the <code>m.room.member</code> event.</p>
<p>The resident server which owns the provided user ID must have a
valid signature on the event. If the resident server is receiving
the <code>/send_join</code> request, the signature must be added before sending
or persisting the event to other servers.</p>
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>join</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The join event has been accepted into the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>integer, Room State</code>.</p>
<table id="put_matrixfederationv1send_joinroomideventid_response-200_room-state" class="object-table">
 <caption>Room State</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>auth_chain</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong><p>The auth chain for the entire current room state prior to the join event.</p>
<p>Note that events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats.</p>
</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The resident server&rsquo;s DNS name.</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong><p>The resolved current room state prior to the join event.</p>
<p>The event format varies depending on the room version - check the <a href="/v1.11/rooms/">room version specification</a>
for precise event formats.</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;auth_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;auth_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;join_authorised_via_users_server&#34;</span><span class="p">:</span> <span class="s2">&#34;@arbitrary:resident.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;depth&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sha256&#34;</span><span class="p">:</span> <span class="s2">&#34;thishashcoversallfieldsincasethisisredacted&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1404838188000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;prev_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!UcYsUzyxTGDxLBEvLy:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;these86bytesofbase64signaturecoveressentialfieldsincludinghashessocancheckredactedpdus&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;resident.example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:other_key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;a different signature&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">4612</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv2send_joinroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v2/send_join/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Note:</strong>
This API is nearly identical to the v1 API with the
exception of the response format being fixed.</p>
<p>This endpoint is preferred over the v1 API as it provides
a more standardised response format. Senders which receive
a 400, 404, or other status code which indicates this endpoint
is not available should retry using the v1 API instead.</p>
<p>Submits a signed join event to the resident server for it
to accept it into the room&rsquo;s graph. Note that events have
a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the join event.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be joined.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>omit_members</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>If <code>true</code>, indicates that that calling server can accept a reduced
response, in which membership events are omitted from <code>state</code> and
redundant events are omitted from <code>auth_chain</code>.</p>
<p>If the room to be joined has no <code>m.room.name</code> nor
<code>m.room.canonical_alias</code> events in its current state, the resident
server should determine the room members who would be included in
the <code>m.heroes</code> property of the room summary as defined in the
<a href="/v1.11/client-server-api/#get_matrixclientv3sync">Client-Server /sync
response</a>. The resident
server should include these members&rsquo; membership events in the
response <code>state</code> field, and include the auth chains for these
membership events in the response <code>auth_chain</code> field.</p>
<p><strong>Added in <code>v1.6</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv2send_joinroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the joining homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the joining homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the joining member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv2send_joinroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>join_authorised_via_users_server</code></td>
  <td><code>string</code></td>
  <td>
    <p>Required if the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and is joining through one of the conditions available. If the
user is responding to an invite, this is not required.</p>
<p>An arbitrary user ID belonging to the resident server in
the room being joined that is able to issue invites to other
users. This is used in later validation of the auth rules for
the <code>m.room.member</code> event.</p>
<p>The resident server which owns the provided user ID must have a
valid signature on the event. If the resident server is receiving
the <code>/send_join</code> request, the signature must be added before sending
or persisting the event to other servers.</p>
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>join</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The join event has been accepted into the room.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid in some way.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
<p>New in <code>v1.2</code>, the following error conditions might happen:</p>
<p>If the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and none of the conditions can be validated by the server then
the <code>errcode</code> <code>M_UNABLE_TO_AUTHORISE_JOIN</code> must be used. This can
happen if the server does not know about any of the rooms listed
as conditions, for example.</p>
<p><code>M_UNABLE_TO_GRANT_JOIN</code> is returned to denote that a different
server should be attempted for the join. This is typically because
the resident server can see that the joining user satisfies one or
more conditions, such as in the case of
<a href="/v1.11/client-server-api/#restricted-rooms">restricted rooms</a>, but the
resident server would be unable to meet the auth rules governing
<code>join_authorised_via_users_server</code> on the resulting <code>m.room.member</code>
event.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The room that the joining server is attempting to join does not permit the user
to join.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>auth_chain</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong><p>All events in the auth chain for the new join event, as well
as those in the auth chains for any events returned in
<code>state</code>.</p>
<p>If the <code>omit_members</code> query parameter was set to <code>true</code>, then
any events that are returned in <code>state</code> may be omitted from
<code>auth_chain</code>, whether or not membership events are omitted
from <code>state</code>.</p>
<p>Note that events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats.</p>
<br><br>
    <strong>
      Changed in <code>v1.6</code>:
    </strong>
    reworded to include only consider state events returned in
<code>state</code>, and to allow elision of redundant events.
</td>
 </tr>
 <tr>
  <td><code>event</code></td>
  <td><code>SignedMembershipEvent</code></td>
  <td>
    The membership event sent to other servers by the resident server including a signature
from the resident server. Required if the room is <a href="/v1.11/client-server-api/#restricted-rooms">restricted</a>
and the joining user is authorised by one of the conditions.
<p><strong>Added in <code>v1.2</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>members_omitted</code></td>
  <td><code>boolean</code></td>
  <td>
    <code>true</code> if <code>m.room.member</code> events have been omitted from <code>state</code>.
<p><strong>Added in <code>v1.6</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The resident server&rsquo;s DNS name.</td>
 </tr>
 <tr>
  <td><code>servers_in_room</code></td>
  <td><code>[string]</code></td>
  <td>
    <p><strong>Required</strong> if <code>members_omitted</code> is true.</p>
<p>A list of the servers active in the room (ie, those with joined members) before the join.</p>
<p><strong>Added in <code>v1.6</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>state</code></td>
  <td><code>[PDU]</code></td>
  <td>
    <strong>Required: </strong><p>The resolved current room state prior to the join event.</p>
<p>If the request had <code>omit_members</code> set to <code>true</code>, events of
type <code>m.room.member</code> may be omitted from the response to
reduce the size of the response. If this is done,
<code>members_omitted</code> must be set to <code>true</code>.</p>
<br><br>
    <strong>
      Changed in <code>v1.6</code>:
    </strong>
    permit omission of membership events.
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;auth_chain&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;auth_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_authorised_via_users_server&#34;</span><span class="p">:</span> <span class="s2">&#34;@arbitrary:resident.example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;join&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;depth&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;hashes&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sha256&#34;</span><span class="p">:</span> <span class="s2">&#34;thishashcoversallfieldsincasethisisredacted&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1404838188000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;prev_events&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;$urlsafe_base64_encoded_eventid&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;$a-different-event-id&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!UcYsUzyxTGDxLBEvLy:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;these86bytesofbase64signaturecoveressentialfieldsincludinghashessocancheckredactedpdus&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;resident.example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:other_key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;a different signature&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;age&#34;</span><span class="p">:</span> <span class="mi">4612</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;members_omitted&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;servers_in_room&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;see_room_version_spec&#34;</span><span class="p">:</span> <span class="s2">&#34;The event format changes depending on the room version.&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.minimal_pdu&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="put_matrixfederationv2send_joinroomideventid_response-400_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNABLE_TO_GRANT_JOIN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;This server cannot send invites to you.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="put_matrixfederationv2send_joinroomideventid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not invited to this room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h3 id="restricted-rooms">Restricted rooms</h3>
<p>Restricted rooms are described in detail in the
<a href="/v1.11/client-server-api/#restricted-rooms">client-server API</a> and are available
in room versions <a href="/v1.11/rooms/#feature-matrix">which support restricted join rules</a>.</p>
<p>A resident server processing a request to join a restricted room must
ensure that the joining server satisfies at least one of the conditions
specified by <code>m.room.join_rules</code>. If no conditions are available, or none
match the required schema, then the joining server is considered to have
failed all conditions.</p>
<p>The resident server uses a 400 <code>M_UNABLE_TO_AUTHORISE_JOIN</code> error on
<code>/make_join</code> and <code>/send_join</code> to denote that the resident server is unable
to validate any of the conditions, usually because the resident server
does not have state information about rooms required by the conditions.</p>
<p>The resident server uses a 400 <code>M_UNABLE_TO_GRANT_JOIN</code> error on <code>/make_join</code>
and <code>/send_join</code> to denote that the joining server should try a different
server. This is typically because the resident server can see that the
joining user satisfies one of the conditions, though the resident server
would be unable to meet the auth rules governing <code>join_authorised_via_users_server</code>
on the resulting <code>m.room.member</code> event.</p>
<p>If the joining server fails all conditions then a 403 <code>M_FORBIDDEN</code> error
is used by the resident server.</p>
<h2 id="knocking-rooms">Knocking upon a room</h2>
<p>Rooms can permit knocking through the join rules, and if permitted this
gives users a way to request to join (be invited) to the room. Users who
knock on a room where the server is already a resident of the room can
just send the knock event directly without using this process, however
much like <a href="/v1.11/server-server-api/#joining-rooms">joining rooms</a> the server
must handshake their way into having the knock sent on its behalf.</p>
<p>The handshake is largely the same as the joining rooms handshake, where
instead of a &ldquo;joining server&rdquo; there is a &ldquo;knocking server&rdquo;, and the APIs
to be called are different (<code>/make_knock</code> and <code>/send_knock</code>).</p>
<p>Servers can retract knocks over federation by leaving the room, as described
below for rejecting invites.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1make_knockroomiduserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/make_knock/{roomId}/{userId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Asks the receiving server to return information that the sending
server will need to prepare a knock event for the room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be knocked.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID the knock event will be for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>ver</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The room versions the sending server has support for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A template to be used for the rest of the <a href="/v1.11/server-server-api/#knocking-rooms">Knocking Rooms</a>
handshake. Note that events have a different format depending on room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats. <strong>The response body
here describes the common event fields in more detail and may be missing other
required fields for a PDU.</strong></td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid or the room the server is attempting
to knock upon has a version that is not listed in the <code>ver</code>
parameters.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The knocking server or user is not permitted to knock on the room, such as when the
server/user is banned or the room is not set up for receiving knocks.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room that the knocking server is attempting to knock upon is unknown
to the receiving server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#get_matrixfederationv1make_knockroomiduserid_response-200_event-template">Event Template</a></code></td>
  <td>
    <strong>Required: </strong>An unsigned template event. Note that events have a different format
depending on the room version - check the <a href="/v1.11/rooms/">room version specification</a>
for precise event formats.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The version of the room where the server is trying to knock.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_knockroomiduserid_response-200_event-template" class="object-table">
 <caption>Event Template</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#get_matrixfederationv1make_knockroomiduserid_response-200_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the knocking member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the knocking member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_knockroomiduserid_response-200_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>knock</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;7&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="get_matrixfederationv1make_knockroomiduserid_response-400_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room. Required if the <code>errcode</code>
is <code>M_INCOMPATIBLE_ROOM_VERSION</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INCOMPATIBLE_ROOM_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Your homeserver does not support the features required to knock on this room&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;7&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="get_matrixfederationv1make_knockroomiduserid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not permitted to knock on this room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1make_knockroomiduserid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1send_knockroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v1/send_knock/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>Submits a signed knock event to the resident server for it to
accept into the room&rsquo;s graph. Note that events have
a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the knock event.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be knocked upon.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1send_knockroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the knocking homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the knocking homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the knocking member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the knocking member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv1send_knockroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>knock</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Information about the room to pass along to clients regarding the
knock.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The knocking server or user is not permitted to knock on the room, such as when the
server/user is banned or the room is not set up for receiving knocks.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room that the knocking server is attempting to knock upon is unknown
to the receiving server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>knock_room_state</code></td>
  <td><code>[<a href="#put_matrixfederationv1send_knockroomideventid_response-200_strippedstateevent">StrippedStateEvent</a>]</code></td>
  <td>
    <strong>Required: </strong>A list of <a href="/v1.11/client-server-api/#stripped-state">stripped state events</a>
to help the initiator of the knock identify the room.</td>
 </tr>
</table>
<table id="put_matrixfederationv1send_knockroomideventid_response-200_strippedstateevent" class="object-table">
 <caption>StrippedStateEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;knock_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;knock&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="put_matrixfederationv1send_knockroomideventid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;You are not permitted to knock on this room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="put_matrixfederationv1send_knockroomideventid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Unknown room&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="inviting-to-a-room">Inviting to a room</h2>
<p>When a user on a given homeserver invites another user on the same
homeserver, the homeserver may sign the membership event itself and skip
the process defined here. However, when a user invites another user on a
different homeserver, a request to that homeserver to have the event
signed and verified must be made.</p>
<p>Note that invites are used to indicate that knocks were accepted. As such,
receiving servers should be prepared to manually link up a previous knock
to an invite if the invite event does not directly reference the knock.</p>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1inviteroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v1/invite/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p>Invites a remote user to a room. Once the event has been  signed by both the inviting
homeserver and the invited homeserver, it can be sent to all of the servers in the
room by the inviting homeserver.</p>
<p>Servers should prefer to use the v2 API for invites instead of the v1 API. Servers
which receive a v1 invite request must assume that the room version is either <code>&quot;1&quot;</code>
or <code>&quot;2&quot;</code>.</p>
<p>Note that events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats. <strong>The request and response
bodies here describe the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the invite event, generated by the inviting server.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that the user is being invited to.</td>
 </tr>
</table>
<h3>Request body</h3>
<table id="put_matrixfederationv1inviteroomideventid_request_inviteevent" class="object-table">
 <caption>InviteEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1inviteroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event, matching what is available in the
<a href="/v1.11/client-server-api/">Client-Server API</a>. Must include a <code>membership</code> of <code>invite</code>.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The matrix ID of the user who sent the original <code>m.room.third_party_invite</code>.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the invited member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code><a href="#put_matrixfederationv1inviteroomideventid_request_unsigneddata">UnsignedData</a></code></td>
  <td>
    Information included alongside the event that is not signed. May include more
than what is listed here.</td>
 </tr>
</table>
<table id="put_matrixfederationv1inviteroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>invite</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv1inviteroomideventid_request_unsigneddata" class="object-table">
 <caption>UnsignedData</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>invite_room_state</code></td>
  <td><code>[<a href="#put_matrixfederationv1inviteroomideventid_request_strippedstateevent">StrippedStateEvent</a>]</code></td>
  <td>
    An optional list of <a href="/v1.11/client-server-api/#stripped-state">stripped state events</a>
to help the receiver of the invite identify the room.</td>
 </tr>
</table>
<table id="put_matrixfederationv1inviteroomideventid_request_strippedstateevent" class="object-table">
 <caption>StrippedStateEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@joe:elsewhere.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;invite_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The event with the invited server&rsquo;s signature added. All other fields of the events
should remain untouched. Note that events have a different format depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The invite is not allowed. This could be for a number of reasons, including:</p>
<ul>
<li>The sender is not allowed to send invites to the target user/homeserver.</li>
<li>The homeserver does not permit anyone to invite its users.</li>
<li>The homeserver refuses to participate in the room.</li>
</ul></td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>integer, Event Container</code>.</p>
<table id="put_matrixfederationv1inviteroomideventid_response-200_event-container" class="object-table">
 <caption>Event Container</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#put_matrixfederationv1inviteroomideventid_response-200_inviteevent">InviteEvent</a></code></td>
  <td>
    <strong>Required: </strong>An invite event. Note that events have a different format depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<table id="put_matrixfederationv1inviteroomideventid_response-200_inviteevent" class="object-table">
 <caption>InviteEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1inviteroomideventid_response-200_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event, matching what is available in the
<a href="/v1.11/client-server-api/">Client-Server API</a>. Must include a <code>membership</code> of <code>invite</code>.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The matrix ID of the user who sent the original <code>m.room.third_party_invite</code>.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the invited member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv1inviteroomideventid_response-200_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>invite</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;elsewhere.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:k3y_versi0n&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeOtherSignatureHere&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeSignatureHere&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;invite_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="put_matrixfederationv1inviteroomideventid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;User cannot invite the target user.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv2inviteroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v2/invite/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Note:</strong>
This API is nearly identical to the v1 API with the exception of the request
body being different, and the response format fixed.</p>
<p>Invites a remote user to a room. Once the event has been  signed by both the inviting
homeserver and the invited homeserver, it can be sent to all of the servers in the
room by the inviting homeserver.</p>
<p>This endpoint is preferred over the v1 API as it is more useful for servers. Senders
which receive a 400 or 404 response to this endpoint should retry using the v1
API as the server may be older, if the room version is &ldquo;1&rdquo; or &ldquo;2&rdquo;.</p>
<p>Note that events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats. <strong>The request and response
bodies here describe the common event fields in more detail and may be missing other
required fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the invite event, generated by the inviting server.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that the user is being invited to.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#put_matrixfederationv2inviteroomideventid_request_inviteevent">InviteEvent</a></code></td>
  <td>
    <strong>Required: </strong>An invite event. Note that events have a different format depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
 <tr>
  <td><code>invite_room_state</code></td>
  <td><code>[<a href="#put_matrixfederationv2inviteroomideventid_request_strippedstateevent">StrippedStateEvent</a>]</code></td>
  <td>
    An optional list of <a href="/v1.11/client-server-api/#stripped-state">stripped state events</a>
to help the receiver of the invite identify the room.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The version of the room where the user is being invited to.</td>
 </tr>
</table>
<table id="put_matrixfederationv2inviteroomideventid_request_inviteevent" class="object-table">
 <caption>InviteEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv2inviteroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event, matching what is available in the
<a href="/v1.11/client-server-api/">Client-Server API</a>. Must include a <code>membership</code> of <code>invite</code>.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The matrix ID of the user who sent the original <code>m.room.third_party_invite</code>.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the invited member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv2inviteroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>invite</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv2inviteroomideventid_request_strippedstateevent" class="object-table">
 <caption>StrippedStateEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@joe:elsewhere.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;invite_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The event with the invited server&rsquo;s signature added. All other fields of the events
should remain untouched. Note that events have a different format depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td><p>The request is invalid or the room the server is attempting
to join has a version that is not listed in the <code>ver</code>
parameters.</p>
<p>The error should be passed through to clients so that they
may give better feedback to users.</p>
</td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td><p>The invite is not allowed. This could be for a number of reasons, including:</p>
<ul>
<li>The sender is not allowed to send invites to the target user/homeserver.</li>
<li>The homeserver does not permit anyone to invite its users.</li>
<li>The homeserver refuses to participate in the room.</li>
</ul></td>
 </tr>
</table>
<h3>200 response</h3>
<table id="put_matrixfederationv2inviteroomideventid_response-200_event-container" class="object-table">
 <caption>Event Container</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#put_matrixfederationv2inviteroomideventid_response-200_inviteevent">InviteEvent</a></code></td>
  <td>
    <strong>Required: </strong>An invite event. Note that events have a different format depending on the
room version - check the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.</td>
 </tr>
</table>
<table id="put_matrixfederationv2inviteroomideventid_response-200_inviteevent" class="object-table">
 <caption>InviteEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv2inviteroomideventid_response-200_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event, matching what is available in the
<a href="/v1.11/client-server-api/">Client-Server API</a>. Must include a <code>membership</code> of <code>invite</code>.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the inviting homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The matrix ID of the user who sent the original <code>m.room.third_party_invite</code>.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the invited member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv2inviteroomideventid_response-200_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>invite</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;elsewhere.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:k3y_versi0n&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeOtherSignatureHere&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:key_version&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeSignatureHere&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;invite_room_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Example Room&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.name&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.join_rules&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>400 response</h3>
<table id="put_matrixfederationv2inviteroomideventid_response-400_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room. Required if the <code>errcode</code>
is <code>M_INCOMPATIBLE_ROOM_VERSION</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_INCOMPATIBLE_ROOM_VERSION&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Your homeserver does not support the features required to join this room&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;3&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="put_matrixfederationv2inviteroomideventid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;User cannot invite the target user.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="leaving-rooms-rejecting-invites">Leaving Rooms (Rejecting Invites)</h2>
<p>Normally homeservers can send appropriate <code>m.room.member</code> events to have
users leave the room, to reject local invites, or to retract a knock.
Remote invites/knocks from other homeservers do not involve the server in the
graph and therefore need another approach to reject the invite. Joining
the room and promptly leaving is not recommended as clients and servers will
interpret that as accepting the invite, then leaving the room rather
than rejecting the invite.</p>
<p>Similar to the <a href="/v1.11/server-server-api/#joining-rooms">Joining Rooms</a> handshake, the server
which wishes to leave the room starts with sending a <code>/make_leave</code>
request to a resident server. In the case of rejecting invites, the
resident server may be the server which sent the invite. After receiving
a template event from <code>/make_leave</code>, the leaving server signs the event
and replaces the <code>event_id</code> with its own. This is then sent to the
resident server via <code>/send_leave</code>. The resident server will then send
the event to other servers in the room.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1make_leaveroomiduserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/make_leave/{roomId}/{userId}</span>
  </h1>
</summary>
  <hr/>
<p>Asks the receiving server to return information that the sending
server will need to prepare a leave event to get out of the room.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be left.</td>
 </tr>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID the leave event will be for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A template to be used to call <code>/send_leave</code>. Note that
events have a different format depending on the room version - check the
<a href="/v1.11/rooms/">room version specification</a> for precise event formats. <strong>The response body
here describes the common event fields in more detail and may be missing other
required fields for a PDU.</strong></td>
 </tr>
 <tr>
  <td><code>403</code></td>
  <td>The request is not authorized. This could mean that the user is not in the room.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>event</code></td>
  <td><code><a href="#get_matrixfederationv1make_leaveroomiduserid_response-200_event-template">Event Template</a></code></td>
  <td>
    An unsigned template event. Note that events have a different format
depending on the room version - check the <a href="/v1.11/rooms/">room version specification</a>
for precise event formats.</td>
 </tr>
 <tr>
  <td><code>room_version</code></td>
  <td><code>string</code></td>
  <td>
    The version of the room where the server is trying to leave. If not provided,
the room version is assumed to be either &ldquo;1&rdquo; or &ldquo;2&rdquo;.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_leaveroomiduserid_response-200_event-template" class="object-table">
 <caption>Event Template</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#get_matrixfederationv1make_leaveroomiduserid_response-200_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the resident homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="get_matrixfederationv1make_leaveroomiduserid_response-200_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>leave</code>.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;event&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;leave&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1549041175876</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_version&#34;</span><span class="p">:</span> <span class="s2">&#34;2&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>403 response</h3>
<table id="get_matrixfederationv1make_leaveroomiduserid_response-403_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_FORBIDDEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;User is not in the room.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1send_leaveroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint deprecated-inline">/_matrix/federation/v1/send_leave/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<div class="alert warning omit-title" role="alert">
This API is deprecated and will be removed from a future release.
</div>
<p><strong>Note:</strong>
Servers should instead prefer to use the v2 <code>/send_leave</code> endpoint.</p>
<p>Submits a signed leave event to the resident server for it
to accept it into the room&rsquo;s graph. Note that events have
a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the leave event.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be left.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1send_leaveroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>depth</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>This field must be present but is ignored; it may be 0.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the leaving homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the leaving homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv1send_leaveroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>leave</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;leave&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;depth&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An empty response to indicate the event was accepted into the graph by
the receiving homeserver.</td>
 </tr>
</table>
<h3>200 response</h3>
<p>Array of <code>integer, Empty Object</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="mi">200</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv2send_leaveroomideventid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v2/send_leave/{roomId}/{eventId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Note:</strong>
This API is nearly identical to the v1 API with the
exception of the response format being fixed.</p>
<p>This endpoint is preferred over the v1 API as it provides
a more standardised response format. Senders which receive
a 400, 404, or other status code which indicates this endpoint
is not available should retry using the v1 API instead.</p>
<p>Submits a signed leave event to the resident server for it
to accept it into the room&rsquo;s graph. Note that events have
a different format depending on the room version - check
the <a href="/v1.11/rooms/">room version specification</a> for precise event formats.
<strong>The request and response body here describe the common
event fields in more detail and may be missing other required
fields for a PDU.</strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>eventId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event ID for the leave event.</td>
 </tr>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID that is about to be left.</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv2send_leaveroomideventid_request_membership-event-content">Membership Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The content of the event.</td>
 </tr>
 <tr>
  <td><code>depth</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>This field must be present but is ignored; it may be 0.</td>
 </tr>
 <tr>
  <td><code>origin</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The name of the leaving homeserver.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A timestamp added by the leaving homeserver.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the leaving member.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>m.room.member</code>.</td>
 </tr>
</table>
<table id="put_matrixfederationv2send_leaveroomideventid_request_membership-event-content" class="object-table">
 <caption>Membership Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The value <code>leave</code>.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;leave&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;depth&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin&#34;</span><span class="p">:</span> <span class="s2">&#34;matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1234567890</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>An empty response to indicate the event was accepted into the graph by
the receiving homeserver.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="third-party-invites">Third-party invites</h2>
<div class="alert note " role="alert">
More information about third-party invites is available in the
<a href="/v1.11/client-server-api/">Client-Server API</a> under
the Third-party Invites module.
</div>
<p>When a user wants to invite another user in a room but doesn&rsquo;t know the
Matrix ID to invite, they can do so using a third-party identifier (e.g.
an e-mail or a phone number).</p>
<p>This identifier and its bindings to Matrix IDs are verified by an
identity server implementing the <a href="/v1.11/identity-service-api/">Identity Service
API</a>.</p>
<h3 id="cases-where-an-association-exists-for-a-third-party-identifier">Cases where an association exists for a third-party identifier</h3>
<p>If the third-party identifier is already bound to a Matrix ID, a lookup
request on the identity server will return it. The invite is then
processed by the inviting homeserver as a standard <code>m.room.member</code>
invite event. This is the simplest case.</p>
<h3 id="cases-where-an-association-doesnt-exist-for-a-third-party-identifier">Cases where an association doesn&rsquo;t exist for a third-party identifier</h3>
<p>If the third-party identifier isn&rsquo;t bound to any Matrix ID, the inviting
homeserver will request the identity server to store an invite for this
identifier and to deliver it to whoever binds it to its Matrix ID. It
will also send an <code>m.room.third_party_invite</code> event in the room to
specify a display name, a token and public keys the identity server
provided as a response to the invite storage request.</p>
<p>When a third-party identifier with pending invites gets bound to a
Matrix ID, the identity server will send a POST request to the ID&rsquo;s
homeserver as described in the <a href="/v1.11/identity-service-api/#invitation-storage">Invitation
Storage</a>
section of the Identity Service API.</p>
<p>The following process applies for each invite sent by the identity
server:</p>
<p>The invited homeserver will create an <code>m.room.member</code> invite event
containing a special <code>third_party_invite</code> section containing the token
and a signed object, both provided by the identity server.</p>
<p>If the invited homeserver is in the room the invite came from, it can
auth the event and send it.</p>
<p>However, if the invited homeserver isn&rsquo;t in the room the invite came
from, it will need to request the room&rsquo;s homeserver to auth the event.</p>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv13pidonbind">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v1/3pid/onbind</span>
  </h1>
</summary>
  <hr/>
<p>Used by identity servers to notify the homeserver that one of its users
has bound a third-party identifier successfully, including any pending
room invites the identity server has been made aware of.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The third-party identifier itself. For example, an email address.</td>
 </tr>
 <tr>
  <td><code>invites</code></td>
  <td><code>[<a href="#put_matrixfederationv13pidonbind_request_third-party-invite">Third-party Invite</a>]</code></td>
  <td>
    <strong>Required: </strong>A list of pending invites that the third-party identifier has received.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of third-party identifier. Currently only &ldquo;email&rdquo; is
a possible value.</td>
 </tr>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user that is now bound to the third-party identifier.</td>
 </tr>
</table>
<table id="put_matrixfederationv13pidonbind_request_third-party-invite" class="object-table">
 <caption>Third-party Invite</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>address</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The third-party identifier that received the invite.</td>
 </tr>
 <tr>
  <td><code>medium</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of third-party invite issues. Currently only
&ldquo;email&rdquo; is used.</td>
 </tr>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The now-bound user ID that received the invite.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID the invite is valid for.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID that sent the invite.</td>
 </tr>
 <tr>
  <td><code>signed</code></td>
  <td><code><a href="#put_matrixfederationv13pidonbind_request_identity-server-signatures">Identity Server Signatures</a></code></td>
  <td>
    <strong>Required: </strong>Signature from the identity server using a long-term private
key.</td>
 </tr>
</table>
<table id="put_matrixfederationv13pidonbind_request_identity-server-signatures" class="object-table">
 <caption>Identity Server Signatures</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID that has been bound to the third-party
identifier.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: <a href="#put_matrixfederationv13pidonbind_request_identity-server-domain-signature">Identity Server Domain Signature</a>}</code></td>
  <td>
    <strong>Required: </strong>The signature from the identity server. The <code>string</code> key
is the identity server&rsquo;s domain name, such as vector.im</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A token.</td>
 </tr>
</table>
<table id="put_matrixfederationv13pidonbind_request_identity-server-domain-signature" class="object-table">
 <caption>Identity Server Domain Signature</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>ed25519:0</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The signature.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="72131e1b111732170a131f021e175c111d1f">[email&#160;protected]</a>&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;invites&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;address&#34;</span><span class="p">:</span> <span class="s2">&#34;<a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="87e6ebeee4e2c7e2ffe6eaf7ebe2a9e4e8ea">[email&#160;protected]</a>&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@bob:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signed&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;vector.im&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:0&#34;</span><span class="p">:</span> <span class="s2">&#34;SomeSignatureGoesHere&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello World&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;medium&#34;</span><span class="p">:</span> <span class="s2">&#34;email&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The homeserver has processed the notification.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api PUT">
<details open>
<summary>
  <h1 id="put_matrixfederationv1exchange_third_party_inviteroomid">
   <span class="http-api-method PUT">PUT</span>
   <span class="endpoint">/_matrix/federation/v1/exchange_third_party_invite/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p>The receiving server will verify the partial <code>m.room.member</code> event
given in the request body. If valid, the receiving server will issue
an invite as per the <a href="/v1.11/server-server-api/#inviting-to-a-room">Inviting to a room</a> section before returning a
response to this request.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID to exchange a third-party invite in</td>
 </tr>
</table>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#put_matrixfederationv1exchange_third_party_inviteroomid_request_event-content">Event Content</a></code></td>
  <td>
    <strong>Required: </strong>The event content</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID the event is for. Must match the ID given in
the path.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the user who sent the original <code>m.room.third_party_invite</code>
event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID of the invited user</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The event type. Must be <code>m.room.member</code></td>
 </tr>
</table>
<table id="put_matrixfederationv1exchange_third_party_inviteroomid_request_event-content" class="object-table">
 <caption>Event Content</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>membership</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The membership state. Must be <code>invite</code></td>
 </tr>
 <tr>
  <td><code>third_party_invite</code></td>
  <td><code><a href="#put_matrixfederationv1exchange_third_party_inviteroomid_request_third-party-invite">Third-party Invite</a></code></td>
  <td>
    <strong>Required: </strong>The third-party invite</td>
 </tr>
</table>
<table id="put_matrixfederationv1exchange_third_party_inviteroomid_request_third-party-invite" class="object-table">
 <caption>Third-party Invite</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>display_name</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>A name which can be displayed to represent the user instead of their
third-party identifier.</td>
 </tr>
 <tr>
  <td><code>signed</code></td>
  <td><code><a href="#put_matrixfederationv1exchange_third_party_inviteroomid_request_invite-signatures">Invite Signatures</a></code></td>
  <td>
    <strong>Required: </strong>A block of content which has been signed, which servers can use to
verify the event.</td>
 </tr>
</table>
<table id="put_matrixfederationv1exchange_third_party_inviteroomid_request_invite-signatures" class="object-table">
 <caption>Invite Signatures</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>mxid</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The invited matrix user ID</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <strong>Required: </strong><p>The server signatures for this event.</p>
<p>The signature is calculated using the process
described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The token used to verify the event</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;membership&#34;</span><span class="p">:</span> <span class="s2">&#34;invite&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;third_party_invite&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;alice&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signed&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;mxid&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;magic.forest&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:3&#34;</span><span class="p">:</span> <span class="s2">&#34;fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;token&#34;</span><span class="p">:</span> <span class="s2">&#34;abc123&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!abc123:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@joe:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;@someone:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room.member&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The invite has been issued successfully.</td>
 </tr>
</table>
<h3>200 response</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{}</span>
</span></span></code></pre></div></details>
</section>
<h4 id="verifying-the-invite">Verifying the invite</h4>
<p>When a homeserver receives an <code>m.room.member</code> invite event for a room
it&rsquo;s in with a <code>third_party_invite</code> object, it must verify that the
association between the third-party identifier initially invited to the
room and the Matrix ID that claims to be bound to it has been verified
without having to rely on a third-party server.</p>
<p>To do so, it will fetch from the room&rsquo;s state events the
<code>m.room.third_party_invite</code> event for which the state key matches with
the value for the <code>token</code> key in the <code>third_party_invite</code> object from
the <code>m.room.member</code> event&rsquo;s content to fetch the public keys initially
delivered by the identity server that stored the invite.</p>
<p>It will then use these keys to verify that the <code>signed</code> object (in the
<code>third_party_invite</code> object from the <code>m.room.member</code> event&rsquo;s content)
was signed by the same identity server.</p>
<p>Since this <code>signed</code> object can only be delivered once in the POST
request emitted by the identity server upon binding between the
third-party identifier and the Matrix ID, and contains the invited
user&rsquo;s Matrix ID and the token delivered when the invite was stored,
this verification will prove that the <code>m.room.member</code> invite event comes
from the user owning the invited third-party identifier.</p>
<h2 id="public-room-directory">Public Room Directory</h2>
<p>To complement the <a href="/v1.11/client-server-api/">Client-Server
API</a>&rsquo;s room directory,
homeservers need a way to query the public rooms for another server.
This can be done by making a request to the <code>/publicRooms</code> endpoint for
the server the room directory should be retrieved for.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1publicrooms">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/publicRooms</span>
  </h1>
</summary>
  <hr/>
<p>Gets all the public rooms for the homeserver. This should not return
rooms that are listed on another homeserver&rsquo;s directory, just those
listed on the receiving homeserver&rsquo;s directory.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>include_all_networks</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether or not to include all networks/protocols defined by application
services on the homeserver. Defaults to false.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of rooms to return. Defaults to 0 (no limit).</td>
 </tr>
 <tr>
  <td><code>since</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous call to this endpoint to fetch more
rooms.</td>
 </tr>
 <tr>
  <td><code>third_party_instance_id</code></td>
  <td><code>string</code></td>
  <td>
    The specific third-party network/protocol to request from the homeserver.
Can only be used if <code>include_all_networks</code> is false.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The public room list for the homeserver.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[<a href="#get_matrixfederationv1publicrooms_response-200_publicroomschunk">PublicRoomsChunk</a>]</code></td>
  <td>
    <strong>Required: </strong>A paginated chunk of public rooms.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token for the response. The absence of this token
means there are no more results to fetch and the client should
stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token that allows fetching previous results. The
absence of this token means there are no results before this
batch, i.e. this is the first batch.</td>
 </tr>
 <tr>
  <td><code>total_room_count_estimate</code></td>
  <td><code>integer</code></td>
  <td>
    An estimate on the total number of public rooms, if the
server has an estimate.</td>
 </tr>
</table>
<table id="get_matrixfederationv1publicrooms_response-200_publicroomschunk" class="object-table">
 <caption>PublicRoomsChunk</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code><a href="http://tools.ietf.org/html/rfc3986">URI</a></code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>. Note that rooms with <code>invite</code> join rules are not
expected here, but rooms with <code>knock</code> rules are given their
near-public nature.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/v1.11/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://bleecker.street/CHEDDARandBRIE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CHEESE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!ol19s:bleecker.street&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Tasty tasty cheese&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p190q&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p1902&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;total_room_count_estimate&#34;</span><span class="p">:</span> <span class="mi">115</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixfederationv1publicrooms">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/federation/v1/publicRooms</span>
  </h1>
</summary>
  <hr/>
<p>Lists the public rooms on the server, with optional filter.</p>
<p>This API returns paginated responses. The rooms are ordered by the number
of joined members, with the largest rooms first.</p>
<p>Note that this endpoint receives and returns the same format that is seen
in the Client-Server API&rsquo;s <code>POST /publicRooms</code> endpoint.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>filter</code></td>
  <td><code><a href="#post_matrixfederationv1publicrooms_request_filter">Filter</a></code></td>
  <td>
    Filter to apply to the results.</td>
 </tr>
 <tr>
  <td><code>include_all_networks</code></td>
  <td><code>boolean</code></td>
  <td>
    Whether or not to include all known networks/protocols from
application services on the homeserver. Defaults to false.</td>
 </tr>
 <tr>
  <td><code>limit</code></td>
  <td><code>integer</code></td>
  <td>
    Limit the number of results returned.</td>
 </tr>
 <tr>
  <td><code>since</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token from a previous request, allowing servers
to get the next (or previous) batch of rooms.  The direction
of pagination is specified solely by which token is supplied,
rather than via an explicit flag.</td>
 </tr>
 <tr>
  <td><code>third_party_instance_id</code></td>
  <td><code>string</code></td>
  <td>
    The specific third-party network/protocol to request from the
homeserver. Can only be used if <code>include_all_networks</code> is false.</td>
 </tr>
</table>
<table id="post_matrixfederationv1publicrooms_request_filter" class="object-table">
 <caption>Filter</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>generic_search_term</code></td>
  <td><code>string</code></td>
  <td>
    An optional string to search for in the room metadata, e.g. name,
topic, canonical alias, etc.</td>
 </tr>
 <tr>
  <td><code>room_types</code></td>
  <td><code>[string|null]</code></td>
  <td>
    An optional list of <a href="/v1.11/client-server-api/#types">room types</a> to search
for. To include rooms without a room type, specify <code>null</code> within this
list. When not specified, all applicable rooms (regardless of type)
are returned.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;filter&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;generic_search_term&#34;</span><span class="p">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_types&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;m.space&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;include_all_networks&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;third_party_instance_id&#34;</span><span class="p">:</span> <span class="s2">&#34;irc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A list of the rooms on the server.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>chunk</code></td>
  <td><code>[<a href="#post_matrixfederationv1publicrooms_response-200_publicroomschunk">PublicRoomsChunk</a>]</code></td>
  <td>
    <strong>Required: </strong>A paginated chunk of public rooms.</td>
 </tr>
 <tr>
  <td><code>next_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token for the response. The absence of this token
means there are no more results to fetch and the client should
stop paginating.</td>
 </tr>
 <tr>
  <td><code>prev_batch</code></td>
  <td><code>string</code></td>
  <td>
    A pagination token that allows fetching previous results. The
absence of this token means there are no results before this
batch, i.e. this is the first batch.</td>
 </tr>
 <tr>
  <td><code>total_room_count_estimate</code></td>
  <td><code>integer</code></td>
  <td>
    An estimate on the total number of public rooms, if the
server has an estimate.</td>
 </tr>
</table>
<table id="post_matrixfederationv1publicrooms_response-200_publicroomschunk" class="object-table">
 <caption>PublicRoomsChunk</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code><a href="http://tools.ietf.org/html/rfc3986">URI</a></code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>. Note that rooms with <code>invite</code> join rules are not
expected here, but rooms with <code>knock</code> rules are given their
near-public nature.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/v1.11/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;chunk&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://bleecker.street/CHEDDARandBRIE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;CHEESE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!ol19s:bleecker.street&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Tasty tasty cheese&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;next_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p190q&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;prev_batch&#34;</span><span class="p">:</span> <span class="s2">&#34;p1902&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;total_room_count_estimate&#34;</span><span class="p">:</span> <span class="mi">115</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="spaces">Spaces</h2>
<p>To complement the <a href="/v1.11/client-server-api/#spaces">Client-Server API&rsquo;s Spaces module</a>,
homeservers need a way to query information about spaces from other servers.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1hierarchyroomid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/hierarchy/{roomId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.2</code></strong></p>
<p>Federation version of the Client-Server <a href="/v1.11/client-server-api/#get_matrixclientv1roomsroomidhierarchy"><code>GET /hierarchy</code></a>
endpoint. Unlike the Client-Server API version, this endpoint does not paginate. Instead, all
the space-room&rsquo;s children the requesting server could feasibly peek/join are returned. The
requesting server is responsible for filtering the results further down for the user&rsquo;s request.</p>
<p>Only <a href="/v1.11/client-server-api/#mspacechild"><code>m.space.child</code></a> state events of the room are considered. Invalid child
rooms and parent events are not covered by this endpoint.</p>
<p>Responses to this endpoint should be cached for a period of time.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>roomId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID of the space to get a hierarchy for.</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>suggested_only</code></td>
  <td><code>boolean</code></td>
  <td>
    Optional (default <code>false</code>) flag to indicate whether or not the server should only consider
suggested rooms. Suggested rooms are annotated in their <a href="/v1.11/client-server-api/#mspacechild"><code>m.space.child</code></a> event
contents.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The space room and its children.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room is not known to the server or the requesting server is unable to peek/join
it (if it were to attempt this).</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>children</code></td>
  <td><code>[<a href="#get_matrixfederationv1hierarchyroomid_response-200_spacehierarchychildroomschunk">SpaceHierarchyChildRoomsChunk</a>]</code></td>
  <td>
    <strong>Required: </strong>A summary of the space&rsquo;s children. Rooms which the requesting server cannot peek/join will
be excluded.</td>
 </tr>
 <tr>
  <td><code>inaccessible_children</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong><p>The list of room IDs the requesting server doesn&rsquo;t have a viable way to peek/join. Rooms which
the responding server cannot provide details on will be outright excluded from the response instead.</p>
<p>Assuming both the requesting and responding server are well behaved, the requesting server should
consider these room IDs as not accessible from anywhere. They should not be re-requested.</p>
</td>
 </tr>
 <tr>
  <td><code>room</code></td>
  <td><code><a href="#get_matrixfederationv1hierarchyroomid_response-200_spacehierarchyparentroom">SpaceHierarchyParentRoom</a></code></td>
  <td>
    <strong>Required: </strong>A summary of the room requested.</td>
 </tr>
</table>
<table id="get_matrixfederationv1hierarchyroomid_response-200_spacehierarchychildroomschunk" class="object-table">
 <caption>SpaceHierarchyChildRoomsChunk</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>allowed_room_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    If the room is a <a href="/v1.11/#restricted-rooms">restricted room</a>, these are the room IDs which
are specified by the join rules. Empty or omitted otherwise.</td>
 </tr>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code><a href="http://tools.ietf.org/html/rfc3986">URI</a></code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/v1.11/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<table id="get_matrixfederationv1hierarchyroomid_response-200_spacehierarchyparentroom" class="object-table">
 <caption>SpaceHierarchyParentRoom</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>allowed_room_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    If the room is a <a href="/v1.11/#restricted-rooms">restricted room</a>, these are the room IDs which
are specified by the join rules. Empty or omitted otherwise.</td>
 </tr>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code><a href="http://tools.ietf.org/html/rfc3986">URI</a></code></td>
  <td>
    The URL for the room&rsquo;s avatar, if one is set.</td>
 </tr>
 <tr>
  <td><code>canonical_alias</code></td>
  <td><code>string</code></td>
  <td>
    The canonical alias of the room, if any.</td>
 </tr>
 <tr>
  <td><code>children_state</code></td>
  <td><code>[<a href="#get_matrixfederationv1hierarchyroomid_response-200_strippedstateevent">StrippedStateEvent</a>]</code></td>
  <td>
    <strong>Required: </strong><p>The <a href="/v1.11/client-server-api/#mspacechild"><code>m.space.child</code></a> events of the space-room, represented
as <a href="/v1.11/client-server-api/#stripped-state">Stripped State Events</a> with an added
<code>origin_server_ts</code> key.</p>
<p>If the room is not a space-room, this should be empty.</p>
</td>
 </tr>
 <tr>
  <td><code>guest_can_join</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether guest users may join the room and participate in it.
If they can, they will be subject to ordinary power level
rules like any other user.</td>
 </tr>
 <tr>
  <td><code>join_rule</code></td>
  <td><code>string</code></td>
  <td>
    The room&rsquo;s join rule. When not present, the room is assumed to
be <code>public</code>.</td>
 </tr>
 <tr>
  <td><code>name</code></td>
  <td><code>string</code></td>
  <td>
    The name of the room, if any.</td>
 </tr>
 <tr>
  <td><code>num_joined_members</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of members joined to the room.</td>
 </tr>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the room.</td>
 </tr>
 <tr>
  <td><code>room_type</code></td>
  <td><code>string</code></td>
  <td>
    The <code>type</code> of room (from <a href="/v1.11/client-server-api/#mroomcreate"><code>m.room.create</code></a>), if any.
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>topic</code></td>
  <td><code>string</code></td>
  <td>
    The topic of the room, if any.</td>
 </tr>
 <tr>
  <td><code>world_readable</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the room may be viewed by guest users without joining.</td>
 </tr>
</table>
<table id="get_matrixfederationv1hierarchyroomid_response-200_strippedstateevent" class="object-table">
 <caption>StrippedStateEvent</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>EventContent</code></td>
  <td>
    <strong>Required: </strong>The <code>content</code> for the event.</td>
 </tr>
 <tr>
  <td><code>origin_server_ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <code>origin_server_ts</code> for the event.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>sender</code> for the event.</td>
 </tr>
 <tr>
  <td><code>state_key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>state_key</code> for the event.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The <code>type</code> for the event.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;allowed_room_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;!upstream:example.org&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/abcdef2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;canonical_alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#general:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;children_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;remote.example.org&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">]</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1629422222222</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!b:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;restricted&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The ~~First~~ Second Space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!second_room:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;Hello world&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;inaccessible_children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;!secret:example.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;allowed_room_ids&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://example.org/abcdef&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;canonical_alias&#34;</span><span class="p">:</span> <span class="s2">&#34;#general:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children_state&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;via&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;remote.example.org&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;origin_server_ts&#34;</span><span class="p">:</span> <span class="mi">1629413349153</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;state_key&#34;</span><span class="p">:</span> <span class="s2">&#34;!a:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space.child&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;guest_can_join&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;join_rule&#34;</span><span class="p">:</span> <span class="s2">&#34;public&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;The First Space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;num_joined_members&#34;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!space:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.space&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;topic&#34;</span><span class="p">:</span> <span class="s2">&#34;No other spaces were created first, ever&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;world_readable&#34;</span><span class="p">:</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1hierarchyroomid_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room does not exist.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="typing-notifications">Typing Notifications</h2>
<p>When a server&rsquo;s users send typing notifications, those notifications
need to be sent to other servers in the room so their users are aware of
the same state. Receiving servers should verify that the user is in the
room, and is a user belonging to the sending server.</p>
<section class="rendered-data definition" id="definition-mtyping">
<details open>
<summary>
<h1>
 <code>m.typing</code>
</h1>
</summary>
<hr/>
<p>A typing notification EDU for a user in a room.</p>
<table id="definition-mtyping_mtyping" class="object-table">
 <caption>m.typing</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#definition-mtyping_typing-notification">Typing Notification</a></code></td>
  <td>
    <strong>Required: </strong>The typing notification.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.typing</code><p>One of: <code>[m.typing]</code>.</p></td>
 </tr>
</table>
<table id="definition-mtyping_typing-notification" class="object-table">
 <caption>Typing Notification</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room where the user&rsquo;s typing status has been updated.</td>
 </tr>
 <tr>
  <td><code>typing</code></td>
  <td><code>boolean</code></td>
  <td>
    <strong>Required: </strong>Whether the user is typing in the room or not.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID that has had their typing status changed.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!somewhere:matrix.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;typing&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@john:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.typing&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="presence">Presence</h2>
<p>The server API for presence is based entirely on exchange of the
following EDUs. There are no PDUs or Federation Queries involved.</p>
<p>Servers should only send presence updates for users that the receiving
server would be interested in. Such as the receiving server sharing a
room with a given user.</p>
<section class="rendered-data definition" id="definition-mpresence">
<details open>
<summary>
<h1>
 <code>m.presence</code>
</h1>
</summary>
<hr/>
<p>An EDU representing presence updates for users of the sending homeserver.</p>
<table id="definition-mpresence_mpresence" class="object-table">
 <caption>m.presence</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#definition-mpresence_presence-update">Presence Update</a></code></td>
  <td>
    <strong>Required: </strong>The presence updates and requests.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.presence</code><p>One of: <code>[m.presence]</code>.</p></td>
 </tr>
</table>
<table id="definition-mpresence_presence-update" class="object-table">
 <caption>Presence Update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>push</code></td>
  <td><code>[<a href="#definition-mpresence_user-presence-update">User Presence Update</a>]</code></td>
  <td>
    <strong>Required: </strong>A list of presence updates that the receiving server is likely
to be interested in.</td>
 </tr>
</table>
<table id="definition-mpresence_user-presence-update" class="object-table">
 <caption>User Presence Update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>currently_active</code></td>
  <td><code>boolean</code></td>
  <td>
    True if the user is likely to be interacting with their
client. This may be indicated by the user having a
<code>last_active_ago</code> within the last few minutes. Defaults
to false.</td>
 </tr>
 <tr>
  <td><code>last_active_ago</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The number of milliseconds that have elapsed since the user
last did something.</td>
 </tr>
 <tr>
  <td><code>presence</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The presence of the user.<p>One of: <code>[offline, unavailable, online]</code>.</p></td>
 </tr>
 <tr>
  <td><code>status_msg</code></td>
  <td><code>string</code></td>
  <td>
    An optional description to accompany the presence.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID this presence EDU is for.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;push&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;currently_active&#34;</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;last_active_ago&#34;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;presence&#34;</span><span class="p">:</span> <span class="s2">&#34;online&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;status_msg&#34;</span><span class="p">:</span> <span class="s2">&#34;Making cupcakes&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@john:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.presence&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="receipts">Receipts</h2>
<p>Receipts are EDUs used to communicate a marker for a given event.
Currently the only kind of receipt supported is a &ldquo;read receipt&rdquo;, or
where in the event graph the user has read up to.</p>
<p>Read receipts for events that a user sent do not need to be sent. It is
implied that by sending the event the user has read up to the event.</p>
<section class="rendered-data definition" id="definition-mreceipt">
<details open>
<summary>
<h1>
 <code>m.receipt</code>
</h1>
</summary>
<hr/>
<p>An EDU representing receipt updates for users of the sending homeserver.
When receiving receipts, the server should only update entries that are
listed in the EDU. Receipts previously received that do not appear in the
EDU should not be removed or otherwise manipulated.</p>
<table id="definition-mreceipt_mreceipt" class="object-table">
 <caption>m.receipt</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code>{<a href="/v1.11/appendices#room-ids">Room ID</a>: <a href="#definition-mreceipt_room-receipts">Room Receipts</a>}</code></td>
  <td>
    <strong>Required: </strong>Receipts for a particular room. The string key is the room ID for
which the receipts under it belong.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.receipt</code><p>One of: <code>[m.receipt]</code>.</p></td>
 </tr>
</table>
<table id="definition-mreceipt_room-receipts" class="object-table">
 <caption>Room Receipts</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>m.read</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: <a href="#definition-mreceipt_user-read-receipt">User Read Receipt</a>}</code></td>
  <td>
    <strong>Required: </strong>Read receipts for users in the room. The string key is the user
ID the receipt belongs to.</td>
 </tr>
</table>
<table id="definition-mreceipt_user-read-receipt" class="object-table">
 <caption>User Read Receipt</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>data</code></td>
  <td><code><a href="#definition-mreceipt_read-receipt-metadata">Read Receipt Metadata</a></code></td>
  <td>
    <strong>Required: </strong>Metadata for the read receipt.</td>
 </tr>
 <tr>
  <td><code>event_ids</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The extremity event IDs that the user has read up to.</td>
 </tr>
</table>
<table id="definition-mreceipt_read-receipt-metadata" class="object-table">
 <caption>Read Receipt Metadata</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>thread_id</code></td>
  <td><code>string</code></td>
  <td>
    The root thread event&rsquo;s ID (or <code>main</code>) for which
thread this receipt is intended to be under. If
not specified, the read receipt is <em>unthreaded</em>
(default).
<p><strong>Added in <code>v1.4</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>ts</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A POSIX timestamp in milliseconds for when the user read
the event specified in the read receipt.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;!some_room:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;m.read&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@john:matrix.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ts&#34;</span><span class="p">:</span> <span class="mi">1533358089009</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;event_ids&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;$read_this_event:matrix.org&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.receipt&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="querying-for-information">Querying for information</h2>
<p>Queries are a way to retrieve information from a homeserver about a
resource, such as a user or room. The endpoints here are often called in
conjunction with a request from a client on the client-server API in
order to complete the call.</p>
<p>There are several types of queries that can be made. The generic
endpoint to represent all queries is described first, followed by the
more specific queries that can be made.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1querydirectory">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/query/directory</span>
  </h1>
</summary>
  <hr/>
<p>Performs a query to get the mapped room ID and list of resident homeservers in
the room for a given room alias. Homeservers should only query room aliases
that belong to the target server (identified by the DNS Name in the alias).</p>
<p>Servers may wish to cache the response to this query to avoid requesting the
information too often.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>room_alias</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room alias to query.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The corresponding room ID and list of known resident homeservers for the room.</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The room alias was not found.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>room_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The room ID mapped to the queried room alias.</td>
 </tr>
 <tr>
  <td><code>servers</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>An array of server names that are likely to hold the given room. This
list may or may not include the server answering the query.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!roomid1234:example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;servers&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;another.example.com:8449&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1querydirectory_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Room alias not found.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1queryprofile">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/query/profile</span>
  </h1>
</summary>
  <hr/>
<p>Performs a query to get profile information, such as a display name or avatar,
for a given user. Homeservers should only query profiles for users that belong
to the target server (identified by the DNS Name in the user ID).</p>
<p>Servers may wish to cache the response to this query to avoid requesting the
information too often.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>field</code></td>
  <td><code>string</code></td>
  <td>
    The field to query. If specified, the server will only return the given field
in the response. If not specified, the server will return the full profile for
the user.<p>One of: <code>[displayname, avatar_url]</code>.</p></td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID to query. Must be a user local to the receiving homeserver.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td><p>The profile for the user. If a <code>field</code> is specified in the request, only the
matching field should be included in the response. If no <code>field</code> was specified,
the response should include the fields of the user&rsquo;s profile that can be made
public, such as the display name and avatar.</p>
<p>If the user does not have a particular field set on their profile, the server
should exclude it from the response body or give it the value <code>null</code>.</p>
</td>
 </tr>
 <tr>
  <td><code>404</code></td>
  <td>The user does not exist or does not have a profile.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>avatar_url</code></td>
  <td><code>string</code></td>
  <td>
    The avatar URL for the user&rsquo;s avatar. May be omitted if the user does not
have an avatar set.</td>
 </tr>
 <tr>
  <td><code>displayname</code></td>
  <td><code>string</code></td>
  <td>
    The display name of the user. May be omitted if the user does not have a
display name set.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;avatar_url&#34;</span><span class="p">:</span> <span class="s2">&#34;mxc://matrix.org/MyC00lAvatar&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;displayname&#34;</span><span class="p">:</span> <span class="s2">&#34;John Doe&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>404 response</h3>
<table id="get_matrixfederationv1queryprofile_response-404_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_FOUND&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;User does not exist.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1queryquerytype">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/query/{queryType}</span>
  </h1>
</summary>
  <hr/>
<p>Performs a single query request on the receiving homeserver. The query string
arguments are dependent on which type of query is being made. Known query types
are specified as their own endpoints as an extension to this definition.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>queryType</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The type of query to make</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The query response. The schema varies depending on the query being made.</td>
 </tr>
</table>
</details>
</section>
<h2 id="openid">OpenID</h2>
<p>Third-party services can exchange an access token previously generated
by the <span class="title-ref">Client-Server API</span> for information
about a user. This can help verify that a user is who they say they are
without granting full access to the user&rsquo;s account.</p>
<p>Access tokens generated by the OpenID API are only good for the OpenID
API and nothing else.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1openiduserinfo">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/openid/userinfo</span>
  </h1>
</summary>
  <hr/>
<p>Exchanges an OpenID access token for information about the user
who generated the token. Currently this only exposes the Matrix
User ID of the owner.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>No</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>access_token</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The OpenID access token to get information about the owner for.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>Information about the user who generated the OpenID access token.</td>
 </tr>
 <tr>
  <td><code>401</code></td>
  <td>The token was not recognized or has expired.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>sub</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The Matrix User ID who generated the token.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;sub&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>401 response</h3>
<table id="get_matrixfederationv1openiduserinfo_response-401_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN_TOKEN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Access token unknown or expired&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="device-management">Device Management</h2>
<p>Details of a user&rsquo;s devices must be efficiently published to other users
and kept up-to-date. This is critical for reliable end-to-end
encryption, in order for users to know which devices are participating
in a room. It&rsquo;s also required for to-device messaging to work. This
section is intended to complement the <a href="/v1.11/client-server-api/#device-management">Device Management
module</a>
of the Client-Server API.</p>
<p>Matrix currently uses a custom pubsub system for synchronising
information about the list of devices for a given user over federation.
When a server wishes to determine a remote user&rsquo;s device list for the
first time, it should populate a local cache from the result of a
<code>/user/keys/query</code> API on the remote server. However, subsequent updates
to the cache should be applied by consuming <code>m.device_list_update</code> EDUs.
Each new <code>m.device_list_update</code> EDU describes an incremental change to
one device for a given user which should replace any existing entry in
the local server&rsquo;s cache of that device list. Servers must send
<code>m.device_list_update</code> EDUs to all the servers who share a room with a
given local user, and must be sent whenever that user&rsquo;s device list
changes (i.e. for new or deleted devices, when that user joins a room
which contains servers which are not already receiving updates for that
user&rsquo;s device list, or changes in device information such as the
device&rsquo;s human-readable name).</p>
<p>Servers send <code>m.device_list_update</code> EDUs in a sequence per origin user,
each with a unique <code>stream_id</code>. They also include a pointer to the most
recent previous EDU(s) that this update is relative to in the <code>prev_id</code>
field. To simplify implementation for clustered servers which could send
multiple EDUs at the same time, the <code>prev_id</code> field should include all
<code>m.device_list_update</code> EDUs which have not been yet been referenced in a
EDU. If EDUs are emitted in series by a server, there should only ever
be one <code>prev_id</code> in the EDU.</p>
<p>This forms a simple directed acyclic graph of <code>m.device_list_update</code>
EDUs, showing which EDUs a server needs to have received in order to
apply an update to its local copy of the remote user&rsquo;s device list. If a
server receives an EDU which refers to a <code>prev_id</code> it does not
recognise, it must resynchronise its list by calling the
<code>/user/keys/query API</code> and resume the process. The response contains a
<code>stream_id</code> which should be used to correlate with subsequent
<code>m.device_list_update</code> EDUs.</p>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1userdevicesuserid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/user/devices/{userId}</span>
  </h1>
</summary>
  <hr/>
<p>Gets information on all of the user&rsquo;s devices</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>userId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID to retrieve devices for. Must be a user local to the
receiving homeserver.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The user&rsquo;s devices.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>devices</code></td>
  <td><code>[<a href="#get_matrixfederationv1userdevicesuserid_response-200_user-device">User Device</a>]</code></td>
  <td>
    <strong>Required: </strong>The user&rsquo;s devices. May be empty.</td>
 </tr>
 <tr>
  <td><code>master_key</code></td>
  <td><code><a href="#get_matrixfederationv1userdevicesuserid_response-200_crosssigningkey">CrossSigningKey</a></code></td>
  <td>
    The user's master cross-signing key.</td>
 </tr>
 <tr>
  <td><code>self_signing_key</code></td>
  <td><code><a href="#get_matrixfederationv1userdevicesuserid_response-200_crosssigningkey">CrossSigningKey</a></code></td>
  <td>
    The user's self-signing key.</td>
 </tr>
 <tr>
  <td><code>stream_id</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>A unique ID for a given user_id which describes the version of
the returned device list.  This is matched with the <code>stream_id</code>
field in <code>m.device_list_update</code> EDUs in order to incrementally
update the returned device_list.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID devices were requested for.</td>
 </tr>
</table>
<table id="get_matrixfederationv1userdevicesuserid_response-200_user-device" class="object-table">
 <caption>User Device</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    Optional display name for the device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The device ID.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code><a href="#get_matrixfederationv1userdevicesuserid_response-200_devicekeys">DeviceKeys</a></code></td>
  <td>
    <strong>Required: </strong>Identity keys for the device.</td>
 </tr>
</table>
<table id="get_matrixfederationv1userdevicesuserid_response-200_devicekeys" class="object-table">
 <caption>DeviceKeys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>algorithms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithms supported by this device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device these keys belong to. Must match the device ID used
when logging in.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>Public identity keys. The names of the properties should be in the
format <code>&lt;algorithm&gt;:&lt;device_id&gt;</code>. The keys themselves should be
encoded as specified by the key algorithm.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: string}}</code></td>
  <td>
    <strong>Required: </strong><p>Signatures for the device key object. A map from user ID, to a map from
<code>&lt;algorithm&gt;:&lt;device_id&gt;</code> to the signature.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the device belongs to. Must match the user ID used
when logging in.</td>
 </tr>
</table>
<table id="get_matrixfederationv1userdevicesuserid_response-200_crosssigningkey" class="object-table">
 <caption>CrossSigningKey</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>The public key.  The object must have exactly one property, whose name is
in the form <code>&lt;algorithm&gt;:&lt;unpadded_base64_public_key&gt;</code>, and whose value
is the unpadded base64 public key.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    Signatures of the key, calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.
Optional for the master key. Other keys must be signed by the
user's master key.</td>
 </tr>
 <tr>
  <td><code>usage</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>What the key is used for.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the key belongs to.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;devices&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice&#39;s Mobile Phone&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;curve25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;master_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;self_signing_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ed25519:base64+self+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+self+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+self+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;self_signing&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;stream_id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.org&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data definition" id="definition-mdevice_list_update">
<details open>
<summary>
<h1>
 <code>m.device_list_update</code>
</h1>
</summary>
<hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>An EDU that lets servers push details to each other when one of their users
adds a new device to their account, required for E2E encryption to correctly
target the current set of devices for a given user. This event will also be
sent when an existing device gets a new cross-signing signature.</p>
<table id="definition-mdevice_list_update_mdevice_list_update" class="object-table">
 <caption>m.device_list_update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#definition-mdevice_list_update_device-list-update">Device List Update</a></code></td>
  <td>
    <strong>Required: </strong>The description of the device whose details has changed.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.device_list_update</code>.<p>One of: <code>[m.device_list_update]</code>.</p></td>
 </tr>
</table>
<table id="definition-mdevice_list_update_device-list-update" class="object-table">
 <caption>Device List Update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>deleted</code></td>
  <td><code>boolean</code></td>
  <td>
    True if the server is announcing that this device has been deleted.</td>
 </tr>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    The public human-readable name of this device. Will be absent
if the device has no name.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device whose details are changing.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code><a href="#definition-mdevice_list_update_devicekeys">DeviceKeys</a></code></td>
  <td>
    The updated identity keys (if any) for this device.  May be absent if the
device has no E2E keys defined.</td>
 </tr>
 <tr>
  <td><code>prev_id</code></td>
  <td><code>[integer]</code></td>
  <td>
    The stream_ids of any prior m.device_list_update EDUs sent for this user
which have not been referred to already in an EDU&rsquo;s prev_id field.  If the
receiving server does not recognise any of the prev_ids, it means an EDU
has been lost and the server should query a snapshot of the device list
via <code>/user/keys/query</code> in order to correctly interpret future <code>m.device_list_update</code>
EDUs.  May be missing or empty for the first EDU in a sequence.</td>
 </tr>
 <tr>
  <td><code>stream_id</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>An ID sent by the server for this update, unique for a given
user_id.  Used to identify any gaps in the sequence of <code>m.device_list_update</code>
EDUs broadcast by a server.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID who owns this device.</td>
 </tr>
</table>
<table id="definition-mdevice_list_update_devicekeys" class="object-table">
 <caption>DeviceKeys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>algorithms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithms supported by this device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device these keys belong to. Must match the device ID used
when logging in.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>Public identity keys. The names of the properties should be in the
format <code>&lt;algorithm&gt;:&lt;device_id&gt;</code>. The keys themselves should be
encoded as specified by the key algorithm.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: string}}</code></td>
  <td>
    <strong>Required: </strong><p>Signatures for the device key object. A map from user ID, to a map from
<code>&lt;algorithm&gt;:&lt;device_id&gt;</code> to the signature.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the device belongs to. Must match the user ID used
when logging in.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Mobile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;QBUAZIFURK&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;curve25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;prev_id&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;stream_id&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@john:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.device_list_update&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="end-to-end-encryption">End-to-End Encryption</h2>
<p>This section complements the <a href="/v1.11/client-server-api/#end-to-end-encryption">End-to-End Encryption
module</a>
of the Client-Server API. For detailed information about end-to-end
encryption, please see that module.</p>
<p>The APIs defined here are designed to be able to proxy much of the
client&rsquo;s request through to federation, and have the response also be
proxied through to the client.</p>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixfederationv1userkeysclaim">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/federation/v1/user/keys/claim</span>
  </h1>
</summary>
  <hr/>
<p>Claims one-time keys for use in pre-key messages.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>one_time_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: string}}</code></td>
  <td>
    <strong>Required: </strong>The keys to be claimed. A map from user ID, to a map from
device ID to algorithm name. Requested users must be local
to the receiving homeserver.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;signed_curve25519&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The claimed keys.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>one_time_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: {string: string|<a href="#post_matrixfederationv1userkeysclaim_response-200_keyobject">KeyObject</a>}}}</code></td>
  <td>
    <strong>Required: </strong><p>One-time keys for the queried devices. A map from user ID, to a
map from devices to a map from <code>&lt;algorithm&gt;:&lt;key_id&gt;</code> to the key object.</p>
<p>See the <a href="/v1.11/client-server-api/#key-algorithms">Client-Server Key Algorithms</a> section for more information on
the Key Object format.</p>
</td>
 </tr>
</table>
<table id="post_matrixfederationv1userkeysclaim_response-200_keyobject" class="object-table">
 <caption>KeyObject</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>key</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The key, encoded using unpadded base64.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{string: {string: string}}</code></td>
  <td>
    <strong>Required: </strong><p>Signature of the key object.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;one_time_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signed_curve25519:AAAAHg&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="s2">&#34;zKbLg+NrIjpnagy+pIY6uPL4ZwEG2v+8F9lmgsnlZzs&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;FLWxXqGbwrb8SM3Y795eB6OA8bwBcoMZFXBqnTn58AYWZSqiD45tlBVcDa2L7RwdKXebW/VzDlnfVJ+9jok1Bw&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api POST">
<details open>
<summary>
  <h1 id="post_matrixfederationv1userkeysquery">
   <span class="http-api-method POST">POST</span>
   <span class="endpoint">/_matrix/federation/v1/user/keys/query</span>
  </h1>
</summary>
  <hr/>
<p>Returns the current devices and identity keys for the given users.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>No</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request body</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>device_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: [string]}</code></td>
  <td>
    <strong>Required: </strong>The keys to be downloaded. A map from user ID, to a list of
device IDs, or to an empty list to indicate all devices for the
corresponding user.  Requested users must be local to the
receiving homeserver.</td>
 </tr>
</table>
<h3>Request body example</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The device information.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>device_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: <a href="#post_matrixfederationv1userkeysquery_response-200_devicekeys">DeviceKeys</a>}}</code></td>
  <td>
    <strong>Required: </strong>Information on the queried devices. A map from user ID, to a
map from device ID to device information.  For each device,
the information returned will be the same as uploaded via
<code>/keys/upload</code>, with the addition of an <code>unsigned</code>
property.</td>
 </tr>
 <tr>
  <td><code>master_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: <a href="#post_matrixfederationv1userkeysquery_response-200_crosssigningkey">CrossSigningKey</a>}</code></td>
  <td>
    Information on the master cross-signing keys of the queried users.
A map from user ID, to master key information.  For each key, the
information returned will be the same as uploaded via
<code>/keys/device_signing/upload</code>, along with the signatures
uploaded via <code>/keys/signatures/upload</code> that the user is
allowed to see.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>self_signing_keys</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: <a href="#post_matrixfederationv1userkeysquery_response-200_crosssigningkey">CrossSigningKey</a>}</code></td>
  <td>
    Information on the self-signing keys of the queried users. A map
from user ID, to self-signing key information.  For each key, the
information returned will be the same as uploaded via
<code>/keys/device_signing/upload</code>.
<p><strong>Added in <code>v1.1</code></strong></p>
</td>
 </tr>
</table>
<table id="post_matrixfederationv1userkeysquery_response-200_devicekeys" class="object-table">
 <caption>DeviceKeys</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>algorithms</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>The encryption algorithms supported by this device.</td>
 </tr>
 <tr>
  <td><code>device_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the device these keys belong to. Must match the device ID used
when logging in.</td>
 </tr>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>Public identity keys. The names of the properties should be in the
format <code>&lt;algorithm&gt;:&lt;device_id&gt;</code>. The keys themselves should be
encoded as specified by the key algorithm.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: string}}</code></td>
  <td>
    <strong>Required: </strong><p>Signatures for the device key object. A map from user ID, to a map from
<code>&lt;algorithm&gt;:&lt;device_id&gt;</code> to the signature.</p>
<p>The signature is calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.</p>
</td>
 </tr>
 <tr>
  <td><code>unsigned</code></td>
  <td><code><a href="#post_matrixfederationv1userkeysquery_response-200_unsigneddeviceinfo">UnsignedDeviceInfo</a></code></td>
  <td>
    Additional data added to the device key information
by intermediate servers, and not covered by the
signatures.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the device belongs to. Must match the user ID used
when logging in.</td>
 </tr>
</table>
<table id="post_matrixfederationv1userkeysquery_response-200_unsigneddeviceinfo" class="object-table">
 <caption>UnsignedDeviceInfo</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>device_display_name</code></td>
  <td><code>string</code></td>
  <td>
    The display name which the user set on the device.</td>
 </tr>
</table>
<table id="post_matrixfederationv1userkeysquery_response-200_crosssigningkey" class="object-table">
 <caption>CrossSigningKey</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>The public key.  The object must have exactly one property, whose name is
in the form <code>&lt;algorithm&gt;:&lt;unpadded_base64_public_key&gt;</code>, and whose value
is the unpadded base64 public key.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    Signatures of the key, calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.
Optional for the master key. Other keys must be signed by the
user's master key.</td>
 </tr>
 <tr>
  <td><code>usage</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>What the key is used for.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the key belongs to.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;device_keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;algorithms&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.olm.v1.curve25519-aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;device_id&#34;</span><span class="p">:</span> <span class="s2">&#34;JLAFKJWSCS&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;curve25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;3C5BFWi2Y8MaVvjM8M22DBmh24PmgR0nPvJOIArzgyI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;lEuiRJBit0IG6nUf5pUzWTUEsRVVe/HJkoKuEww9ULI&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;ed25519:JLAFKJWSCS&#34;</span><span class="p">:</span> <span class="s2">&#34;dSO80A01XiigH3uBiDVx/EjzaoycHcjq9lfQX0uWsqxl2giMIiSPR8a4d291W1ihKJL/a+myXS367WT6NAIcBA&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;unsigned&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;device_display_name&#34;</span><span class="p">:</span> <span class="s2">&#34;Alice&#39;s mobile phone&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data definition" id="definition-msigning_key_update">
<details open>
<summary>
<h1>
 <code>m.signing_key_update</code>
</h1>
</summary>
<hr/>
<p><strong>Added in <code>v1.1</code></strong></p>
<p>An EDU that lets servers push details to each other when one of their users
updates their cross-signing keys.</p>
<table id="definition-msigning_key_update_msigning_key_update" class="object-table">
 <caption>m.signing_key_update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#definition-msigning_key_update_signing-key-update">Signing Key Update</a></code></td>
  <td>
    <strong>Required: </strong>The updated signing keys.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.signing_update</code>.<p>One of: <code>[m.signing_key_update]</code>.</p></td>
 </tr>
</table>
<table id="definition-msigning_key_update_signing-key-update" class="object-table">
 <caption>Signing Key Update</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>master_key</code></td>
  <td><code><a href="#definition-msigning_key_update_crosssigningkey">CrossSigningKey</a></code></td>
  <td>
    Cross signing key</td>
 </tr>
 <tr>
  <td><code>self_signing_key</code></td>
  <td><code><a href="#definition-msigning_key_update_crosssigningkey">CrossSigningKey</a></code></td>
  <td>
    Cross signing key</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The user ID whose cross-signing keys have changed.</td>
 </tr>
</table>
<table id="definition-msigning_key_update_crosssigningkey" class="object-table">
 <caption>CrossSigningKey</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>keys</code></td>
  <td><code>{string: string}</code></td>
  <td>
    <strong>Required: </strong>The public key.  The object must have exactly one property, whose name is
in the form <code>&lt;algorithm&gt;:&lt;unpadded_base64_public_key&gt;</code>, and whose value
is the unpadded base64 public key.</td>
 </tr>
 <tr>
  <td><code>signatures</code></td>
  <td><code>Signatures</code></td>
  <td>
    Signatures of the key, calculated using the process described at <a href="/v1.11/appendices/#signing-json">Signing JSON</a>.
Optional for the master key. Other keys must be signed by the
user's master key.</td>
 </tr>
 <tr>
  <td><code>usage</code></td>
  <td><code>[string]</code></td>
  <td>
    <strong>Required: </strong>What the key is used for.</td>
 </tr>
 <tr>
  <td><code>user_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The ID of the user the key belongs to.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;master_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;master&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;self_signing_key&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;keys&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ed25519:base64+self+signing+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;base64+self+signing+master+public+key&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signatures&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;@alice:example.com&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;ed25519:base64+master+public+key&#34;</span><span class="p">:</span> <span class="s2">&#34;signature+of+self+signing+key&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;usage&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;self_signing&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;user_id&#34;</span><span class="p">:</span> <span class="s2">&#34;@alice:example.com&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.signing_key_update&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="send-to-device-messaging">Send-to-device messaging</h2>
<p>The server API for send-to-device messaging is based on the
<code>m.direct_to_device</code> EDU. There are no PDUs or Federation Queries
involved.</p>
<p>Each send-to-device message should be sent to the destination server
using the following EDU:</p>
<section class="rendered-data definition" id="definition-mdirect_to_device">
<details open>
<summary>
<h1>
 <code>m.direct_to_device</code>
</h1>
</summary>
<hr/>
<p>An EDU that lets servers push send events directly to a specific device on
a remote server - for instance, to maintain an Olm E2E encrypted message channel
between a local and remote device.</p>
<table id="definition-mdirect_to_device_mdirect_to_device" class="object-table">
 <caption>m.direct_to_device</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>content</code></td>
  <td><code><a href="#definition-mdirect_to_device_to-device-message">To Device Message</a></code></td>
  <td>
    <strong>Required: </strong>The description of the direct-to-device message.</td>
 </tr>
 <tr>
  <td><code>edu_type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The string <code>m.direct_to_device</code>.<p>One of: <code>[m.direct_to_device]</code>.</p></td>
 </tr>
</table>
<table id="definition-mdirect_to_device_to-device-message" class="object-table">
 <caption>To Device Message</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>message_id</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Unique ID for the message, used for idempotence.  Arbitrary utf8 string, of maximum length 32 codepoints.</td>
 </tr>
 <tr>
  <td><code>messages</code></td>
  <td><code>{<a href="/v1.11/appendices#user-identifiers">User ID</a>: {string: Device Message Contents}}</code></td>
  <td>
    <strong>Required: </strong>The contents of the messages to be sent.  These are arranged in
a map of user IDs to a map of device IDs to message bodies.
The device ID may also be <code>*</code>, meaning all known devices for the user.</td>
 </tr>
 <tr>
  <td><code>sender</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>User ID of the sender.</td>
 </tr>
 <tr>
  <td><code>type</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>Event type for the message.</td>
 </tr>
</table>
<h2>Examples</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;message_id&#34;</span><span class="p">:</span> <span class="s2">&#34;hiezohf6Hoo7kaev&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;messages&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;@alice:example.org&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;IWHQUZUIAH&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;algorithm&#34;</span><span class="p">:</span> <span class="s2">&#34;m.megolm.v1.aes-sha2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;room_id&#34;</span><span class="p">:</span> <span class="s2">&#34;!Cuyf34gef24t:localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;session_id&#34;</span><span class="p">:</span> <span class="s2">&#34;X3lUlvLELLYxeTx4yOVu6UDpasGEVO0Jbu+QFnm0cKQ&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;session_key&#34;</span><span class="p">:</span> <span class="s2">&#34;AgAAAADxKHa9uFxcXzwYoNueL5Xqi69IkD4sni8LlfJL7qNBEY...&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;sender&#34;</span><span class="p">:</span> <span class="s2">&#34;@john:example.com&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.room_key_request&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;edu_type&#34;</span><span class="p">:</span> <span class="s2">&#34;m.direct_to_device&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="content-repository">Content Repository</h2>
<p>Attachments to events (images, files, etc) are uploaded to a homeserver
via the Content Repository described in the <a href="/v1.11/client-server-api/#content-repository">Client-Server
API</a>. When a server wishes
to serve content originating from a remote server, it needs to ask the
remote server for the media.</p>
<p>Servers MUST use the server described in the <a href="/v1.11/client-server-api/#matrix-content-mxc-uris">Matrix Content URI</a>.
Formatted as <code>mxc://{ServerName}/{MediaID}</code>, servers MUST download the media from
<code>ServerName</code> using the below endpoints.</p>
<div class="alert added-in-paragraph " role="alert">
<span><strong>[Changed in <code>v1.11</code>]</strong></span> Servers were previously advised to use the <code>/_matrix/media/*</code>
endpoints described by the <a href="/v1.11/client-server-api/#content-repository">Content Repository module in the Client-Server API</a>,
however, those endpoints have been deprecated. New endpoints are introduced which
require authentication. Naturally, as a server is not a user, they cannot provide
the required access token to those endpoints. Instead, servers MUST try the endpoints
described below before falling back to the deprecated <code>/_matrix/media/*</code> endpoints
when they receive a <code>404 M_UNRECOGNIZED</code> error. When falling back, servers MUST
be sure to set <code>allow_remote</code> to <code>false</code>.
</div>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1mediadownloadmediaid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/media/download/{mediaId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.11</code></strong></p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI (the path component).</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>timeout_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of milliseconds that the client is willing to wait to
start receiving data, in the case that the content has not yet been
uploaded. The default value is 20000 (20 seconds). The content
repository SHOULD impose a maximum value for this parameter. The
content repository MAY respond before the timeout.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>The content that was previously uploaded.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
 <tr>
  <td><code>502</code></td>
  <td>The content is too large for the server to serve.</td>
 </tr>
 <tr>
  <td><code>504</code></td>
  <td>The content is not yet available. A <a href="/v1.11/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_NOT_YET_UPLOADED</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <caption>Headers</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>Content-Type</code></td>
  <td><code>string</code></td>
  <td>
    Must be <code>multipart/mixed</code>.</td>
 </tr>
</table>
<table class="content-type-table">
 <thead>
  <tr>
    <th class="col-name">Content-Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>multipart/mixed</code></td>
  <td>
   <p><strong>Required.</strong> MUST contain a <code>boundary</code> (per <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1">RFC 2046</a>)
delineating exactly two parts:</p>
<p>The first part has a <code>Content-Type</code> header of <code>application/json</code>
and describes the media&rsquo;s metadata, if any. Currently, this will
always be an empty object.</p>
<p>The second part is either:</p>
<ol>
<li>
<p>the bytes of the media itself, using <code>Content-Type</code> and
<code>Content-Disposition</code> headers as appropriate;</p>
</li>
<li>
<p>or a <code>Location</code> header to redirect the caller to where the media
can be retrieved. The URL at <code>Location</code> SHOULD have appropriate
<code>Content-Type</code> and <code>Content-Disposition</code> headers which describe
the media.</p>
<p>When <code>Location</code> is present, servers SHOULD NOT cache the URL.
The remote server may have applied time limits on its validity.
If the caller requires an up-to-date URL, it SHOULD re-request
the media download.</p>
</li>
</ol>
</td>
 </tr>
</table>
<h3>429 response</h3>
<table id="get_matrixfederationv1mediadownloadmediaid_response-429_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>502 response</h3>
<table id="get_matrixfederationv1mediadownloadmediaid_response-502_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to serve&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>504 response</h3>
<table id="get_matrixfederationv1mediadownloadmediaid_response-504_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_YET_UPLOADED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content has not yet been uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<section class="rendered-data http-api GET">
<details open>
<summary>
  <h1 id="get_matrixfederationv1mediathumbnailmediaid">
   <span class="http-api-method GET">GET</span>
   <span class="endpoint">/_matrix/federation/v1/media/thumbnail/{mediaId}</span>
  </h1>
</summary>
  <hr/>
<p><strong>Added in <code>v1.11</code></strong></p>
<p>Download a thumbnail of content from the content repository.
See the <a href="/v1.11/client-server-api/#thumbnails">Client-Server API Thumbnails</a>
section for more information.</p>
<table class="basic-info">
  <tr>
   <th>Rate-limited:</th>
   <td>Yes</td>
  </tr>
 <tr>
  <th>Requires authentication:</th>
  <td>Yes</td>
 </tr>
</table>
<hr/>
<h2>Request</h2>
<h3>Request parameters</h3>
<table class="object-table">
 <caption>path parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>mediaId</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The media ID from the <code>mxc://</code> URI (the path component).</td>
 </tr>
</table>
<table class="object-table">
 <caption>query parameters</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>animated</code></td>
  <td><code>boolean</code></td>
  <td>
    <p>Indicates preference for an animated thumbnail from the server, if possible. Animated
thumbnails typically use the content types <code>image/gif</code>, <code>image/png</code> (with APNG format),
<code>image/apng</code>, and <code>image/webp</code> instead of the common static <code>image/png</code> or <code>image/jpeg</code>
content types.</p>
<p>When <code>true</code>, the server SHOULD return an animated thumbnail if possible and supported.
When <code>false</code>, the server MUST NOT return an animated thumbnail. For example, returning a
static <code>image/png</code> or <code>image/jpeg</code> thumbnail. When not provided, the server SHOULD NOT
return an animated thumbnail.</p>
<p>Servers SHOULD prefer to return <code>image/webp</code> thumbnails when supporting animation.</p>
<p>When <code>true</code> and the media cannot be animated, such as in the case of a JPEG or PDF, the
server SHOULD behave as though <code>animated</code> is <code>false</code>.</p>
<p><strong>Added in <code>v1.11</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>height</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <em>desired</em> height of the thumbnail. The actual thumbnail may be
larger than the size specified.</td>
 </tr>
 <tr>
  <td><code>method</code></td>
  <td><code>string</code></td>
  <td>
    The desired resizing method. See the <a href="/v1.11/client-server-api/#thumbnails">Client-Server API Thumbnails</a>
section for more information.<p>One of: <code>[crop, scale]</code>.</p></td>
 </tr>
 <tr>
  <td><code>timeout_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The maximum number of milliseconds that the client is willing to wait to
start receiving data, in the case that the content has not yet been
uploaded. The default value is 20000 (20 seconds). The content
repository SHOULD impose a maximum value for this parameter. The
content repository MAY respond before the timeout.
<p><strong>Added in <code>v1.7</code></strong></p>
</td>
 </tr>
 <tr>
  <td><code>width</code></td>
  <td><code>integer</code></td>
  <td>
    <strong>Required: </strong>The <em>desired</em> width of the thumbnail. The actual thumbnail may be
larger than the size specified.</td>
 </tr>
</table>
<hr/>
<h2>Responses</h2>
<table class="response-table">
 <thead>
  <tr>
    <th class="col-status">Status</th>
    <th class="col-status-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>200</code></td>
  <td>A thumbnail of the requested content.</td>
 </tr>
 <tr>
  <td><code>400</code></td>
  <td>The request does not make sense to the server, or the server cannot thumbnail
the content. For example, the caller requested non-integer dimensions or asked
for negatively-sized images.</td>
 </tr>
 <tr>
  <td><code>413</code></td>
  <td>The local content is too large for the server to thumbnail.</td>
 </tr>
 <tr>
  <td><code>429</code></td>
  <td>This request was rate-limited.</td>
 </tr>
 <tr>
  <td><code>502</code></td>
  <td>The remote content is too large for the server to thumbnail.</td>
 </tr>
 <tr>
  <td><code>504</code></td>
  <td>The content is not yet available. A <a href="/v1.11/client-server-api/#standard-error-response">standard error response</a>
will be returned with the <code>errcode</code> <code>M_NOT_YET_UPLOADED</code>.</td>
 </tr>
</table>
<h3>200 response</h3>
<table class="object-table">
 <caption>Headers</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>Content-Type</code></td>
  <td><code>string</code></td>
  <td>
    Must be <code>multipart/mixed</code>.</td>
 </tr>
</table>
<table class="content-type-table">
 <thead>
  <tr>
    <th class="col-name">Content-Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>multipart/mixed</code></td>
  <td>
   <p><strong>Required.</strong> MUST contain a <code>boundary</code> (per <a href="https://datatracker.ietf.org/doc/html/rfc2046#section-5.1">RFC 2046</a>)
delineating exactly two parts:</p>
<p>The first part has a <code>Content-Type</code> header of <code>application/json</code>
and describes the media&rsquo;s metadata, if any. Currently, this will
always be an empty object.</p>
<p>The second part is either:</p>
<ol>
<li>
<p>the bytes of the media itself, using <code>Content-Type</code> and
<code>Content-Disposition</code> headers as appropriate;</p>
</li>
<li>
<p>or a <code>Location</code> header to redirect the caller to where the media
can be retrieved. The URL at <code>Location</code> SHOULD have appropriate
<code>Content-Type</code> and <code>Content-Disposition</code> headers which describe
the media.</p>
<p>When <code>Location</code> is present, servers SHOULD NOT cache the URL.
The remote server may have applied time limits on its validity.
If the caller requires an up-to-date URL, it SHOULD re-request
the media download.</p>
</li>
</ol>
<div class="alert note " role="alert">
<p>The <code>Content-Type</code> for the second part SHOULD be one of:</p>
<ul>
<li><code>image/png</code> (possibly of the APNG variety)</li>
<li><code>image/apng</code></li>
<li><code>image/jpeg</code></li>
<li><code>image/gif</code></li>
<li><code>image/webp</code></li>
</ul>
</div>
</td>
 </tr>
</table>
<h3>400 response</h3>
<table id="get_matrixfederationv1mediathumbnailmediaid_response-400_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_UNKNOWN&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Cannot generate thumbnails for the requested content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>413 response</h3>
<table id="get_matrixfederationv1mediathumbnailmediaid_response-413_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to thumbnail&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>429 response</h3>
<table id="get_matrixfederationv1mediathumbnailmediaid_response-429_ratelimiterror" class="object-table">
 <caption>RateLimitError</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>The M_LIMIT_EXCEEDED error code</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
 <tr>
  <td><code>retry_after_ms</code></td>
  <td><code>integer</code></td>
  <td>
    The amount of time in milliseconds the client should wait
before trying the request again.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_LIMIT_EXCEEDED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Too many requests&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;retry_after_ms&#34;</span><span class="p">:</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>502 response</h3>
<table id="get_matrixfederationv1mediathumbnailmediaid_response-502_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_TOO_LARGE&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content is too large to thumbnail&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3>504 response</h3>
<table id="get_matrixfederationv1mediathumbnailmediaid_response-504_error" class="object-table">
 <caption>Error</caption>
 <thead>
  <tr>
    <th class="col-name">Name</th>
    <th class="col-type">Type</th>
    <th class="col-description">Description</th>
  </tr>
 </thead>
 <tr>
  <td><code>errcode</code></td>
  <td><code>string</code></td>
  <td>
    <strong>Required: </strong>An error code.</td>
 </tr>
 <tr>
  <td><code>error</code></td>
  <td><code>string</code></td>
  <td>
    A human-readable error message.</td>
 </tr>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;errcode&#34;</span><span class="p">:</span> <span class="s2">&#34;M_NOT_YET_UPLOADED&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;error&#34;</span><span class="p">:</span> <span class="s2">&#34;Content has not yet been uploaded&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div></details>
</section>
<h2 id="server-access-control-lists-acls">Server Access Control Lists (ACLs)</h2>
<p>Server ACLs and their purpose are described in the <a href="/v1.11/client-server-api/#server-access-control-lists-acls-for-rooms">Server
ACLs</a>
section of the Client-Server API.</p>
<p>When a remote server makes a request, it MUST be verified to be allowed
by the server ACLs. If the server is denied access to a room, the
receiving server MUST reply with a 403 HTTP status code and an <code>errcode</code>
of <code>M_FORBIDDEN</code>.</p>
<p>The following endpoint prefixes MUST be protected:</p>
<ul>
<li><code>/_matrix/federation/v1/send</code> (on a per-PDU basis)</li>
<li><code>/_matrix/federation/v1/make_join</code></li>
<li><code>/_matrix/federation/v1/make_leave</code></li>
<li><code>/_matrix/federation/v1/send_join</code></li>
<li><code>/_matrix/federation/v2/send_join</code></li>
<li><code>/_matrix/federation/v1/send_leave</code></li>
<li><code>/_matrix/federation/v2/send_leave</code></li>
<li><code>/_matrix/federation/v1/invite</code></li>
<li><code>/_matrix/federation/v2/invite</code></li>
<li><code>/_matrix/federation/v1/make_knock</code></li>
<li><code>/_matrix/federation/v1/send_knock</code></li>
<li><code>/_matrix/federation/v1/state</code></li>
<li><code>/_matrix/federation/v1/state_ids</code></li>
<li><code>/_matrix/federation/v1/backfill</code></li>
<li><code>/_matrix/federation/v1/event_auth</code></li>
<li><code>/_matrix/federation/v1/get_missing_events</code></li>
</ul>
<h2 id="signing-events">Signing Events</h2>
<p>Signing events is complicated by the fact that servers can choose to
redact non-essential parts of an event.</p>
<h3 id="adding-hashes-and-signatures-to-outgoing-events">Adding hashes and signatures to outgoing events</h3>
<p>Before signing the event, the <em>content hash</em> of the event is calculated
as described below. The hash is encoded using <a href="/v1.11/appendices/#unpadded-base64">Unpadded
Base64</a> and stored in the event
object, in a <code>hashes</code> object, under a <code>sha256</code> key.</p>
<p>The event object is then <em>redacted</em>, following the <a href="/v1.11/client-server-api/#redactions">redaction
algorithm</a>.
Finally it is signed as described in <a href="/v1.11/appendices/#signing-json">Signing
JSON</a>, using the server&rsquo;s signing key
(see also <a href="/v1.11/server-server-api/#retrieving-server-keys">Retrieving server keys</a>).</p>
<p>The signature is then copied back to the original event object.</p>
<p>For an example of a signed event, see the <a href="/v1.11/rooms/">room version
specification</a>.</p>
<h3 id="validating-hashes-and-signatures-on-received-events">Validating hashes and signatures on received events</h3>
<p>When a server receives an event over federation from another server, the
receiving server should check the hashes and signatures on that event.</p>
<p>First the signature is checked. The event is redacted following the
<a href="/v1.11/client-server-api/#redactions">redaction
algorithm</a>, and
the resultant object is checked for a signature from the originating
server, following the algorithm described in <a href="/v1.11/appendices/#checking-for-a-signature">Checking for a
signature</a>. Note that this
step should succeed whether we have been sent the full event or a
redacted copy.</p>
<p>The signatures expected on an event are:</p>
<ul>
<li>The <code>sender</code>&rsquo;s server, unless the invite was created as a result of
3rd party invite. The sender must already match the 3rd party
invite, and the server which actually sends the event may be a
different server.</li>
<li>For room versions 1 and 2, the server which created the <code>event_id</code>.
Other room versions do not track the <code>event_id</code> over federation and
therefore do not need a signature from those servers.</li>
</ul>
<p>If the signature is found to be valid, the expected content hash is
calculated as described below. The content hash in the <code>hashes</code> property
of the received event is base64-decoded, and the two are compared for
equality.</p>
<p>If the hash check fails, then it is assumed that this is because we have
only been given a redacted version of the event. To enforce this, the
receiving server should use the redacted copy it calculated rather than
the full copy it received.</p>
<h3 id="calculating-the-reference-hash-for-an-event">Calculating the reference hash for an event</h3>
<p>The <em>reference hash</em> of an event covers the essential fields of an
event, including content hashes. It is used for event identifiers in
some room versions. See the <a href="/v1.11/rooms/">room version
specification</a> for more information. It is
calculated as follows.</p>
<ol>
<li>The event is put through the redaction algorithm.</li>
<li>The <code>signatures</code> and <code>unsigned</code> properties are removed
from the event, if present.</li>
<li>The event is converted into <a href="/v1.11/appendices/#canonical-json">Canonical
JSON</a>.</li>
<li>A sha256 hash is calculated on the resulting JSON object.</li>
</ol>
<h3 id="calculating-the-content-hash-for-an-event">Calculating the content hash for an event</h3>
<p>The <em>content hash</em> of an event covers the complete event including the
<em>unredacted</em> contents. It is calculated as follows.</p>
<p>First, any existing <code>unsigned</code>, <code>signature</code>, and <code>hashes</code> members are
removed. The resulting object is then encoded as <a href="/v1.11/appendices/#canonical-json">Canonical
JSON</a>, and the JSON is hashed using
SHA-256.</p>
<h3 id="example-code">Example code</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hash_and_sign_event</span><span class="p">(</span><span class="n">event_object</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">,</span> <span class="n">signing_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># First we need to hash the event object.</span>
</span></span><span class="line"><span class="cl">    <span class="n">content_hash</span> <span class="o">=</span> <span class="n">compute_content_hash</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span><span class="p">[</span><span class="s2">&#34;hashes&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;sha256&#34;</span><span class="p">:</span> <span class="n">encode_unpadded_base64</span><span class="p">(</span><span class="n">content_hash</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Strip all the keys that would be removed if the event was redacted.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># The hashes are not stripped and cover all the keys in the event.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This means that we can tell if any of the non-essential keys are</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># modified or removed.</span>
</span></span><span class="line"><span class="cl">    <span class="n">stripped_object</span> <span class="o">=</span> <span class="n">strip_non_essential_keys</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Sign the stripped JSON object. The signature only covers the</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># essential keys and the hashes. This means that we can check the</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># signature even if the event is redacted.</span>
</span></span><span class="line"><span class="cl">    <span class="n">signed_object</span> <span class="o">=</span> <span class="n">sign_json</span><span class="p">(</span><span class="n">stripped_object</span><span class="p">,</span> <span class="n">signing_key</span><span class="p">,</span> <span class="n">signing_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Copy the signatures from the stripped event to the original event.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span><span class="p">[</span><span class="s2">&#34;signatures&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">signed_object</span><span class="p">[</span><span class="s2">&#34;signatures&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_content_hash</span><span class="p">(</span><span class="n">event_object</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># take a copy of the event before we remove any keys.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Keys under &#34;unsigned&#34; can be modified by other servers.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># They are useful for conveying information like the age of an</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># event that will change in transit.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Since they can be modified we need to exclude them from the hash.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&#34;unsigned&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Signatures will depend on the current value of the &#34;hashes&#34; key.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># We cannot add new hashes without invalidating existing signatures.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&#34;signatures&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># The &#34;hashes&#34; key might contain multiple algorithms if we decide to</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># migrate away from SHA-2. We don&#39;t want to include an existing hash</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># output in our hash so we exclude the &#34;hashes&#34; dict from the hash.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_object</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&#34;hashes&#34;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Encode the JSON using a canonical encoding so that we get the same</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># bytes on every server for the same JSON object.</span>
</span></span><span class="line"><span class="cl">    <span class="n">event_json_bytes</span> <span class="o">=</span> <span class="n">encode_canonical_json</span><span class="p">(</span><span class="n">event_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">(</span><span class="n">event_json_bytes</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="security-considerations">Security considerations</h2>
<p>When a domain&rsquo;s ownership changes, the new controller of the domain can
masquerade as the previous owner, receiving messages (similarly to
email) and request past messages from other servers. In the future,
proposals like
<a href="https://github.com/matrix-org/matrix-spec-proposals/issues/1228">MSC1228</a> will
address this issue.</p>

</div>


          </main>
        </div>
      </div>



<footer class="py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-12 text-center text-xs-center order-sm-3">



<ul class="list-inline mb-0">

  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://github.com/matrix-org">
      <i class="fab fa-github"></i>
    </a>
  </li>

  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitLab" aria-label="GitLab">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://gitlab.matrix.org/matrix-org">
      <i class="fab fa-gitlab"></i>
    </a>
  </li>

  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="YouTube" aria-label="YouTube">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://www.youtube.com/channel/UCVFkW-chclhuyYRbmmfwt6w">
      <i class="fab fa-youtube"></i>
    </a>
  </li>

  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-dark" target="_blank" rel="noopener noreferrer" href="https://twitter.com/matrixdotorg">
      <i class="fab fa-twitter"></i>
    </a>
  </li>

</ul>



      </div>
    </div>
    <div class="row">
      <div class="col-12 text-center py-2 order-sm-3">
        <small>&copy; 2024 The Matrix.org Foundation CIC</small>



      </div>
    </div>
  </div>
</footer>


    </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="/v1.11/js/main.min.cf0c36be391ce0effb817cf7be486bef77b4a6de8211fd5474290a2297872cde.js" integrity="sha256-zww2vjkc4O/7gXz3vkhr73e0pt6CEf1UdCkKIpeHLN4=" crossorigin="anonymous"></script>
<script defer src="/v1.11/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js" integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin="anonymous"></script>
<script src='/v1.11/js/tabpane-persist.js'></script>


<script defer language="javascript" type="text/javascript"  src="/v1.11/js/toc.js"></script>

  </body>
</html>
