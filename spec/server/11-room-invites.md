# Room Invitation Federation

This document covers the federation aspects of Matrix room invitations, including both direct invites and third-party identifier invites.

## Overview

When a user on a given homeserver invites another user on the same homeserver, the homeserver may sign the membership event itself and skip the federation process. However, when a user invites another user on a different homeserver, a request to that homeserver to have the event signed and verified must be made.

Note that invites are used to indicate that knocks were accepted. As such, receiving servers should be prepared to manually link up a previous knock to an invite if the invite event does not directly reference the knock.

## PUT /_matrix/federation/v1/invite/{roomId}/{eventId}

Invites a remote user to a room. Once the event has been signed by both the inviting homeserver and the invited homeserver, it can be sent to all of the servers in the room by the inviting homeserver.

Servers should prefer to use the v2 API for invites instead of the v1 API. Servers which receive a v1 invite request must assume that the room version is either "1" or "2".

Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. **The request and response bodies here describe the common event fields in more detail and may be missing other required fields for a PDU.**

Also note that if the remote homeserver is already in the room, it will receive the invite event twice; once through this endpoint, and again through a [federation transaction](https://spec.matrix.org/unstable/server-server-api/#transactions).

### Request Parameters

| Name | Type | Description |
| --- | --- | --- |
| `eventId` | `string` | **Required:** The event ID for the invite event, generated by the inviting server. |
| `roomId` | `string` | **Required:** The room ID that the user is being invited to. |

### Authentication

- **Rate-limited:** No
- **Requires authentication:** Yes

### Request Body

| Name | Type | Description |
| --- | --- | --- |
| `content` | `Membership Event Content` | **Required:** The content of the event, matching what is available in the [Client-Server API](https://spec.matrix.org/unstable/client-server-api/). Must include a `membership` of `invite`. |
| `origin` | `string` | **Required:** The name of the inviting homeserver. |
| `origin_server_ts` | `integer` | **Required:** A timestamp added by the inviting homeserver. |
| `sender` | `string` | **Required:** The matrix ID of the user who sent the original `m.room.third_party_invite`. |
| `state_key` | `string` | **Required:** The user ID of the invited member. |
| `type` | `string` | **Required:** The value `m.room.member`. |
| `unsigned` | `UnsignedData` | Information included alongside the event that is not signed. May include more than what is listed here. |

#### Membership Event Content

| Name | Type | Description |
| --- | --- | --- |
| `membership` | `string` | **Required:** The value `invite`. |

#### UnsignedData

| Name | Type | Description |
| --- | --- | --- |
| `invite_room_state` | `[StrippedStateEvent]` | An optional list of [stripped state events](https://spec.matrix.org/unstable/client-server-api/#stripped-state) to help the receiver of the invite identify the room. |

#### StrippedStateEvent

| Name | Type | Description |
| --- | --- | --- |
| `content` | `EventContent` | **Required:** The `content` for the event. |
| `sender` | `string` | **Required:** The `sender` for the event. |
| `state_key` | `string` | **Required:** The `state_key` for the event. |
| `type` | `string` | **Required:** The `type` for the event. |

#### Request Body Example

```json
{
  "content": {
    "membership": "invite"
  },
  "origin": "matrix.org",
  "origin_server_ts": 1234567890,
  "sender": "@someone:example.org",
  "state_key": "@joe:elsewhere.com",
  "type": "m.room.member",
  "unsigned": {
    "invite_room_state": [
      {
        "content": {
          "name": "Example Room"
        },
        "sender": "@bob:example.org",
        "state_key": "",
        "type": "m.room.name"
      },
      {
        "content": {
          "join_rule": "invite"
        },
        "sender": "@bob:example.org",
        "state_key": "",
        "type": "m.room.join_rules"
      }
    ]
  }
}
```

### Response Codes

| Status | Description |
| --- | --- |
| `200` | The event with the invited server's signature added. All other fields of the events should remain untouched. Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. |
| `403` | The invite is not allowed. This could be for a number of reasons, including: - The sender is not allowed to send invites to the target user/homeserver. - The homeserver does not permit anyone to invite its users. - The homeserver refuses to participate in the room. |

#### 200 Response Format

Array of `integer, Event Container`.

| Name | Type | Description |
| --- | --- | --- |
| `event` | `InviteEvent` | **Required:** An invite event. Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. |

##### InviteEvent

| Name | Type | Description |
| --- | --- | --- |
| `content` | `Membership Event Content` | **Required:** The content of the event, matching what is available in the [Client-Server API](https://spec.matrix.org/unstable/client-server-api/). Must include a `membership` of `invite`. |
| `origin` | `string` | **Required:** The name of the inviting homeserver. |
| `origin_server_ts` | `integer` | **Required:** A timestamp added by the inviting homeserver. |
| `sender` | `string` | **Required:** The matrix ID of the user who sent the original `m.room.third_party_invite`. |
| `state_key` | `string` | **Required:** The user ID of the invited member. |
| `type` | `string` | **Required:** The value `m.room.member`. |

## PUT /_matrix/federation/v2/invite/{roomId}/{eventId}

> **Note:** This API is nearly identical to the v1 API with the exception of the request body being different, and the response format fixed.

Invites a remote user to a room. Once the event has been signed by both the inviting homeserver and the invited homeserver, it can be sent to all of the servers in the room by the inviting homeserver.

This endpoint is preferred over the v1 API as it is more useful for servers. Senders which receive a 400 or 404 response to this endpoint should retry using the v1 API as the server may be older, if the room version is "1" or "2".

Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. **The request and response bodies here describe the common event fields in more detail and may be missing other required fields for a PDU.**

Also note that if the remote homeserver is already in the room, it will receive the invite event twice; once through this endpoint, and again through a [federation transaction](https://spec.matrix.org/unstable/server-server-api/#transactions).

### Request Parameters

| Name | Type | Description |
| --- | --- | --- |
| `eventId` | `string` | **Required:** The event ID for the invite event, generated by the inviting server. |
| `roomId` | `string` | **Required:** The room ID that the user is being invited to. |

### Authentication

- **Rate-limited:** No
- **Requires authentication:** Yes

### Request Body

| Name | Type | Description |
| --- | --- | --- |
| `event` | `InviteEvent` | **Required:** An invite event. Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. |
| `invite_room_state` | `[StrippedStateEvent]` | An optional list of [stripped state events](https://spec.matrix.org/unstable/client-server-api/#stripped-state) to help the receiver of the invite identify the room. |
| `room_version` | `string` | **Required:** The version of the room where the user is being invited to. |

#### InviteEvent

| Name | Type | Description |
| --- | --- | --- |
| `content` | `Membership Event Content` | **Required:** The content of the event, matching what is available in the [Client-Server API](https://spec.matrix.org/unstable/client-server-api/). Must include a `membership` of `invite`. |
| `origin` | `string` | **Required:** The name of the inviting homeserver. |
| `origin_server_ts` | `integer` | **Required:** A timestamp added by the inviting homeserver. |
| `sender` | `string` | **Required:** The matrix ID of the user who sent the original `m.room.third_party_invite`. |
| `state_key` | `string` | **Required:** The user ID of the invited member. |
| `type` | `string` | **Required:** The value `m.room.member`. |

#### Request Body Example

```json
{
  "event": {
    "content": {
      "membership": "invite"
    },
    "origin": "matrix.org",
    "origin_server_ts": 1234567890,
    "sender": "@someone:example.org",
    "state_key": "@joe:elsewhere.com",
    "type": "m.room.member"
  },
  "invite_room_state": [
    {
      "content": {
        "name": "Example Room"
      },
      "sender": "@bob:example.org",
      "state_key": "",
      "type": "m.room.name"
    },
    {
      "content": {
        "join_rule": "invite"
      },
      "sender": "@bob:example.org",
      "state_key": "",
      "type": "m.room.join_rules"
    }
  ],
  "room_version": "2"
}
```

### Response Codes

| Status | Description |
| --- | --- |
| `200` | The event with the invited server's signature added. All other fields of the events should remain untouched. Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. |
| `400` | The request is invalid or the room the server is attempting to join has a version that is not listed in the `ver` parameters. The error should be passed through to clients so that they may give better feedback to users. |
| `403` | The invite is not allowed. This could be for a number of reasons, including: - The sender is not allowed to send invites to the target user/homeserver. - The homeserver does not permit anyone to invite its users. - The homeserver refuses to participate in the room. |

#### 200 Response Format

| Name | Type | Description |
| --- | --- | --- |
| `event` | `InviteEvent` | **Required:** An invite event. Note that events have a different format depending on the room version - check the [room version specification](https://spec.matrix.org/unstable/rooms/) for precise event formats. |

#### Example Response

```json
{
  "event": {
    "content": {
      "membership": "invite"
    },
    "origin": "example.org",
    "origin_server_ts": 1549041175876,
    "room_id": "!somewhere:example.org",
    "sender": "@someone:example.org",
    "signatures": {
      "elsewhere.com": {
        "ed25519:k3y_versi0n": "SomeOtherSignatureHere"
      },
      "example.com": {
        "ed25519:key_version": "SomeSignatureHere"
      }
    },
    "state_key": "@someone:example.org",
    "type": "m.room.member",
    "unsigned": {
      "invite_room_state": [
        {
          "content": {
            "name": "Example Room"
          },
          "sender": "@bob:example.org",
          "state_key": "",
          "type": "m.room.name"
        }
      ]
    }
  }
}
```

## Third-party Invites

When a user wants to invite another user in a room but doesn't know the Matrix ID to invite, they can do so using a third-party identifier (e.g. an e-mail or a phone number).

This identifier and its bindings to Matrix IDs are verified by an identity server implementing the [Identity Service API](https://spec.matrix.org/unstable/identity-service-api/).

### Cases where an association exists for a third-party identifier

If the third-party identifier is already bound to a Matrix ID, a [lookup request](https://spec.matrix.org/unstable/identity-service-api/#post_matrixidentityv2lookup) on the identity server will return it. The invite is then processed by the inviting homeserver as a [standard `m.room.member` invite event](https://spec.matrix.org/unstable/server-server-api/#inviting-to-a-room). This is the simplest case.

### Cases where an association doesn't exist for a third-party identifier

If the third-party identifier isn't bound to any Matrix ID, the inviting homeserver will request the identity server to [store an invite](https://spec.matrix.org/unstable/identity-service-api/#invitation-storage) for this identifier and to deliver it to whoever binds it to its Matrix ID. It will also send an [`m.room.third_party_invite`](https://spec.matrix.org/unstable/client-server-api/#mroomthird_party_invite) event in the room to specify a display name, a token and public keys the identity server provided as a response to the invite storage request.

When a third-party identifier with pending invites gets bound to a Matrix ID, the identity server will send a request to the [`/3pid/onbind`](https://spec.matrix.org/unstable/server-server-api/#put_matrixfederationv13pidonbind) endpoint of the the ID's homeserver as described in the [Invitation Storage](https://spec.matrix.org/unstable/identity-service-api/#invitation-storage) section of the Identity Service API.

The following process applies for each invite sent by the identity server:

The invited homeserver will create an [`m.room.member`](https://spec.matrix.org/unstable/client-server-api/#mroommember) invite event containing a special `third_party_invite` section containing the token and a `signed` object, both provided by the identity server.

If the invited homeserver is in the room the invite came from, it can auth the event and send it.

However, if the invited homeserver isn't in the room the invite came from, it will need to request the inviting homeserver to auth the event at the [`/exchange_third_party_invite`](https://spec.matrix.org/unstable/server-server-api/#put_matrixfederationv1exchange_third_party_inviteroomid) endpoint.

## PUT /_matrix/federation/v1/3pid/onbind

Used by identity servers to notify the homeserver that one of its users has bound a third-party identifier successfully, including any pending room invites the identity server has been made aware of.

### Authentication

- **Rate-limited:** No
- **Requires authentication:** No

### Request Body

| Name | Type | Description |
| --- | --- | --- |
| `address` | `string` | **Required:** The third-party identifier itself. For example, an email address. |
| `invites` | `[Third-party Invite]` | **Required:** A list of pending invites that the third-party identifier has received. |
| `medium` | `string` | **Required:** The type of third-party identifier. Currently only "email" is a possible value. |
| `mxid` | `User ID` | **Required:** The user that is now bound to the third-party identifier. |

#### Third-party Invite

| Name | Type | Description |
| --- | --- | --- |
| `address` | `string` | **Required:** The third-party identifier that received the invite. |
| `medium` | `string` | **Required:** The type of third-party invite issues. Currently only "email" is used. |
| `mxid` | `User ID` | **Required:** The now-bound user ID that received the invite. |
| `room_id` | `Room ID` | **Required:** The room ID the invite is valid for. |
| `sender` | `User ID` | **Required:** The user ID that sent the invite. |
| `signed` | `SignedThirdPartyInvite` | **Required:** A block of content which has been signed by the identity server, which homeservers can use to verify the event. Clients should ignore this. |

#### SignedThirdPartyInvite

| Name | Type | Description |
| --- | --- | --- |
| `mxid` | `User ID` | **Required:** The user ID that has been bound to the third-party identifier. |
| `signatures` | `{string: {string: string}}` | **Required:** The identity server signatures for this block. This is a map of identity server name to signing key identifier to base64-encoded signature. The signatures are calculated using the process described at [Signing JSON](https://spec.matrix.org/unstable/appendices/#signing-json). |
| `token` | `string` | **Required:** The token generated by the identity server at the [`/store_invite`](https://spec.matrix.org/unstable/identity-service-api/#post_matrixidentityv2store-invite) endpoint. It matches the `state_key` of the corresponding [`m.room.third_party_invite`](https://spec.matrix.org/unstable/client-server-api/#mroomthird_party_invite) event. |

#### Request Body Example

```json
{
  "address": "alice@example.com",
  "invites": [
    {
      "address": "alice@example.com",
      "medium": "email",
      "mxid": "@alice:matrix.org",
      "room_id": "!somewhere:example.org",
      "sender": "@bob:matrix.org",
      "signed": {
        "mxid": "@alice:example.org",
        "signatures": {
          "magic.forest": {
            "ed25519:3": "fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg"
          }
        },
        "token": "abc123"
      }
    }
  ],
  "medium": "email",
  "mxid": "@alice:matrix.org"
}
```

### Response

| Status | Description |
| --- | --- |
| `200` | The homeserver has processed the notification. |

#### 200 Response Format

```json
{}
```

## PUT /_matrix/federation/v1/exchange_third_party_invite/{roomId}

The receiving server will verify the partial `m.room.member` event given in the request body. If valid, the receiving server will issue an invite as per the [Inviting to a room](https://spec.matrix.org/unstable/server-server-api/#inviting-to-a-room) section before returning a response to this request.

### Request Parameters

| Name | Type | Description |
| --- | --- | --- |
| `roomId` | `Room ID` | **Required:** The room ID to exchange a third-party invite in |

### Authentication

- **Rate-limited:** No
- **Requires authentication:** Yes

### Request Body

| Name | Type | Description |
| --- | --- | --- |
| `content` | `Event Content` | **Required:** The event content |
| `room_id` | `string` | **Required:** The room ID the event is for. Must match the ID given in the path. |
| `sender` | `User ID` | **Required:** The user ID of the user who sent the original `m.room.third_party_invite` event. |
| `state_key` | `User ID` | **Required:** The user ID of the invited user |
| `type` | `string` | **Required:** The event type. Must be `m.room.member` |

#### Event Content

| Name | Type | Description |
| --- | --- | --- |
| `membership` | `string` | **Required:** The membership state. Must be `invite` |
| `third_party_invite` | `Third-party Invite` | **Required:** The third-party invite |

#### Third-party Invite

| Name | Type | Description |
| --- | --- | --- |
| `display_name` | `string` | **Required:** A name which can be displayed to represent the user instead of their third-party identifier. |
| `signed` | `SignedThirdPartyInvite` | **Required:** A block of content which has been signed by the identity server, which homeservers can use to verify the event. Clients should ignore this. |

#### Request Body Example

```json
{
  "content": {
    "membership": "invite",
    "third_party_invite": {
      "display_name": "alice",
      "signed": {
        "mxid": "@alice:localhost",
        "signatures": {
          "magic.forest": {
            "ed25519:3": "fQpGIW1Snz+pwLZu6sTy2aHy/DYWWTspTJRPyNp0PKkymfIsNffysMl6ObMMFdIJhk6g6pwlIqZ54rxo8SLmAg"
          }
        },
        "token": "abc123"
      }
    }
  },
  "room_id": "!abc123:matrix.org",
  "sender": "@joe:matrix.org",
  "state_key": "@someone:example.org",
  "type": "m.room.member"
}
```

### Response

| Status | Description |
| --- | --- |
| `200` | The invite has been issued successfully. |

#### 200 Response Format

```json
{}
```

### Verifying the invite

When a homeserver receives an `m.room.member` invite event for a room it's in with a `third_party_invite` object, it must verify that the association between the third-party identifier initially invited to the room and the Matrix ID that claims to be bound to it has been verified without having to rely on a third-party server.

To do so, it will fetch from the room's state events the `m.room.third_party_invite` event for which the state key matches with the value for the `token` key in the `third_party_invite` object from the `m.room.member` event's content to fetch the public keys initially delivered by the identity server that stored the invite.

It will then use these keys to verify that the `signed` object (in the `third_party_invite` object from the `m.room.member` event's content) was signed by the same identity server.

Since this `signed` object can only be delivered once in the POST request emitted by the identity server upon binding between the third-party identifier and the Matrix ID, and contains the invited user's Matrix ID and the token delivered when the invite was stored, this verification will prove that the `m.room.member` invite event comes from the user owning the invited third-party identifier.

## Invitation Processing Flow

### Direct Invitation Federation Sequence

1. **Initiate Invite**: The inviting server creates an unsigned invite event
2. **Send to Target Server**: The inviting server sends the invite via PUT `/invite` to the invited user's homeserver
3. **Signature Addition**: The invited user's homeserver validates and signs the invite event
4. **Return Signed Event**: The signed event is returned to the inviting server
5. **Event Distribution**: The inviting server distributes the signed invite to all servers in the room

### Third-party Invitation Sequence

1. **Identity Server Lookup**: Check if the third-party identifier is already bound to a Matrix ID
2. **Store Invite**: If unbound, request the identity server to store the invite
3. **Send m.room.third_party_invite**: Create and send the third-party invite event to the room
4. **Bind Notification**: Identity server notifies homeserver when binding occurs via `/3pid/onbind`
5. **Exchange Invite**: Use `/exchange_third_party_invite` to convert to a standard invite
6. **Verify Signature**: Validate the identity server signature on the binding

## Authorization Rules

### Invite Authorization

- **Power Levels**: The sender must have sufficient power level to invite users
- **Join Rules**: Room join rules must allow invites (invite-only or restricted rooms)
- **Membership State**: The target user must not already be in the room
- **Server Permissions**: The target server must accept invites from the sending server

### Third-party Authorization

- **Identity Server Verification**: All third-party invites must be verified by trusted identity servers
- **Token Validation**: Tokens must match between `m.room.third_party_invite` and binding events
- **Signature Verification**: Identity server signatures must be valid and from authorized servers
- **Binding Verification**: The binding between third-party identifier and Matrix ID must be valid

## Server Access Control List Protection

The following endpoints MUST be protected by Server ACLs when configured:

- `/_matrix/federation/v1/invite`
- `/_matrix/federation/v2/invite`

When a remote server makes a request, it MUST be verified to be allowed by the server ACLs. If the server is denied by the ACLs, the request should be rejected with an appropriate error response.

## Implementation Considerations

### Event Validation

Servers implementing room invitation federation must:

- Validate event structure according to room version specifications
- Verify cryptographic signatures on submitted events
- Check authorization rules before accepting invite events
- Maintain proper event ordering in the room DAG

### State Management

Invite events affect room state by:

- Adding the user's membership state as "invite"
- Updating the room's member list
- Potentially affecting power level calculations
- Providing room state context to invited users

### Performance Optimization

For optimal performance:

- Cache room state information for authorization checks
- Implement efficient signature verification
- Use appropriate timeouts for federation requests
- Handle network failures gracefully with retries

### Security Considerations

Important security aspects include:

- Validating sender permissions before processing invites
- Preventing invite spam through rate limiting
- Verifying identity server signatures for third-party invites
- Protecting against malicious identity servers

## Related Specifications

- [Room Version Specifications](https://spec.matrix.org/unstable/rooms/) - Event format requirements
- [Server-Server API Authentication](https://spec.matrix.org/unstable/server-server-api/#authentication) - Request signing
- [Authorization Rules](https://spec.matrix.org/unstable/server-server-api/#authorization-rules) - Event validation
- [Identity Service API](https://spec.matrix.org/unstable/identity-service-api/) - Third-party identifier management
- [Server Access Control Lists](https://spec.matrix.org/unstable/client-server-api/#server-access-control-lists-acls-for-rooms) - ACL enforcement